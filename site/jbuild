(* -*- tuareg -*- *)
open Jbuild_plugin.V1

let run_nondeterministic = match Sys.getenv "RUN_NONDETERMINISTIC" with
  | exception Not_found -> false
  | "Y" -> true
  | _ -> invalid_arg "RUN_NONDETERMINISTIC should be unset or set to Y"

let rule ~target ~deps ~action = 
  Printf.sprintf {|
(rule ((targets (%s)) 
       (deps (../app/app.exe %s)) 
       (action (system "../app/app.exe build %s -o . -repo-root ${ROOT}"))
       ))
|}
target deps action

let rule_for_one_file name =
  Printf.sprintf {|
(rule ((targets (%s)) 
       (deps (../app/app.exe (files_recursively_in ${ROOT}/book))) 
       (action (chdir ${ROOT} (system "app/app.exe build chapter %s-pygmentize -o site/ -repo-root ${ROOT} ${ROOT}/book/%s")))
       ))
|} name (if run_nondeterministic then "-run-nondeterministic " else "") name

let rsync = {|
(rule ((targets (.stamp)) 
       (action (progn 
                  (system "rsync -av ${ROOT}/book/images ${ROOT}/book/css ${ROOT}/book/js .")
                  (system "touch .stamp")))
       ))
|}

let all_html = "(files_recursively_in ${ROOT}/book)"
let send_rules s = String.concat "\n" s |> send

let input_lines f =
  let inc = open_in f in
  let rec read lines = 
    match input_line inc with
    | exception End_of_file -> List.rev lines
    | line -> read (line :: lines)
  in
  let lines = read [] in
  close_in inc;
  lines

let source_files = input_lines "../book/chapters.txt"
let alias rules = Printf.sprintf "(alias ((name book) (deps (%s))))" 
    (String.concat " " rules)
let all_targets = ["index.html"; "toc.html"; "faqs.html";"install.html"; ".stamp"] @ source_files 

let () = send_rules ([
  rule ~target:"index.html" ~deps:all_html ~action:"frontpage";
  rule ~target:"toc.html" ~deps:all_html ~action:"toc";
  rule ~target:"faqs.html" ~deps:"${ROOT}/book/faqs.html" ~action:"faqs";
  rule ~target:"install.html" ~deps:"${ROOT}/book/install.html" ~action:"install";
] @ (List.map rule_for_one_file source_files) @ [alias all_targets; rsync])
