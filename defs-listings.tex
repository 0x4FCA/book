%
% Generic environment for wrapping code blocks
%
\newenvironment{lstblock}{}{}

%
% OCaml listings.
%
\lstdefinestyle{ocaml}{%
    language=[Objective]Caml,
    basicstyle=\ttfamily,
    keywordstyle=\bfseries\ttfamily,
    breaklines=true,
    mathescape=true,
    alsoletter={'},
    columns=flexible,
    morekeywords={raise,initializer}}
\newcommand\ocamlenv{%
   \setstretch{1}    % Single spacing
   \lstset{%
        style=ocaml,
        showstringspaces=false,
        resetmargins=false,
        columns=[c]fixed,
        keepspaces=true}}
\newcommand\ocamlboxenv{%
    \ocamlenv
    \lstset{%
        boxpos=t,
        aboveskip=8pt,
        belowskip=8pt,
        xleftmargin=4em,
        escapechar=@}}
\newcommand\ocamlbox{%
    \footnotesize
    \ocamlboxenv}

%
% Define the default as OCaml, so we can use lstinline.
% This environment is used only for \hbox{\lstinline/.../},
% keywords should not be bold.
%
\lstset{%
    style=ocaml,
    showstringspaces=false,
    columns=[c]fixed,
    keepspaces=true,
    keywordstyle=\ttfamily}

%
% OLD STYLE: the text is not indented, and no margin
% This is still appropriate to use within lists.
%
\lstnewenvironment{ocamllisting}
   {%XHEVEA\setenvclass{lstlisting}{ocamllisting}
    \footnotesize
    \ocamlenv
    \lstset{%
        boxpos=t,
        aboveskip=0pt,
        belowskip=0pt}}
   {}

\lstnewenvironment{ocamllistinge}
   {%XHEVEA\setenvclass{lstlisting}{ocamllisting}
    %\footnotesize
    \ocamlenv
    \lstset{%
        boxpos=t,
        aboveskip=0pt,
        belowskip=0pt}}
   {}

\lstnewenvironment{ocamllistingx}
   {%XHEVEA\setenvclass{lstlisting}{ocamllisting}
    \footnotesize
    \ocamlenv
    \lstset{%
        boxpos=t,
        aboveskip=0pt,
        belowskip=0pt,
        escapechar=@}}
   {}

\lstnewenvironment{ocamllistingy}
   {%XHEVEA\setenvclass{lstlisting}{ocamllisting}
    \footnotesize
    \ocamlenv
    \lstset{%
        boxpos=t,
        aboveskip=0pt,
        belowskip=0pt,
        escapechar=@}}
   {}

%
% NEW STYLE: standalone text block.
% It is indented, with space before and after.
% Use @ to escape to normal LaTeX.
%
\lstnewenvironment{ocaml}
   {%XHEVEA\setenvclass{lstlisting}{ocamllisting}
    \ocamlbox}
   {}

\lstnewenvironment{ocamlnomath}
   {%XHEVEA\setenvclass{lstlisting}{ocamllisting}
    \ocamlbox
    \lstset{mathescape=false}}
   {}

% Show line numbers
\lstnewenvironment{ocamlnum}
   {%XHEVEA\setenvclass{lstlisting}{ocamllisting}
    \ocamlbox
    \lstset{%
        numbers=left,
        numberstyle=\tiny,
        firstnumber=1,
        stepnumber=1}}
   {}

% For consecutive numbering, the lstlisting has to be used directly.
\newenvironment{ocamlblocksize}{\footnotesize}{}

\newenvironment{ocamlblock}
   {%XHEVEA\setenvclass{lstlisting}{ocamllisting}
    \ocamlboxenv
    \lstset{%
        numbers=left,
        numberstyle=\tiny,
        firstnumber=auto,
        stepnumber=1}}
   {}

%
% Same, but do not escape back to LaTeX.
%
\lstnewenvironment{ocamlx}
   {%XHEVEA\setenvclass{lstlisting}{ocamllisting}
    \footnotesize
    \ocamlenv
    \lstset{%
        boxpos=t,
        aboveskip=8pt,
        belowskip=8pt,
        xleftmargin=4em}}
   {}

\lstnewenvironment{ocamly}
   {%XHEVEA\setenvclass{lstlisting}{ocamllisting}
    \footnotesize
    \ocamlenv
    \lstset{%
        boxpos=t,
        aboveskip=8pt,
        belowskip=8pt,
        xleftmargin=4em,
        escapechar=@}}
   {}

\lstnewenvironment{ocamldebug}
   {%XHEVEA\setenvclass{lstlisting}{ocamllisting}
    \footnotesize
    \ocamlenv
    \lstset{%
        boxpos=t,
        aboveskip=8pt,
        belowskip=8pt,
        xleftmargin=4em,
        escapechar=`,
        morekeywords={ocd,break,run,help}}}
   {}

%
% For C code
%
\lstdefinestyle{c}{%
    language=C,
    basicstyle=\ttfamily,
    keywordstyle=\bfseries\ttfamily,
    breaklines=true,
    mathescape=true,
    columns=flexible}
\lstnewenvironment{clisting}
   {%XHEVEA\setenvclass{lstlisting}{clisting}
    \setstretch{1}    % Single spacing
    \footnotesize
    \lstset{%
        style=c,
        boxpos=t,
        aboveskip=0pt,
        belowskip=0pt}}
   {}
\lstnewenvironment{ccode}
   {%XHEVEA\setenvclass{lstlisting}{ccode}
    \setstretch{1}    % Single spacing
    \footnotesize
    \lstset{%
        style=c,
        boxpos=t,
        aboveskip=8pt,
        belowskip=8pt,
        xleftmargin=4em}}
   {}

%
% For Java code
%
\lstdefinestyle{java}{%
    language=Java,
    basicstyle=\ttfamily,
    keywordstyle=\bfseries\ttfamily,
    breaklines=true,
    mathescape=true,
    columns=flexible}
\lstnewenvironment{javalisting}
   {%XHEVEA\setenvclass{lstlisting}{clisting}
    \setstretch{1}    % Single spacing
    \footnotesize
    \lstset{%
        style=java,
        boxpos=t,
        aboveskip=0pt,
        belowskip=0pt}}
   {}
\lstnewenvironment{java}
   {%XHEVEA\setenvclass{lstlisting}{ccode}
    \setstretch{1}    % Single spacing
    \footnotesize
    \lstset{%
        style=java,
        boxpos=t,
        aboveskip=8pt,
        belowskip=8pt,
        xleftmargin=4em}}
   {}

%
% For Tim's syntax listings
%
\input{defs-syntax}
\lstdefinestyle{syntax}{%
    language=Syntax,
    basicstyle=\ttfamily,
    keywordstyle=\it,
    breaklines=false,
    mathescape=false,
    columns=flexible,
    tabsize=8,
    showtabs=true,
    tab=\rightarrowfill}
\lstnewenvironment{syntaxlisting}
   {%XHEVEA\setenvclass{lstlisting}{syntaxlisting}
    \lstset{%
        style=syntax,
        boxpos=t,
        aboveskip=0pt,
        belowskip=0pt}}
   {}
\lstnewenvironment{syntax}
   {%XHEVEA\setenvclass{lstlisting}{syntaxlisting}
    \lstset{%
        style=syntax,
        boxpos=t,
        aboveskip=8pt,
        belowskip=8pt,
        xleftmargin=4em}}
   {}

% -*-
% Local Variables:
% Mode: LaTeX
% fill-column: 100
% TeX-master: "paper"
% TeX-command-default: "LaTeX/dvips Interactive"
% End:
% -*-
% vim:tw=100:fo=tcq:
