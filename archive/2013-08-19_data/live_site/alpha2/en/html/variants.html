<html>

    <head>
    
        <meta charset="utf-8"/>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta name="robots" content="NOINDEX, NOARCHIVE, NOFOLLOW"/>
        
        <title>Chapter 4. Variants / Real World OCaml</title>
        
        <link rel="stylesheet" href="../../media/css/main.css"/>
        
        <script src="../../media/js/require.js" data-main="../../media/js/main.js"> </script>
        <script>
            require.config({
                config: {
                    gitHub: {
                        user: 'ocamllabs',
                        repo: 'rwo\u002Dcomments',
                        milestone: 'alpha2',
                        page: 'variants.html'
                    }
                }
            });
        </script>
        
    
    </head>
    
    <body>
    
        <div class="body">
        
            <header class="header">
                <h1><img src="../../media/img/header.png" width="213" height="59" alt="Real World OCaml, by Jason Hickey, Anil Madhavapeddy and Yaron Minsky"/></h1>
            </header>
    
            <nav class="navigation">
                <ul>
                    <li>
                        <a href="index.html">Table of Contents</a>
                    </li>
                    
                        <li>
                            <a href="pt01.html">I. Basic Concepts</a>
                            
                                 
                                    <ul>
                                        
                                            <li>
                                                <a href="a-guided-tour.html">1. A Guided Tour</a>
                                            </li>
                                        
                                            <li>
                                                <a href="variables-and-functions.html">2. Variables and Functions</a>
                                            </li>
                                        
                                            <li>
                                                <a href="records.html">3. Records</a>
                                            </li>
                                        
                                            <li>
                                                <a href="variants.html" class="here">4. Variants</a>
                                            </li>
                                        
                                            <li>
                                                <a href="error-handling.html">5. Error Handling</a>
                                            </li>
                                        
                                            <li>
                                                <a href="functors.html">6. Functors</a>
                                            </li>
                                        
                                            <li>
                                                <a href="imperative-programming-1.html">7. Imperative Programming</a>
                                            </li>
                                        
                                            <li>
                                                <a href="object-oriented-programming.html">8. Object Oriented Programming</a>
                                            </li>
                                        
                                    </ul>
                                
                            
                        </li>
                    
                        <li>
                            <a href="pt02.html">II. Practical Examples</a>
                            
                                
                            
                        </li>
                    
                        <li>
                            <a href="pt03.html">III. Advanced Topics</a>
                            
                                
                            
                        </li>
                    
                </ul>
            </nav>
        
            <article class="page">
        
                <h1>Chapter 4. Variants</h1>
                
                

    <p id="idp7413872">
    Variant types are one of the most useful features of OCaml, and also
    one of the most unusual. They let you represent data that may take
    on multiple different forms, where each form is marked by an
    explicit tag. As we'll see, when combined with pattern matching,
    variants give you a powerful way of representing complex data and of
    organizing the case-analysis on that information.
  </p><p id="idp7414688">
    Let's consider a concrete example of how variants can be useful.
    Almost all terminals support a set of 8 basic colors, and we can
    represent those colors using a variant. Each color is declared as a
    simple tag, with pipes used to separate the different cases.
  </p><div class="highlight"><pre><span class="o">#</span> <span class="k">type</span> <span class="n">basic_color</span> <span class="o">=</span>
    <span class="nc">Black</span> <span class="o">|</span> <span class="nc">Red</span> <span class="o">|</span> <span class="nc">Green</span> <span class="o">|</span> <span class="nc">Yellow</span> <span class="o">|</span> <span class="nc">Blue</span> <span class="o">|</span> <span class="nc">Magenta</span> <span class="o">|</span> <span class="nc">Cyan</span> <span class="o">|</span> <span class="nc">White</span> <span class="o">;;</span>
<span class="o">#</span> <span class="nc">Cyan</span> <span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="n">basic_color</span> <span class="o">=</span> <span class="nc">Cyan</span>
<span class="o">#</span> <span class="o">[</span><span class="nc">Blue</span><span class="o">;</span> <span class="nc">Magenta</span><span class="o">;</span> <span class="nc">Red</span><span class="o">]</span> <span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="n">basic_color</span> <span class="kt">list</span> <span class="o">=</span> <span class="o">[</span><span class="nc">Blue</span><span class="o">;</span> <span class="nc">Magenta</span><span class="o">;</span> <span class="nc">Red</span><span class="o">]</span>
</pre></div><p id="idp7416432">
    The following function uses pattern matching to convert a
    <code>basic_color</code> to a corresponding integer. Note that
    the exhaustiveness checking on pattern matches means that the
    compiler will warn us if we miss a color.
  </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">basic_color_to_int</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">Black</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="o">|</span> <span class="nc">Red</span>     <span class="o">-&gt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="nc">Green</span> <span class="o">-&gt;</span> <span class="mi">2</span> <span class="o">|</span> <span class="nc">Yellow</span> <span class="o">-&gt;</span> <span class="mi">3</span>
  <span class="o">|</span> <span class="nc">Blue</span>  <span class="o">-&gt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="nc">Magenta</span> <span class="o">-&gt;</span> <span class="mi">5</span> <span class="o">|</span> <span class="nc">Cyan</span>  <span class="o">-&gt;</span> <span class="mi">6</span> <span class="o">|</span> <span class="nc">White</span>  <span class="o">-&gt;</span> <span class="mi">7</span> <span class="o">;;</span>
<span class="k">val</span> <span class="n">basic_color_to_int</span> <span class="o">:</span> <span class="n">basic_color</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
<span class="o">#</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">~</span><span class="n">f</span><span class="o">:</span><span class="n">basic_color_to_int</span> <span class="o">[</span><span class="nc">Blue</span><span class="o">;</span><span class="nc">Red</span><span class="o">];;</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">int</span> <span class="kt">list</span> <span class="o">=</span> <span class="o">[</span><span class="mi">4</span><span class="o">;</span> <span class="mi">1</span><span class="o">]</span>
</pre></div><p id="idp7419168">
    Using the above, we can generate escape codes to change the color of
    a given string displayed in a terminal.
  </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">color_by_number</span> <span class="n">number</span> <span class="n">text</span> <span class="o">=</span>
    <span class="n">sprintf</span> <span class="s2">&quot;</span><span class="se">\027</span><span class="s2">[38;5;%dm%s</span><span class="se">\027</span><span class="s2">[0m&quot;</span> <span class="n">number</span> <span class="n">text</span><span class="o">;;</span>
  <span class="k">val</span> <span class="n">color_by_number</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
<span class="o">#</span> <span class="k">let</span> <span class="n">blue</span> <span class="o">=</span> <span class="n">color_by_number</span> <span class="o">(</span><span class="n">basic_color_to_int</span> <span class="nc">Blue</span><span class="o">)</span> <span class="s2">&quot;Blue&quot;</span><span class="o">;;</span>
<span class="k">val</span> <span class="n">blue</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\027</span><span class="s2">[38;5;4mBlue</span><span class="se">\027</span><span class="s2">[0m&quot;</span>
<span class="o">#</span> <span class="n">printf</span> <span class="s2">&quot;Hello %s World!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">blue</span><span class="o">;;</span>
<span class="nc">Hello</span> <span class="nc">Blue</span> <span class="nc">World</span><span class="o">!</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">=</span> <span class="bp">()</span>
</pre></div><p id="idp7421232">
    On most terminals, that word &quot;Blue&quot; will be rendered in
    blue.
  </p><p id="idp7421840">
    In this example, the cases of the variant are simple tag with no
    associated data. This is substantively the same as the enumerations
    found in languages like C and Java. But as we'll see, variants can
    do considerably more than represent a simple enumeration. Indeed, an
    enumeration isn't enough to effectively describe the full set of
    colors that a modern terminal can display. Many terminals, including
    the venerable <code>xterm</code>, support 256 different
    colors, broken up into the following groups.
  </p><ul><li><p id="idp7423920">
        The 8 basic colors, in regular and bold versions.
      </p></li><li><p id="idp7424768">
        A 6 × 6 × 6 RGB color cube
      </p></li><li><p id="idp7425664">
        A 24-level grayscale ramp
      </p></li></ul><p id="idp7426304">
    We'll also represent this more complicated color-space as a variant,
    but this time, the different tags will have arguments which describe
    the data available in each case.
  </p><div class="highlight"><pre><span class="o">#</span> <span class="k">type</span> <span class="n">weight</span> <span class="o">=</span> <span class="nc">Regular</span> <span class="o">|</span> <span class="nc">Bold</span>
  <span class="k">type</span> <span class="n">color</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Basic</span> <span class="k">of</span> <span class="n">basic_color</span> <span class="o">*</span> <span class="n">weight</span> <span class="c">(* basic colors, regular and bold *)</span>
  <span class="o">|</span> <span class="nc">RGB</span>   <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span>       <span class="c">(* 6x6x6 color cube *)</span>
  <span class="o">|</span> <span class="nc">Gray</span>  <span class="k">of</span> <span class="kt">int</span>                   <span class="c">(* 24 grayscale levels *)</span>
<span class="o">;;</span>
<span class="o">#</span> <span class="o">[</span><span class="nc">RGB</span> <span class="o">(</span><span class="mi">250</span><span class="o">,</span><span class="mi">70</span><span class="o">,</span><span class="mi">70</span><span class="o">);</span> <span class="nc">Basic</span> <span class="o">(</span><span class="nc">Green</span><span class="o">,</span> <span class="nc">Regular</span><span class="o">)];;</span>
<span class="o">-</span> <span class="o">:</span> <span class="n">color</span> <span class="kt">list</span> <span class="o">=</span> <span class="o">[</span><span class="nc">RGB</span> <span class="o">(</span><span class="mi">250</span><span class="o">,</span> <span class="mi">70</span><span class="o">,</span> <span class="mi">70</span><span class="o">);</span> <span class="nc">Basic</span> <span class="o">(</span><span class="nc">Green</span><span class="o">,</span> <span class="nc">Regular</span><span class="o">)]</span>
</pre></div><p id="idp7428128">
    Once again, we'll use pattern matching to convert a color to a
    corresponding integer. But in this case, the pattern matching does
    more than separate out the different cases; it also allows us to
    extract the data associated with each tag.
  </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">color_to_int</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="nc">Basic</span> <span class="o">(</span><span class="n">basic_color</span><span class="o">,</span><span class="n">weight</span><span class="o">)</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">base</span> <span class="o">=</span> <span class="k">match</span> <span class="n">weight</span> <span class="k">with</span> <span class="nc">Bold</span> <span class="o">-&gt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="nc">Regular</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
      <span class="n">base</span> <span class="o">+</span> <span class="n">basic_color_to_int</span> <span class="n">basic_color</span>
    <span class="o">|</span> <span class="nc">RGB</span> <span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">g</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">36</span>
    <span class="o">|</span> <span class="nc">Gray</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="mi">232</span> <span class="o">+</span> <span class="n">i</span> <span class="o">;;</span>
<span class="k">val</span> <span class="n">color_to_int</span> <span class="o">:</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div><p id="idp7430064">
    Now, we can print text using the full set of available colors.
  </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">color_print</span> <span class="n">color</span> <span class="n">s</span> <span class="o">=</span>
     <span class="n">printf</span> <span class="s2">&quot;%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">color_by_number</span> <span class="o">(</span><span class="n">color_to_int</span> <span class="n">color</span><span class="o">)</span> <span class="n">s</span><span class="o">);;</span>
<span class="k">val</span> <span class="n">color_print</span> <span class="o">:</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
<span class="o">#</span> <span class="n">color_print</span> <span class="o">(</span><span class="nc">Basic</span> <span class="o">(</span><span class="nc">Red</span><span class="o">,</span><span class="nc">Bold</span><span class="o">))</span> <span class="s2">&quot;A bold red!&quot;</span><span class="o">;;</span>
<span class="nc">A</span> <span class="n">bold</span> <span class="n">red</span><span class="o">!</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">=</span> <span class="bp">()</span>
<span class="o">#</span> <span class="n">color_print</span> <span class="o">(</span><span class="nc">Gray</span> <span class="mi">4</span><span class="o">)</span> <span class="s2">&quot;A muted gray...&quot;</span><span class="o">;;</span>
<span class="nc">A</span> <span class="n">muted</span> <span class="n">gray</span><span class="o">...</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">=</span> <span class="bp">()</span>
</pre></div><aside class="note"><h1>
  Catch-all cases and refactoring
  </h1><p id="idp7432224">
    OCaml's type system can act as a refactoring tool, by warning you of
    places where your code needs to be updated to match an interface
    change. This is particularly valuable in the context of variants.
  </p><p id="idp7432832">
    Consider what would happen if we were to change the definition of
    <code>color</code> to the following.
  </p><div class="highlight"><pre><span class="o">#</span> <span class="k">type</span> <span class="n">color</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Basic</span> <span class="k">of</span> <span class="n">basic_color</span>     <span class="c">(* basic colors *)</span>
  <span class="o">|</span> <span class="nc">Bold</span>  <span class="k">of</span> <span class="n">basic_color</span>     <span class="c">(* bold basic colors *)</span>
  <span class="o">|</span> <span class="nc">RGB</span>   <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="c">(* 6x6x6 color cube *)</span>
  <span class="o">|</span> <span class="nc">Gray</span>  <span class="k">of</span> <span class="kt">int</span>             <span class="c">(* 24 grayscale levels *)</span>
<span class="o">;;</span>
</pre></div><p id="idp7435040">
    We've essentially broken out the <code>Basic</code> case into
    two cases, <code>Basic</code> and <code>Bold</code>, and
    <code>Basic</code> has changed from having two arguments to
    one. <code>color_to_int</code> as we wrote it still expects
    the old structure of the variant, and if we try to compile that same
    code again, the compiler will notice the discrepancy.
  </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">color_to_int</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="nc">Basic</span> <span class="o">(</span><span class="n">basic_color</span><span class="o">,</span><span class="n">weight</span><span class="o">)</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">base</span> <span class="o">=</span> <span class="k">match</span> <span class="n">weight</span> <span class="k">with</span> <span class="nc">Bold</span> <span class="o">-&gt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="nc">Regular</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
      <span class="n">base</span> <span class="o">+</span> <span class="n">basic_color_to_int</span> <span class="n">basic_color</span>
    <span class="o">|</span> <span class="nc">RGB</span> <span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">g</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">36</span>
    <span class="o">|</span> <span class="nc">Gray</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="mi">232</span> <span class="o">+</span> <span class="n">i</span> <span class="o">;;</span>
<span class="nc">Characters</span> <span class="mi">40</span><span class="o">-</span><span class="mi">60</span><span class="o">:</span>
<span class="nc">Error</span><span class="o">:</span> <span class="nc">This</span> <span class="n">pattern</span> <span class="n">matches</span> <span class="n">values</span> <span class="k">of</span> <span class="k">type</span> <span class="k">'</span><span class="n">a</span> <span class="o">*</span> <span class="k">'</span><span class="n">b</span>
       <span class="n">but</span> <span class="n">a</span> <span class="n">pattern</span> <span class="n">was</span> <span class="n">expected</span> <span class="n">which</span> <span class="n">matches</span> <span class="n">values</span> <span class="k">of</span> <span class="k">type</span> <span class="n">basic_color</span>
</pre></div><p id="idp7440000">
    Here, the compiler is complaining that the <code>Basic</code>
    tag is used with the wrong number of arguments. If we fix that,
    however, the compiler flag will flag a second problem, which is that
    we haven't handled the new <code>Bold</code> tag.
  </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">color_to_int</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="nc">Basic</span> <span class="n">basic_color</span> <span class="o">-&gt;</span> <span class="n">basic_color_to_int</span> <span class="n">basic_color</span>
    <span class="o">|</span> <span class="nc">RGB</span> <span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">g</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">36</span>
    <span class="o">|</span> <span class="nc">Gray</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="mi">232</span> <span class="o">+</span> <span class="n">i</span> <span class="o">;;</span>
<span class="nc">Characters</span> <span class="mi">19</span><span class="o">-</span><span class="mi">154</span><span class="o">:</span>
<span class="nc">Warning</span> <span class="mi">8</span><span class="o">:</span> <span class="n">this</span> <span class="n">pattern</span><span class="o">-</span><span class="n">matching</span> <span class="n">is</span> <span class="n">not</span> <span class="n">exhaustive</span><span class="o">.</span>
<span class="nc">Here</span> <span class="n">is</span> <span class="n">an</span> <span class="n">example</span> <span class="k">of</span> <span class="n">a</span> <span class="n">value</span> <span class="n">that</span> <span class="n">is</span> <span class="n">not</span> <span class="n">matched</span><span class="o">:</span>
<span class="nc">Bold</span> <span class="o">_</span>
<span class="k">val</span> <span class="n">color_to_int</span> <span class="o">:</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div><p id="idp7443664">
    Fixing this now leads us to the correct implementation.
  </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">color_to_int</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="nc">Basic</span> <span class="n">basic_color</span> <span class="o">-&gt;</span> <span class="n">basic_color_to_int</span> <span class="n">basic_color</span>
    <span class="o">|</span> <span class="nc">Bold</span>  <span class="n">basic_color</span> <span class="o">-&gt;</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">basic_color_to_int</span> <span class="n">basic_color</span>
    <span class="o">|</span> <span class="nc">RGB</span> <span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">g</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">36</span>
    <span class="o">|</span> <span class="nc">Gray</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="mi">232</span> <span class="o">+</span> <span class="n">i</span> <span class="o">;;</span>
<span class="k">val</span> <span class="n">color_to_int</span> <span class="o">:</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div><p id="idp7445344">
    As we've seen, the type errors identified the things that needed to
    be fixed to complete the refactoring of the code. This is
    fantastically useful, but for it to work well and reliably, you need
    to write your code in a way that maximizes the compiler's chances of
    helping you find the bugs. One important rule of thumb to follow to
    maximize what the compiler can do for you is to avoid catch-all
    cases in pattern matches.
  </p><p id="idp7446192">
    Here's an example of how a catch-all case plays in. Imagine we
    wanted a version of <code>color_to_int</code> that works on
    older terminals by rendering the first 16 colors (the 8
    <code>basic_color</code>s in regular and bold) in the normal
    way, but rendering everything else as white. We might have written
    the function as follows.
  </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">oldschool_color_to_int</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="nc">Basic</span> <span class="o">(</span><span class="n">basic_color</span><span class="o">,</span><span class="n">weight</span><span class="o">)</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">base</span> <span class="o">=</span> <span class="k">match</span> <span class="n">weight</span> <span class="k">with</span> <span class="nc">Bold</span> <span class="o">-&gt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="nc">Regular</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
      <span class="n">base</span> <span class="o">+</span> <span class="n">basic_color_to_int</span> <span class="n">basic_color</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">basic_color_to_int</span> <span class="nc">White</span><span class="o">;;</span>
<span class="k">val</span> <span class="n">oldschool_color_to_int</span> <span class="o">:</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div><p id="idp7449504">
    But because the catch-all case encompasses all possibilities, the
    type system will no longer warn us that we have missed the new
    <code>Bold</code> case when we change the type to include it.
    We can get this check back by being more explicit about what we're
    ignoring. We haven't changed the behavior of the code, but we have
    improved our robustness to change.
  </p></aside><section><h1 id="combining-records-and-variants">Combining records and variants</h1><p id="idp7451920">
      Records and variants are most effective when used in concert.
      Consider again the type <code>Log_entry.t</code>
<a href="records.html">Chapter 3, <i>Records</i></a>:
    </p><div class="highlight"><pre><span class="k">module</span> <span class="nc">Log_entry</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="n">t</span> <span class="o">=</span>
    <span class="o">{</span> <span class="n">session_id</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
      <span class="n">time</span><span class="o">:</span> <span class="nn">Time</span><span class="p">.</span><span class="n">t</span><span class="o">;</span>
      <span class="n">important</span><span class="o">:</span> <span class="kt">bool</span><span class="o">;</span>
      <span class="n">message</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
    <span class="o">}</span>
<span class="k">end</span>
</pre></div><p id="idp7454560">
      This record type combines multiple pieces of data into one value.
      In particular, a single <code>Log_entry.t</code> has a
      <code>session_id</code> <span><em>and</em></span> a
      <code>time</code> <span><em>and</em></span> an
      <code>important</code> flag <span><em>and</em></span> a
      <code>message</code>. More generally, you can think of
      record types as acting as conjunctions. Variants, on the other
      hand, are disjunctions, letting you represent multiple
      possibilities, as in the following example.
    </p><div class="highlight"><pre><span class="k">type</span> <span class="n">client_message</span> <span class="o">=</span> <span class="o">|</span> <span class="nc">Logon</span> <span class="k">of</span> <span class="nn">Logon</span><span class="p">.</span><span class="n">t</span>
                      <span class="o">|</span> <span class="nc">Heartbeat</span> <span class="k">of</span> <span class="nn">Heartbeat</span><span class="p">.</span><span class="n">t</span>
                      <span class="o">|</span> <span class="nc">Log_entry</span> <span class="k">of</span> <span class="nn">Log_entry</span><span class="p">.</span><span class="n">t</span>
</pre></div><p id="idp7460592">
      A <code>client_message</code> is a <code>Logon</code>
<span><em>or</em></span> a <code>Heartbeat</code>
<span><em>or</em></span> a <code>Log_entry</code>. If we want
      to write code that processes messages generically, rather than
      code specialized to a fixed message type, we need something like
      <code>client_message</code> to act as one overarching type
      for the different possible messages.
    </p><p id="idp7465136">
      You can increase the precision of your types by using variants to
      represent differences between types, and records to represent
      shared structure. Consider the following function that takes a
      list of <code>client_message</code>s and returns all
      messages generated by a given user. The code in question is
      implemented by folding over the list of messages, where the
      accumulator is a pair of:
    </p><ul><li><p id="idp7467104">
          the set of session identifiers for the user that have been
          seen thus far.
        </p></li><li><p id="idp7467984">
          the set of messages so far that are associated with the user.
        </p></li></ul><p id="idp7468720">
      Here's the concrete code.
    </p><div class="highlight"><pre><span class="k">let</span> <span class="n">messages_for_user</span> <span class="n">user</span> <span class="n">messages</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">(</span><span class="n">user_messages</span><span class="o">,_)</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">fold</span> <span class="n">messages</span> <span class="o">~</span><span class="n">init</span><span class="o">:(</span><span class="bp">[]</span><span class="o">,</span><span class="nn">String</span><span class="p">.</span><span class="nn">Set</span><span class="p">.</span><span class="n">empty</span><span class="o">)</span>
      <span class="o">~</span><span class="n">f</span><span class="o">:(</span><span class="k">fun</span> <span class="o">((</span><span class="n">messages</span><span class="o">,</span><span class="n">user_sessions</span><span class="o">)</span> <span class="k">as</span> <span class="n">acc</span><span class="o">)</span> <span class="n">message</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">message</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Logon</span> <span class="n">m</span> <span class="o">-&gt;</span>
          <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="nn">Logon</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span> <span class="k">then</span>
            <span class="o">(</span><span class="n">message</span><span class="o">::</span><span class="n">messages</span><span class="o">,</span> <span class="nn">Set</span><span class="p">.</span><span class="n">add</span> <span class="n">user_sessions</span> <span class="n">m</span><span class="o">.</span><span class="nn">Logon</span><span class="p">.</span><span class="n">session_id</span><span class="o">)</span>
          <span class="k">else</span> <span class="n">acc</span>
        <span class="o">|</span> <span class="nc">Heartbeat</span> <span class="o">_</span> <span class="o">|</span> <span class="nc">Log_entry</span> <span class="o">_</span> <span class="o">-&gt;</span>
          <span class="k">let</span> <span class="n">session_id</span> <span class="o">=</span> <span class="k">match</span> <span class="n">message</span> <span class="k">with</span>
            <span class="o">|</span> <span class="nc">Logon</span>     <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="nn">Logon</span><span class="p">.</span><span class="n">session_id</span>
            <span class="o">|</span> <span class="nc">Heartbeat</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="nn">Heartbeat</span><span class="p">.</span><span class="n">session_id</span>
            <span class="o">|</span> <span class="nc">Log_entry</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="nn">Log_entry</span><span class="p">.</span><span class="n">session_id</span>
          <span class="k">in</span>
          <span class="k">if</span> <span class="nn">Set</span><span class="p">.</span><span class="n">mem</span> <span class="n">user_sessions</span> <span class="n">session_id</span> <span class="k">then</span>
            <span class="o">(</span><span class="n">message</span><span class="o">::</span><span class="n">messages</span><span class="o">,</span><span class="n">user_sessions</span><span class="o">)</span>
          <span class="k">else</span> <span class="n">acc</span>
      <span class="o">)</span>
  <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">user_messages</span>
</pre></div><p id="idp7471024">
      There's one awkward bit about the code above, which is the
      calculation of the session ids. In particular, we have the
      following repetitive snippet of code:
    </p><div class="highlight"><pre>  <span class="k">let</span> <span class="n">session_id</span> <span class="o">=</span> <span class="k">match</span> <span class="n">message</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Logon</span>     <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="nn">Logon</span><span class="p">.</span><span class="n">session_id</span>
    <span class="o">|</span> <span class="nc">Heartbeat</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="nn">Heartbeat</span><span class="p">.</span><span class="n">session_id</span>
    <span class="o">|</span> <span class="nc">Log_entry</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="nn">Log_entry</span><span class="p">.</span><span class="n">session_id</span>
  <span class="k">in</span>
</pre></div><p id="idp7472800">
      This code effectively computes the session id for each underlying
      message type. The repetition in this case isn't that bad, but
      would become problematic in larger and more complicated examples.
    </p><p id="idp7473424">
      We can improve the code by refactoring our types to explicitly
      separate which parts are shared and which are common. The first
      step is to cut down the definitions of the per-message records to
      just contain the unique components of each message.
    </p><div class="highlight"><pre><span class="k">module</span> <span class="nc">Log_entry</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="o">{</span> <span class="n">important</span><span class="o">:</span> <span class="kt">bool</span><span class="o">;</span>
             <span class="n">message</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
           <span class="o">}</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nc">Heartbeat</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="o">{</span> <span class="n">status_message</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="o">}</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nc">Logon</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="o">{</span> <span class="n">user</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
             <span class="n">credentials</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
           <span class="o">}</span>
<span class="k">end</span>
</pre></div><p id="idp7475248">
      We can then define a variant type that covers the different
      possible unique components.
    </p><div class="highlight"><pre><span class="k">type</span> <span class="n">details</span> <span class="o">=</span>
<span class="o">|</span> <span class="nc">Logon</span> <span class="k">of</span> <span class="nn">Logon</span><span class="p">.</span><span class="n">t</span>
<span class="o">|</span> <span class="nc">Heartbeat</span> <span class="k">of</span> <span class="nn">Heartbeat</span><span class="p">.</span><span class="n">t</span>
<span class="o">|</span> <span class="nc">Log_entry</span> <span class="k">of</span> <span class="nn">Log_entry</span><span class="p">.</span><span class="n">t</span>
</pre></div><p id="idp7476736">
      Separately, we need a record that contains the fields that are
      common across all messages.
    </p><div class="highlight"><pre><span class="k">module</span> <span class="nc">Common</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="o">{</span> <span class="n">session_id</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
             <span class="n">time</span><span class="o">:</span> <span class="nn">Time</span><span class="p">.</span><span class="n">t</span><span class="o">;</span>
           <span class="o">}</span>
<span class="k">end</span>
</pre></div><p id="idp7478224">
      A full message can then represented as a pair of a
      <code>Common.t</code> and a <code>details</code>.
      Using this, we can rewrite our example above as follows:
    </p><div class="highlight"><pre><span class="k">let</span> <span class="n">messages_for_user</span> <span class="n">user</span> <span class="n">messages</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">(</span><span class="n">user_messages</span><span class="o">,_)</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">fold</span> <span class="n">messages</span> <span class="o">~</span><span class="n">init</span><span class="o">:(</span><span class="bp">[]</span><span class="o">,</span><span class="nn">String</span><span class="p">.</span><span class="nn">Set</span><span class="p">.</span><span class="n">empty</span><span class="o">)</span>
      <span class="o">~</span><span class="n">f</span><span class="o">:(</span><span class="k">fun</span> <span class="o">((</span><span class="n">messages</span><span class="o">,</span><span class="n">user_sessions</span><span class="o">)</span> <span class="k">as</span> <span class="n">acc</span><span class="o">)</span> <span class="o">((</span><span class="n">common</span><span class="o">,</span><span class="n">details</span><span class="o">)</span> <span class="k">as</span> <span class="n">message</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">session_id</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="nn">Common</span><span class="p">.</span><span class="n">session_id</span> <span class="k">in</span>
        <span class="k">match</span> <span class="n">details</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Logon</span> <span class="n">m</span> <span class="o">-&gt;</span>
          <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="nn">Logon</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span> <span class="k">then</span>
            <span class="o">(</span><span class="n">message</span><span class="o">::</span><span class="n">messages</span><span class="o">,</span> <span class="nn">Set</span><span class="p">.</span><span class="n">add</span> <span class="n">user_sessions</span> <span class="n">session_id</span><span class="o">)</span>
          <span class="k">else</span> <span class="n">acc</span>
        <span class="o">|</span> <span class="nc">Heartbeat</span> <span class="o">_</span> <span class="o">|</span> <span class="nc">Log_entry</span> <span class="o">_</span> <span class="o">-&gt;</span>
          <span class="k">if</span> <span class="nn">Set</span><span class="p">.</span><span class="n">mem</span> <span class="n">user_sessions</span> <span class="n">session_id</span> <span class="k">then</span>
            <span class="o">(</span><span class="n">message</span><span class="o">::</span><span class="n">messages</span><span class="o">,</span><span class="n">user_sessions</span><span class="o">)</span>
          <span class="k">else</span> <span class="n">acc</span>
      <span class="o">)</span>
  <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">user_messages</span>
</pre></div><p id="idp7482000">
      Note that the more complex match statement for computing the
      session id has been replaced with the simple expression
      <code>common.Common.session_id</code>.
    </p><p id="idp7483168">
      In addition, this design allows us to essentially downcast to the
      specific message type once we know what it is, and then dispatch
      code to handle just that message type. In particular, while we use
      the type <code>Common.t * details</code> to represent an
      arbitrary message, we can use
      <code>Common.t * Logon.t</code> to represent a logon
      message. Thus, if we had functions for handling individual message
      types, we could write a dispatch function as follows.
    </p><div class="highlight"><pre><span class="k">let</span> <span class="n">handle_message</span> <span class="n">server_state</span> <span class="o">(</span><span class="n">common</span><span class="o">,</span><span class="n">details</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">details</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">Log_entry</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">handle_log_entry</span> <span class="n">server_state</span> <span class="o">(</span><span class="n">common</span><span class="o">,</span><span class="n">m</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Logon</span>     <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">handle_logon</span>     <span class="n">server_state</span> <span class="o">(</span><span class="n">common</span><span class="o">,</span><span class="n">m</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Heartbeat</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">handle_heartbeat</span> <span class="n">server_state</span> <span class="o">(</span><span class="n">common</span><span class="o">,</span><span class="n">m</span><span class="o">)</span>
</pre></div><p id="idp7486672">
      And it's explicit at the type level that
      <code>handle_log_entry</code> sees only
      <code>Log_entry</code> messages,
      <code>handle_logon</code> sees only <code>Logon</code>
      messages, etc.
    </p></section><section><h1 id="variants-and-recursive-data-structures">Variants and recursive data structures</h1><p id="idp7490560">
      Another common application of variants is to represent tree-like
      recursive data-structures. We'll show how this can be done by
      walking through the design of a simple Boolean expression
      language. Such a language can be useful anywhere you need to
      specify filters, which are used in everything from packet
      analyzers to mail clients.
    </p><p id="idp7491328">
      An expression in this language will be defined by the variant
      <code>blang</code> (short for &quot;boolean language&quot;)
      with one tag for each kind of expression we want to support.
    </p><div class="highlight"><pre><span class="o">#</span> <span class="k">type</span> <span class="k">'</span><span class="n">a</span> <span class="n">blang</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Base</span>  <span class="k">of</span> <span class="k">'</span><span class="n">a</span>
  <span class="o">|</span> <span class="nc">Const</span> <span class="k">of</span> <span class="kt">bool</span>
  <span class="o">|</span> <span class="nc">And</span>   <span class="k">of</span> <span class="k">'</span><span class="n">a</span> <span class="n">blang</span> <span class="kt">list</span>
  <span class="o">|</span> <span class="nc">Or</span>    <span class="k">of</span> <span class="k">'</span><span class="n">a</span> <span class="n">blang</span> <span class="kt">list</span>
  <span class="o">|</span> <span class="nc">Not</span>   <span class="k">of</span> <span class="k">'</span><span class="n">a</span> <span class="n">blang</span>
  <span class="o">;;</span>
</pre></div><p id="idp7493776">
      Note that the definition of the type <code>blang</code> is
      recursive, meaning that a <code>blang</code> may contain
      other <code>blang</code>s.
    </p><p id="idp7496032">
      The purpose of each tag is pretty straightforward.
      <code>And</code>, <code>Or</code> and
      <code>Not</code> are the basic operators for building up
      boolean expression, and <code>Const</code> lets you enter
      constants <code>true</code> and <code>false</code>.
    </p><p id="idp7500320">
      The <code>Base</code> tag is what allows you to tie the
      <code>blang</code> to your application, by letting you
      specify an element of some base predicate type, whose whose truth
      or falsehood is determined by your application. If you were
      writing a filter language for an email processor, your base
      predicates might specify the tests you would run against an email,
      as in the following example.
    </p><div class="highlight"><pre><span class="o">#</span> <span class="k">type</span> <span class="n">mail_field</span> <span class="o">=</span> <span class="nc">To</span> <span class="o">|</span> <span class="nc">From</span> <span class="o">|</span> <span class="nc">CC</span> <span class="o">|</span> <span class="nc">Date</span> <span class="o">|</span> <span class="nc">Subject</span>
  <span class="k">type</span> <span class="n">mail_predicate</span> <span class="o">=</span> <span class="o">{</span> <span class="n">field</span><span class="o">:</span> <span class="n">mail_field</span><span class="o">;</span>
                          <span class="n">contains</span><span class="o">:</span> <span class="kt">string</span> <span class="o">}</span>
  <span class="o">;;</span>
</pre></div><p id="idp7503344">
      Using the above, we can construct a simple expression with
      <code>mail_predicate</code> as its base predicate.
    </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">test</span> <span class="n">field</span> <span class="n">contains</span> <span class="o">=</span> <span class="nc">Base</span> <span class="o">{</span> <span class="n">field</span><span class="o">;</span> <span class="n">contains</span> <span class="o">};;</span>
<span class="k">val</span> <span class="n">test</span> <span class="o">:</span> <span class="n">mail_field</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="n">mail_predicate</span> <span class="n">blang</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
<span class="o">#</span> <span class="nc">And</span> <span class="o">[</span> <span class="nc">Or</span> <span class="o">[</span> <span class="n">test</span> <span class="nc">To</span> <span class="s2">&quot;doligez&quot;</span><span class="o">;</span> <span class="n">test</span> <span class="nc">CC</span> <span class="s2">&quot;doligez&quot;</span> <span class="o">];</span>
        <span class="n">test</span> <span class="nc">Subject</span> <span class="s2">&quot;runtime&quot;</span><span class="o">;</span>
      <span class="o">]</span>
  <span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="n">mail_predicate</span> <span class="n">blang</span> <span class="o">=</span>
<span class="nc">And</span>
 <span class="o">[</span><span class="nc">Or</span>
   <span class="o">[</span><span class="nc">Base</span> <span class="o">{</span><span class="n">field</span> <span class="o">=</span> <span class="nc">To</span><span class="o">;</span> <span class="n">contains</span> <span class="o">=</span> <span class="s2">&quot;doligez&quot;</span><span class="o">};</span>
    <span class="nc">Base</span> <span class="o">{</span><span class="n">field</span> <span class="o">=</span> <span class="nc">CC</span><span class="o">;</span> <span class="n">contains</span> <span class="o">=</span> <span class="s2">&quot;doligez&quot;</span><span class="o">}];</span>
  <span class="nc">Base</span> <span class="o">{</span><span class="n">field</span> <span class="o">=</span> <span class="nc">Subject</span><span class="o">;</span> <span class="n">contains</span> <span class="o">=</span> <span class="s2">&quot;runtime&quot;</span><span class="o">}]</span>
</pre></div><p id="idp7506016">
      Being able to construct such expressions isn't enough: we also
      need to be able to evaluate such an expression. The following code
      shows how you could write a general-purpose evaluator for
      <code>blang</code>'s.
    </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="k">rec</span> <span class="n">eval</span> <span class="n">blang</span> <span class="n">base_eval</span> <span class="o">=</span>
    <span class="c">(* a shortcut, so we don't need to repeatedly pass [base_eval]</span>
<span class="c">       explicitly to [eval] *)</span>
    <span class="k">let</span> <span class="n">eval'</span> <span class="n">blang</span> <span class="o">=</span> <span class="n">eval</span> <span class="n">blang</span> <span class="n">base_eval</span> <span class="k">in</span>
    <span class="k">match</span> <span class="n">blang</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Base</span>  <span class="n">base</span>   <span class="o">-&gt;</span> <span class="n">base_eval</span> <span class="n">base</span>
    <span class="o">|</span> <span class="nc">Const</span> <span class="kt">bool</span>   <span class="o">-&gt;</span> <span class="kt">bool</span>
    <span class="o">|</span> <span class="nc">And</span>   <span class="n">blangs</span> <span class="o">-&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">for_all</span> <span class="n">blangs</span> <span class="o">~</span><span class="n">f</span><span class="o">:</span><span class="n">eval'</span>
    <span class="o">|</span> <span class="nc">Or</span>    <span class="n">blangs</span> <span class="o">-&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">exists</span>  <span class="n">blangs</span> <span class="o">~</span><span class="n">f</span><span class="o">:</span><span class="n">eval'</span>
    <span class="o">|</span> <span class="nc">Not</span>   <span class="n">blang</span>  <span class="o">-&gt;</span> <span class="n">not</span> <span class="o">(</span><span class="n">eval'</span> <span class="n">blang</span><span class="o">)</span>
  <span class="o">;;</span>
<span class="k">val</span> <span class="n">eval</span> <span class="o">:</span> <span class="k">'</span><span class="n">a</span> <span class="n">blang</span>  <span class="o">-&gt;</span> <span class="o">(</span><span class="k">'</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">bool</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div><p id="idp7509024">
      The structure of the code is pretty straightforward --- we're just
      pattern-matching over the structure of the data, doing the
      appropriate calculation based on which tag we see. To use this
      evaluator on a concrete example, we just need to write the
      <code>base_eval</code> function which is capable of
      evaluating a base predicate.
    </p><p id="idp7510400">
      Another useful operation to be able to do on expressions is
      simplification. The following function applies some basic
      simplification rules, most of the simplifications being driven by
      the presence of constants.
    </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="k">rec</span> <span class="n">simplify</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="nc">Base</span> <span class="o">_</span> <span class="o">|</span> <span class="nc">Const</span> <span class="o">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
    <span class="o">|</span> <span class="nc">And</span> <span class="n">blangs</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">blangs</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">~</span><span class="n">f</span><span class="o">:</span><span class="n">simplify</span> <span class="n">blangs</span> <span class="k">in</span>
      <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">exists</span> <span class="n">blangs</span> <span class="o">~</span><span class="n">f</span><span class="o">:(</span><span class="k">function</span> <span class="nc">Const</span> <span class="bp">false</span> <span class="o">-&gt;</span> <span class="bp">true</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span><span class="o">)</span>
      <span class="k">then</span> <span class="nc">Const</span> <span class="bp">false</span>
      <span class="k">else</span> <span class="nc">And</span> <span class="n">blangs</span>
    <span class="o">|</span> <span class="nc">Or</span> <span class="n">blangs</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">blangs</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">~</span><span class="n">f</span><span class="o">:</span><span class="n">simplify</span> <span class="n">blangs</span> <span class="k">in</span>
      <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">exists</span> <span class="n">blangs</span> <span class="o">~</span><span class="n">f</span><span class="o">:(</span><span class="k">function</span> <span class="nc">Const</span> <span class="bp">true</span> <span class="o">-&gt;</span> <span class="bp">true</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span><span class="o">)</span>
      <span class="k">then</span> <span class="nc">Const</span> <span class="bp">true</span> <span class="k">else</span> <span class="nc">Or</span> <span class="n">blangs</span>
    <span class="o">|</span> <span class="nc">Not</span> <span class="n">blang</span> <span class="o">-&gt;</span>
      <span class="k">match</span> <span class="n">simplify</span> <span class="n">blang</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Const</span> <span class="kt">bool</span> <span class="o">-&gt;</span> <span class="nc">Const</span> <span class="o">(</span><span class="n">not</span> <span class="kt">bool</span><span class="o">)</span>
      <span class="o">|</span> <span class="n">blang</span> <span class="o">-&gt;</span> <span class="nc">Not</span> <span class="n">blang</span>
  <span class="o">;;</span>
<span class="k">val</span> <span class="n">simplify</span> <span class="o">:</span> <span class="k">'</span><span class="n">a</span> <span class="n">blang</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">a</span> <span class="n">blang</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div><p id="idp7512944">
      One thing to notice about the above code is that it uses a
      catch-all case in the very last line within the
      <code>Not</code> case. It's generally better to be explicit
      about the cases you're ignoring. Indeed, if we change this snippet
      of code to be more explicit:
    </p><div class="highlight"><pre>    <span class="o">|</span> <span class="nc">Not</span> <span class="n">blang</span> <span class="o">-&gt;</span>
      <span class="k">match</span> <span class="n">simplify</span> <span class="n">blang</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Const</span> <span class="kt">bool</span> <span class="o">-&gt;</span> <span class="nc">Const</span> <span class="o">(</span><span class="n">not</span> <span class="kt">bool</span><span class="o">)</span>
      <span class="o">|</span> <span class="o">(</span><span class="nc">And</span> <span class="o">_</span> <span class="o">|</span> <span class="nc">Or</span> <span class="o">_</span> <span class="o">|</span> <span class="nc">Base</span> <span class="o">_</span> <span class="o">|</span> <span class="nc">Not</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="nc">Not</span> <span class="n">blang</span>
</pre></div><p id="idp7515344">
      it's easy to see that we've missed an important case:
      double-negation.
    </p><div class="highlight"><pre>    <span class="o">|</span> <span class="nc">Not</span> <span class="n">blang</span> <span class="o">-&gt;</span>
      <span class="k">match</span> <span class="n">simplify</span> <span class="n">blang</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Const</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="nc">Const</span> <span class="o">(</span><span class="n">not</span> <span class="n">b</span><span class="o">)</span>
      <span class="o">|</span> <span class="nc">Not</span> <span class="n">blang</span> <span class="o">-&gt;</span> <span class="n">blang</span>
      <span class="o">|</span> <span class="o">(</span><span class="nc">And</span> <span class="o">_</span> <span class="o">|</span> <span class="nc">Or</span> <span class="o">_</span> <span class="o">|</span> <span class="nc">Base</span> <span class="o">_</span> <span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Not</span> <span class="n">blang</span>
</pre></div><p id="idp7516896">
      This example is more than a toy. There's a module very much in
      this spirit already exists as part of Core, and gets a lot of
      practical use in a variety of applications.
    </p><p id="idp7517488">
      More generally, using variants to build recursive data-structures
      is a common technique, and shows up everywhere from designing
      little languages to building efficient data-structures.
    </p></section><section><h1 id="polymorphic-variants">Polymorphic variants</h1><p id="idp7519104">
      In addition to the ordinary variants we've seen so far, OCaml also
      supports so-called <span><em>polymorphic variants</em></span>. As
      we'll see, polymorphic variants are more flexible and
      syntactically more lightweight than ordinary variants, but that
      extra power comes at a cost.
    </p><p id="idp7520176">
      Syntactically, polymorphic variants are distinguished from
      ordinary variants by the leading backtick. And unlike ordinary
      variants, polymorphic variants can be used without an explicit
      type declaration.
    </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">three</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Int</span> <span class="mi">3</span><span class="o">;;</span>
<span class="k">val</span> <span class="n">three</span> <span class="o">:</span> <span class="o">[&gt;</span> <span class="o">`</span><span class="nc">Int</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">]</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Int</span> <span class="mi">3</span>
<span class="o">#</span> <span class="k">let</span> <span class="n">four</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Float</span> <span class="mi">4</span><span class="o">.;;</span>
<span class="k">val</span> <span class="n">four</span> <span class="o">:</span> <span class="o">[&gt;</span> <span class="o">`</span><span class="nc">Float</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">]</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Float</span> <span class="mi">4</span><span class="o">.</span>
<span class="o">#</span> <span class="k">let</span> <span class="n">nan</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Not_a_number</span><span class="o">;;</span>
<span class="k">val</span> <span class="n">nan</span> <span class="o">:</span> <span class="o">[&gt;</span> <span class="o">`</span><span class="nc">Not_a_number</span> <span class="o">]</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Not_a_number</span>
<span class="o">#</span> <span class="o">[</span><span class="n">three</span><span class="o">;</span> <span class="n">four</span><span class="o">;</span> <span class="n">nan</span><span class="o">];;</span>
<span class="o">-</span> <span class="o">:</span> <span class="o">[&gt;</span> <span class="o">`</span><span class="nc">Float</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Int</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Not_a_number</span> <span class="o">]</span> <span class="kt">list</span> <span class="o">=</span>
<span class="o">[`</span><span class="nc">Int</span> <span class="mi">3</span><span class="o">;</span> <span class="o">`</span><span class="nc">Float</span> <span class="mi">4</span><span class="o">.;</span> <span class="o">`</span><span class="nc">Not_a_number</span><span class="o">]</span>
</pre></div><p id="idp7522432">
      As you can see, polymorphic variant types are inferred
      automatically, and when we combine variants with different tags,
      the compiler infers a new type that knows about all of those tags.
    </p><p id="idp7523040">
      The type system will complain, however, if it sees incompatible
      uses of the same tag:
    </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">five</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Int</span> <span class="s2">&quot;five&quot;</span><span class="o">;;</span>
<span class="k">val</span> <span class="n">five</span> <span class="o">:</span> <span class="o">[&gt;</span> <span class="o">`</span><span class="nc">Int</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">]</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Int</span> <span class="s2">&quot;five&quot;</span>
<span class="o">#</span> <span class="o">[</span><span class="n">three</span><span class="o">;</span> <span class="n">four</span><span class="o">;</span> <span class="n">five</span><span class="o">];;</span>
<span class="nc">Characters</span> <span class="mi">14</span><span class="o">-</span><span class="mi">18</span><span class="o">:</span>
  <span class="o">[</span><span class="n">three</span><span class="o">;</span> <span class="n">four</span><span class="o">;</span> <span class="n">five</span><span class="o">];;</span>
                <span class="o">^^^^</span>
<span class="nc">Error</span><span class="o">:</span> <span class="nc">This</span> <span class="n">expression</span> <span class="n">has</span> <span class="k">type</span> <span class="o">[&gt;</span> <span class="o">`</span><span class="nc">Int</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">]</span>
       <span class="n">but</span> <span class="n">an</span> <span class="n">expression</span> <span class="n">was</span> <span class="n">expected</span> <span class="k">of</span> <span class="k">type</span>
         <span class="o">[&gt;</span> <span class="o">`</span><span class="nc">Float</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Int</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">]</span>
       <span class="nc">Types</span> <span class="k">for</span> <span class="n">tag</span> <span class="o">`</span><span class="nc">Int</span> <span class="n">are</span> <span class="n">incompatible</span>
</pre></div><p id="idp7524928">
      The <code>&gt;</code> at the beginning of the variant types
      above is critical, because it marks the types as being open to
      combination with other variant types. We can read the type
      <code>[&gt; `Int of string | `Float of float]</code> as
      describing a variant whose tags include
      <code>`Int of string</code> and
      <code>`Float of float</code>, but may include more tags as
      well. In other words, you can roughly translate
      <code>&gt;</code> to mean: &quot;these tags or more&quot;.
    </p><p id="idp7529008">
      OCaml will in some cases infer a variant type with
      <code>&lt;</code>, to indicate &quot;these tags or
      less&quot;, as in the following example.
    </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">is_positive</span> <span class="o">=</span> <span class="k">function</span>
     <span class="o">|</span> <span class="o">`</span><span class="nc">Int</span>   <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span>
     <span class="o">|</span> <span class="o">`</span><span class="nc">Float</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">.</span>
  <span class="o">;;</span>
<span class="k">val</span> <span class="n">is_positive</span> <span class="o">:</span> <span class="o">[&lt;</span> <span class="o">`</span><span class="nc">Float</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Int</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">]</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div><p id="idp7531360">
      The <code>&lt;</code> is there because
      <code>is_positive</code> has no way of dealing with values
      that have tags other than <code>`Float of float</code> or
      <code>`Int of int</code>.
    </p><p id="idp7534320">
      We can think of these <code>&lt;</code> and
      <code>&gt;</code> markers as indications of upper and lower
      bounds on the tags involved. If the same set of tags are both an
      upper and a lower bound, we end up with an
      <span><em>exact</em></span> polymorphic variant type, which has
      neither marker. For example:
    </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">exact</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="o">~</span><span class="n">f</span><span class="o">:</span><span class="n">is_positive</span> <span class="o">[</span><span class="n">three</span><span class="o">;</span><span class="n">four</span><span class="o">];;</span>
<span class="k">val</span> <span class="n">exact</span> <span class="o">:</span> <span class="o">[</span> <span class="o">`</span><span class="nc">Float</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Int</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">]</span> <span class="kt">list</span>
   <span class="o">=</span> <span class="o">[`</span><span class="nc">Int</span> <span class="mi">3</span><span class="o">;</span> <span class="o">`</span><span class="nc">Float</span> <span class="mi">4</span><span class="o">.]</span>
</pre></div><p id="idp7537632">
      Perhaps surprisingly, we can also create polymorphic variant types
      that have different upper and lower bounds.
    </p><div class="highlight"><pre><span class="k">let</span> <span class="n">is_positive</span> <span class="o">=</span> <span class="k">function</span>
     <span class="o">|</span> <span class="o">`</span><span class="nc">Int</span>   <span class="n">x</span> <span class="o">-&gt;</span> <span class="nc">Ok</span> <span class="o">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
     <span class="o">|</span> <span class="o">`</span><span class="nc">Float</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nc">Ok</span> <span class="o">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">.)</span>
     <span class="o">|</span> <span class="o">`</span><span class="nc">Not_a_number</span> <span class="o">-&gt;</span> <span class="nc">Error</span> <span class="s2">&quot;not a number&quot;</span><span class="o">;;</span>
<span class="k">val</span> <span class="n">is_positive</span> <span class="o">:</span>
  <span class="o">[&lt;</span> <span class="o">`</span><span class="nc">Float</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Int</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Not_a_number</span> <span class="o">]</span> <span class="o">-&gt;</span>
  <span class="o">(</span><span class="kt">bool</span><span class="o">,</span> <span class="kt">string</span><span class="o">)</span> <span class="nn">Result</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
<span class="o">#</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="o">[</span><span class="n">three</span><span class="o">;</span> <span class="n">four</span><span class="o">]</span> <span class="o">~</span><span class="n">f</span><span class="o">:(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
     <span class="k">match</span> <span class="n">is_positive</span> <span class="n">x</span> <span class="k">with</span> <span class="nc">Error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span> <span class="o">|</span> <span class="nc">Ok</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="o">);;</span>
  <span class="o">-</span> <span class="o">:</span> <span class="o">[&lt;</span> <span class="o">`</span><span class="nc">Float</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Int</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Not_a_number</span> <span class="o">&gt;</span> <span class="o">`</span><span class="nc">Float</span> <span class="o">`</span><span class="nc">Int</span> <span class="o">]</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">t</span>
<span class="o">=</span> <span class="o">[`</span><span class="nc">Int</span> <span class="mi">3</span><span class="o">;</span> <span class="o">`</span><span class="nc">Float</span> <span class="mi">4</span><span class="o">.]</span>
</pre></div><p id="idp7539536">
      Here, the inferred type states that the tags can be no more than
      <code>`Float</code>, <code>`Int</code> and
      <code>`Not_a_number</code>, and must contain at least
      <code>`Float</code> and <code>`Int</code>. As you can
      already start to see, polymorphic variants can lead to fairly
      complex inferred types.
    </p><section><h1 id="example-terminal-colors-redux">Example: Terminal colors redux</h1><p id="idp7544144">
        To see how to use polymorphic variants in practice, we'll return
        to terminal colors. Imagine that we have a new terminal type
        that adds yet more colors, say, by adding an alpha channel so
        you can specify translucent colors. We could model this extended
        set of colors as follows, using an ordinary variant.
      </p><div class="highlight"><pre><span class="o">#</span> <span class="k">type</span> <span class="n">extended_color</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Basic</span> <span class="k">of</span> <span class="n">basic_color</span> <span class="o">*</span> <span class="n">weight</span>  <span class="c">(* basic colors, regular and bold *)</span>
  <span class="o">|</span> <span class="nc">RGB</span>   <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span>       <span class="c">(* 6x6x6 color space *)</span>
  <span class="o">|</span> <span class="nc">Gray</span>  <span class="k">of</span> <span class="kt">int</span>                   <span class="c">(* 24 grayscale levels *)</span>
  <span class="o">|</span> <span class="nc">RGBA</span>  <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="c">(* 6x6x6x6 color space *)</span>
  <span class="o">;;</span>
</pre></div><p id="idp7546064">
        We want to write a function
        <code>extended_color_to_int</code>, that works like
        <code>color_to_int</code> for all of the old kinds of
        colors, with new logic only for handling colors that include an
        alpha channel. One might try to write such a function as
        follows.
      </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">extended_color_to_int</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="nc">RGBA</span> <span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">g</span><span class="o">,</span><span class="n">b</span><span class="o">,</span><span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">36</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">216</span>
    <span class="o">|</span> <span class="o">(</span><span class="nc">Basic</span> <span class="o">_</span> <span class="o">|</span> <span class="nc">RGB</span> <span class="o">_</span> <span class="o">|</span> <span class="nc">Gray</span> <span class="o">_)</span> <span class="k">as</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="n">color_to_int</span> <span class="n">color</span>
  <span class="o">;;</span>
</pre></div><p id="idp7549200">
        This looks reasonable enough, but it leads to the following type
        error.
      </p><div class="highlight"><pre><span class="nc">Characters</span> <span class="mi">93</span><span class="o">-</span><span class="mi">98</span><span class="o">:</span>
    <span class="o">|</span> <span class="o">(</span><span class="nc">Basic</span> <span class="o">_</span> <span class="o">|</span> <span class="nc">RGB</span> <span class="o">_</span> <span class="o">|</span> <span class="nc">Gray</span> <span class="o">_)</span> <span class="k">as</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="n">color_to_int</span> <span class="n">color</span>
                                                          <span class="o">^^^^^</span>
<span class="nc">Error</span><span class="o">:</span> <span class="nc">This</span> <span class="n">expression</span> <span class="n">has</span> <span class="k">type</span> <span class="n">extended_color</span>
       <span class="n">but</span> <span class="n">an</span> <span class="n">expression</span> <span class="n">was</span> <span class="n">expected</span> <span class="k">of</span> <span class="k">type</span> <span class="n">color</span>
</pre></div><p id="idp7551200">
        The problem is that <code>extended_color</code> and
        <code>color</code> are in the compiler's view distinct and
        unrelated types. The compiler doesn't, for example, recognize
        any equality between the <code>Basic</code> tag in the two
        types.
      </p><p id="idp7553616">
        What we want to do is to share tags between two different
        variant types, and polymorphic variants let us do this in a
        natural way. First, let's rewrite
        <code>basic_color_to_int</code> and
        <code>color_to_int</code> using polymorphic variants. The
        translation here is pretty straightforward.
      </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">basic_color_to_int</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Black</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Red</span>     <span class="o">-&gt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Green</span> <span class="o">-&gt;</span> <span class="mi">2</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Yellow</span> <span class="o">-&gt;</span> <span class="mi">3</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Blue</span>  <span class="o">-&gt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Magenta</span> <span class="o">-&gt;</span> <span class="mi">5</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Cyan</span>  <span class="o">-&gt;</span> <span class="mi">6</span> <span class="o">|</span> <span class="o">`</span><span class="nc">White</span>  <span class="o">-&gt;</span> <span class="mi">7</span>

  <span class="k">let</span> <span class="n">color_to_int</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Basic</span> <span class="o">(</span><span class="n">basic_color</span><span class="o">,</span><span class="n">weight</span><span class="o">)</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">base</span> <span class="o">=</span> <span class="k">match</span> <span class="n">weight</span> <span class="k">with</span> <span class="o">`</span><span class="nc">Bold</span> <span class="o">-&gt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Regular</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
      <span class="n">base</span> <span class="o">+</span> <span class="n">basic_color_to_int</span> <span class="n">basic_color</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">RGB</span> <span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">g</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">36</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Gray</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="mi">232</span> <span class="o">+</span> <span class="n">i</span>
 <span class="o">;;</span>
<span class="k">val</span> <span class="n">basic_color_to_int</span> <span class="o">:</span>
  <span class="o">[&lt;</span> <span class="o">`</span><span class="nc">Black</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Blue</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Cyan</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Green</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Magenta</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Red</span> <span class="o">|</span> <span class="o">`</span><span class="nc">White</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Yellow</span> <span class="o">]</span> <span class="o">-&gt;</span>
  <span class="kt">int</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
<span class="k">val</span> <span class="n">color_to_int</span> <span class="o">:</span>
  <span class="o">[&lt;</span> <span class="o">`</span><span class="nc">Basic</span> <span class="k">of</span>
       <span class="o">[&lt;</span> <span class="o">`</span><span class="nc">Black</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Blue</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Cyan</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Green</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Magenta</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Red</span>
        <span class="o">|</span> <span class="o">`</span><span class="nc">White</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Yellow</span> <span class="o">]</span> <span class="o">*</span>
       <span class="o">[&lt;</span> <span class="o">`</span><span class="nc">Bold</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Regular</span> <span class="o">]</span>
   <span class="o">|</span> <span class="o">`</span><span class="nc">Gray</span> <span class="k">of</span> <span class="kt">int</span>
   <span class="o">|</span> <span class="o">`</span><span class="nc">RGB</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">]</span> <span class="o">-&gt;</span>
  <span class="kt">int</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div><p id="idp7557776">
        Now we can try writing <code>extended_color_to_int</code>.
        The key issue with this code is that
        <code>extended_color_to_int</code> needs to invoke
        <code>color_to_int</code> with a narrower type,
        <span><em>i.e.</em></span>, one that includes fewer tags. Written
        properly, this narrowing can be done via a pattern match. In
        particular, in the following code, the type of the variable
        <code>color</code> includes only the tags
        <code>`Basic</code>, <code>`RGB</code> and
        <code>`Gray</code>, and not <code>`RGBA</code>.
      </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">extended_color_to_int</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">RGBA</span> <span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">g</span><span class="o">,</span><span class="n">b</span><span class="o">,</span><span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">36</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">216</span>
    <span class="o">|</span> <span class="o">(`</span><span class="nc">Basic</span> <span class="o">_</span> <span class="o">|</span> <span class="o">`</span><span class="nc">RGB</span> <span class="o">_</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Gray</span> <span class="o">_)</span> <span class="k">as</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="n">color_to_int</span> <span class="n">color</span>
  <span class="o">;;</span>
<span class="k">val</span> <span class="n">extended_color_to_int</span> <span class="o">:</span>
  <span class="o">[&lt;</span> <span class="o">`</span><span class="nc">Basic</span> <span class="k">of</span>
       <span class="o">[&lt;</span> <span class="o">`</span><span class="nc">Black</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Blue</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Cyan</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Green</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Magenta</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Red</span>
        <span class="o">|</span> <span class="o">`</span><span class="nc">White</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Yellow</span> <span class="o">]</span> <span class="o">*</span>
       <span class="o">[&lt;</span> <span class="o">`</span><span class="nc">Bold</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Regular</span> <span class="o">]</span>
   <span class="o">|</span> <span class="o">`</span><span class="nc">Gray</span> <span class="k">of</span> <span class="kt">int</span>
   <span class="o">|</span> <span class="o">`</span><span class="nc">RGB</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span>
   <span class="o">|</span> <span class="o">`</span><span class="nc">RGBA</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">]</span> <span class="o">-&gt;</span>
  <span class="kt">int</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div><p id="idp7565488">
        The above code is more delicately balanced than one might
        imagine. In particular, if we use a catch-all case instead of an
        explicit enumeration of the cases, the type is no longer
        narrowed, and so compilation fails.
      </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">extended_color_to_int</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">RGBA</span> <span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">g</span><span class="o">,</span><span class="n">b</span><span class="o">,</span><span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">36</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">216</span>
    <span class="o">|</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="n">color_to_int</span> <span class="n">color</span>
  <span class="o">;;</span>
      <span class="nc">Characters</span> <span class="mi">125</span><span class="o">-</span><span class="mi">130</span><span class="o">:</span>
      <span class="o">|</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="n">color_to_int</span> <span class="n">color</span>
                              <span class="o">^^^^^</span>
<span class="nc">Error</span><span class="o">:</span> <span class="nc">This</span> <span class="n">expression</span> <span class="n">has</span> <span class="k">type</span> <span class="o">[&gt;</span> <span class="o">`</span><span class="nc">RGBA</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">]</span>
       <span class="n">but</span> <span class="n">an</span> <span class="n">expression</span> <span class="n">was</span> <span class="n">expected</span> <span class="k">of</span> <span class="k">type</span>
         <span class="o">[&lt;</span> <span class="o">`</span><span class="nc">Basic</span> <span class="k">of</span>
              <span class="o">[&lt;</span> <span class="o">`</span><span class="nc">Black</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Blue</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Cyan</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Green</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Magenta</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Red</span>
               <span class="o">|</span> <span class="o">`</span><span class="nc">White</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Yellow</span> <span class="o">]</span> <span class="o">*</span>
              <span class="o">[&lt;</span> <span class="o">`</span><span class="nc">Bold</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Regular</span> <span class="o">]</span>
          <span class="o">|</span> <span class="o">`</span><span class="nc">Gray</span> <span class="k">of</span> <span class="kt">int</span>
          <span class="o">|</span> <span class="o">`</span><span class="nc">RGB</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">]</span>
       <span class="nc">The</span> <span class="n">second</span> <span class="n">variant</span> <span class="k">type</span> <span class="n">does</span> <span class="n">not</span> <span class="n">allow</span> <span class="n">tag</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="o">`</span><span class="nc">RGBA</span>
</pre></div><aside class="note"><h1>
      Polymorphic variants and catch-all cases
      </h1><p id="idp7568528">
        As we saw with the definition of <code>is_positive</code>,
        a match statement can lead to the inference of an upper bound on
        a variant type, limiting the possible tags to those that can be
        handled by the match. If we add a catch-all case to our match
        statement, we end up with a function with a lower bound.
      </p><div class="highlight"><pre><span class="o">#</span> <span class="k">let</span> <span class="n">is_positive_permissive</span> <span class="o">=</span> <span class="k">function</span>
     <span class="o">|</span> <span class="o">`</span><span class="nc">Int</span>   <span class="n">x</span> <span class="o">-&gt;</span> <span class="nc">Ok</span> <span class="o">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
     <span class="o">|</span> <span class="o">`</span><span class="nc">Float</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nc">Ok</span> <span class="o">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">.)</span>
     <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Error</span> <span class="s2">&quot;Unknown number type&quot;</span>
  <span class="o">;;</span>
<span class="k">val</span> <span class="n">is_positive_permissive</span> <span class="o">:</span>
  <span class="o">[&gt;</span> <span class="o">`</span><span class="nc">Float</span> <span class="k">of</span> <span class="kt">float</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Int</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">]</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="kt">bool</span><span class="o">,</span> <span class="kt">string</span><span class="o">)</span> <span class="nn">Core</span><span class="p">.</span><span class="nn">Std</span><span class="p">.</span><span class="n">_result</span> <span class="o">=</span>
  <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
<span class="o">#</span> <span class="n">is_positive_permissive</span> <span class="o">(`</span><span class="nc">Int</span> <span class="mi">0</span><span class="o">);;</span>
<span class="o">-</span> <span class="o">:</span> <span class="o">(</span><span class="kt">bool</span><span class="o">,</span> <span class="kt">string</span><span class="o">)</span> <span class="nn">Result</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="nc">Ok</span> <span class="bp">false</span>
<span class="o">#</span> <span class="n">is_positive_permissive</span> <span class="o">(`</span><span class="nc">Ratio</span> <span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="mi">4</span><span class="o">));;</span>
<span class="o">-</span> <span class="o">:</span> <span class="o">(</span><span class="kt">bool</span><span class="o">,</span> <span class="kt">string</span><span class="o">)</span> <span class="nn">Result</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="nc">Error</span> <span class="s2">&quot;Unknown number type&quot;</span>
</pre></div><p id="idp7571232">
        Catch-all cases are error-prone even with ordinary variants, but
        they are especially so with polymorphic variants. That's because
        you have no way of bounding what tags your function might have
        to deal with. Such code is particularly vulnerable to typos. For
        instance, if code that uses
        <code>is_positive_permissive</code> passes in
        <code>Float</code> misspelled as <code>Floot</code>,
        the erroneous code will compile without complaint.
      </p><div class="highlight"><pre><span class="o">#</span> <span class="n">is_positive_permissive</span> <span class="o">(`</span><span class="nc">Floot</span> <span class="mi">3</span><span class="o">.</span><span class="mi">5</span><span class="o">);;</span>
<span class="o">-</span> <span class="o">:</span> <span class="o">(</span><span class="kt">bool</span><span class="o">,</span> <span class="kt">string</span><span class="o">)</span> <span class="nn">Result</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="nc">Error</span> <span class="s2">&quot;Unknown number type&quot;</span>
</pre></div></aside><p id="idp7575296">
        Let's consider how we might turn our code into a proper library
        with an <code>mli</code>. Here's what the interface to
        this file might look like.
      </p><div class="highlight"><pre><span class="c">(* file: terminal_color.mli *)</span>

<span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">type</span> <span class="n">basic_color</span> <span class="o">=</span>
  <span class="o">[</span> <span class="o">`</span><span class="nc">Black</span>   <span class="o">|</span> <span class="o">`</span><span class="nc">Blue</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Cyan</span>  <span class="o">|</span> <span class="o">`</span><span class="nc">Green</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Magenta</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Red</span>  <span class="o">|</span> <span class="o">`</span><span class="nc">White</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Yellow</span> <span class="o">]</span>

<span class="k">type</span> <span class="n">color</span> <span class="o">=</span>
  <span class="o">[</span> <span class="o">`</span><span class="nc">Basic</span> <span class="k">of</span> <span class="n">basic_color</span> <span class="o">*</span> <span class="o">[</span> <span class="o">`</span><span class="nc">Bold</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Regular</span> <span class="o">]</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Gray</span> <span class="k">of</span> <span class="kt">int</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">RGB</span>  <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">]</span>

<span class="k">type</span> <span class="n">extended_color</span> <span class="o">=</span>
  <span class="o">[</span> <span class="n">color</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">RGBA</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">]</span>

<span class="k">val</span> <span class="n">color_to_int</span>          <span class="o">:</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="kt">int</span>
<span class="k">val</span> <span class="n">extended_color_to_int</span> <span class="o">:</span> <span class="n">extended_color</span> <span class="o">-&gt;</span> <span class="kt">int</span>
</pre></div><p id="idp7578128">
        Here, <code>extended_color</code> is defined as an
        explicit extension of <code>color</code>. Also, notice
        that we defined all of these types as exact variants. We can
        implement this library as follows.
      </p><div class="highlight"><pre><span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">type</span> <span class="n">basic_color</span> <span class="o">=</span>
  <span class="o">[</span> <span class="o">`</span><span class="nc">Black</span>   <span class="o">|</span> <span class="o">`</span><span class="nc">Blue</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Cyan</span>  <span class="o">|</span> <span class="o">`</span><span class="nc">Green</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Magenta</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Red</span>  <span class="o">|</span> <span class="o">`</span><span class="nc">White</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Yellow</span> <span class="o">]</span>

<span class="k">type</span> <span class="n">color</span> <span class="o">=</span>
  <span class="o">[</span> <span class="o">`</span><span class="nc">Basic</span> <span class="k">of</span> <span class="n">basic_color</span> <span class="o">*</span> <span class="o">[</span> <span class="o">`</span><span class="nc">Bold</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Regular</span> <span class="o">]</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Gray</span> <span class="k">of</span> <span class="kt">int</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">RGB</span>  <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">]</span>

<span class="k">type</span> <span class="n">extended_color</span> <span class="o">=</span>
  <span class="o">[</span> <span class="n">color</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">RGBA</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">]</span>

<span class="k">let</span> <span class="n">basic_color_to_int</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Black</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Red</span>     <span class="o">-&gt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Green</span> <span class="o">-&gt;</span> <span class="mi">2</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Yellow</span> <span class="o">-&gt;</span> <span class="mi">3</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Blue</span>  <span class="o">-&gt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Magenta</span> <span class="o">-&gt;</span> <span class="mi">5</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Cyan</span>  <span class="o">-&gt;</span> <span class="mi">6</span> <span class="o">|</span> <span class="o">`</span><span class="nc">White</span>  <span class="o">-&gt;</span> <span class="mi">7</span>

<span class="k">let</span> <span class="n">color_to_int</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Basic</span> <span class="o">(</span><span class="n">basic_color</span><span class="o">,</span><span class="n">weight</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">base</span> <span class="o">=</span> <span class="k">match</span> <span class="n">weight</span> <span class="k">with</span> <span class="o">`</span><span class="nc">Bold</span> <span class="o">-&gt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Regular</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
    <span class="n">base</span> <span class="o">+</span> <span class="n">basic_color_to_int</span> <span class="n">basic_color</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">RGB</span> <span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">g</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">36</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Gray</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="mi">232</span> <span class="o">+</span> <span class="n">i</span>

<span class="k">let</span> <span class="n">extended_color_to_int</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">RGBA</span> <span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">g</span><span class="o">,</span><span class="n">b</span><span class="o">,</span><span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">36</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">216</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Grey</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="mi">2000</span> <span class="o">+</span> <span class="n">x</span>
  <span class="o">|</span> <span class="o">(`</span><span class="nc">Basic</span> <span class="o">_</span> <span class="o">|</span> <span class="o">`</span><span class="nc">RGB</span> <span class="o">_</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Gray</span> <span class="o">_)</span> <span class="k">as</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="n">color_to_int</span> <span class="n">color</span>
</pre></div><p id="idp7582304">
        In the above code, we did something funny to the definition of
        <code>extended_color_to_int</code>, that underlines some
        of the downsides of polymorphic variants. In particular, we
        added some special-case handling for the color gray, rather than
        using <code>color_to_int</code>. Unfortunately, we
        misspelled <code>Gray</code> as <code>Grey</code>.
        This is exactly the kind of error that the compiler would catch
        with ordinary variants, but with polymorphic variants, this
        compiles without issue. All that happened was that the compiler
        inferred a wider type for
        <code>extended_color_to_int</code>, which happens to be
        compatible with the narrower type that was listed in the mli.
      </p><p id="idp7586480">
        If we add an explicit type annotation to the code itself (rather
        than just in the mli), then the compiler has enough information
        to warn us.
      </p><div class="highlight"><pre><span class="k">let</span> <span class="n">extended_color_to_int</span> <span class="o">:</span> <span class="n">extended_color</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">RGBA</span> <span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">g</span><span class="o">,</span><span class="n">b</span><span class="o">,</span><span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">36</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">216</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Grey</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="mi">2000</span> <span class="o">+</span> <span class="n">x</span>
  <span class="o">|</span> <span class="o">(`</span><span class="nc">Basic</span> <span class="o">_</span> <span class="o">|</span> <span class="o">`</span><span class="nc">RGB</span> <span class="o">_</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Gray</span> <span class="o">_)</span> <span class="k">as</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="n">color_to_int</span> <span class="n">color</span>
</pre></div><p id="idp7588224">
        In particular, the compiler will complain that the
        <code>`Grey</code> case as unused.
      </p><div class="highlight"><pre><span class="nc">File</span> <span class="s2">&quot;terminal_color.ml&quot;</span><span class="o">,</span> <span class="n">line</span> <span class="mi">29</span><span class="o">,</span> <span class="n">characters</span> <span class="mi">4</span><span class="o">-</span><span class="mi">11</span><span class="o">:</span>
<span class="nc">Warning</span> <span class="mi">11</span><span class="o">:</span> <span class="n">this</span> <span class="k">match</span> <span class="n">case</span> <span class="n">is</span> <span class="n">unused</span><span class="o">.</span>
</pre></div><p id="idp7590464">
        Once we have type definitions at our disposal, we can revisit
        the question of how we write the pattern-match that narrows the
        type. In particular, we can explicitly use the type name as part
        of the pattern match, by prefixing it with a
        <code>#</code>.
      </p><div class="highlight"><pre><span class="k">let</span> <span class="n">extended_color_to_int</span> <span class="o">:</span> <span class="n">extended_color</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">RGBA</span> <span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="n">g</span><span class="o">,</span><span class="n">b</span><span class="o">,</span><span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">36</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="mi">216</span>
  <span class="o">|</span> <span class="o">#</span><span class="n">color</span> <span class="k">as</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="n">color_to_int</span> <span class="n">color</span>
</pre></div><p id="idp7592944">
        This is useful when you want to narrow down to a type whose
        definition is long, and you don't want the verbosity of writing
        the tags down explicitly in the match.
      </p></section><section><h1 id="when-to-use-polymorphic-variants">When to use polymorphic variants</h1><p id="idp7594544">
        At first glance, polymorphic variants look like a strict
        improvement over ordinary variants. You can do everything that
        ordinary variants can do, plus it's more flexible and more
        concise. What's not to like?
      </p><p id="idp7595184">
        In reality, regular variants are the more pragmatic choice most
        of the time. That's because the flexibility of polymorphic
        variants comes at a price. Here are some of the downsides.
      </p><ul><li><p id="idp7596304">
<span><em>Complexity:</em></span> As we've seen, the typing
            rules for polymorphic variants are a lot more complicated
            than they are for regular variants. This means that heavy
            use of polymorphic variants can leave you scratching your
            head trying to figure out why a given piece of code did or
            didn't compile. It can also lead to absurdly long and hard
            to decode error messages.
          </p></li><li><p id="idp7597904">
<span><em>Error-finding:</em></span> Polymorphic variants are
            type-safe, but the typing discipline that they impose is, by
            dint of its flexibility, less likely to catch bugs in your
            program.
          </p></li><li><p id="idp7599280">
<span><em>Efficiency:</em></span> This isn't a huge effect,
            but polymorphic variants are somewhat heavier than regular
            variants, and OCaml can't generate code for matching on
            polymorphic variants that is quite as efficient as what is
            generated for regular variants.
          </p></li></ul><p id="idp7600608">
        All that said, polymorphic variants are still a useful and
        powerful feature, but it's worth understanding their
        limitations, and how to use them sensibly and modestly.
      </p><p id="idp7601200">
        Probably the safest and most common use-case for polymorphic
        variants is for cases where ordinary variants would be
        sufficient, but are syntactically too heavyweight. For example,
        you often want to create a variant type for encoding the inputs
        or outputs to a function, where it's not worth declaring a
        separate type for it. Polymorphic variants are very useful here,
        and as long as there are type annotations that constrain these
        to have explicit, exact types, this tends to work well.
      </p><p id="idp112288">
        Variants are most problematic exactly where you take full
        advantage of their power; in particular, when you take advantage
        of the ability of polymorphic variant types to overlap in the
        tags they support. This ties into OCaml's support for subtyping.
        As we'll discuss further when we cover objects in
        <a href="object-oriented-programming.html">Chapter 8, <i>Object Oriented Programming</i></a>,
        subtyping brings in a lot of complexity, and most of the time,
        that's complexity you want to avoid.
      </p></section></section>


                
            </article>
            
            
    
                <nav class="pagination">
                    
                        <a rel="previous" href="records.html">
                            &lt; Previous
                        </a>
                    
                    
                        <a rel="next" href="error-handling.html">
                            Next &gt;
                        </a>
                    
                </nav>
            
            
            
            <footer class="footer">
                <p>Copyright 2012-2013, Jason Hickey, Anil Madhavapeddy and Yaron Minsky.</p>
            </footer>
            
        </div>
    
    </body>

</html>