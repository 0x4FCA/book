<html>

    <head>
    
        <meta charset="utf-8"/>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta name="robots" content="NOINDEX, NOARCHIVE, NOFOLLOW"/>
        
        <title>Chapter 13. Command Line Parsing / Real World OCaml</title>
        
        <link rel="stylesheet" href="../../media/css/main.css"/>
        
        <script src="../../media/js/require.js" data-main="../../media/js/main.js"> </script>
        <script>
            require.config({
                config: {
                    gitHub: {
                        user: 'ocamllabs',
                        repo: 'rwo\u002Dcomments',
                        milestone: 'alpha4',
                        page: 'command\u002Dline\u002Dparsing.html'
                    }
                }
            });
        </script>
        
    
    </head>
    
    <body>
    
        <div class="body">
        
            <header class="header">
                <h1><img src="../../media/img/header.png" width="213" height="59" alt="Real World OCaml, by Jason Hickey, Anil Madhavapeddy and Yaron Minsky"/></h1>
            </header>
    
            <nav class="navigation">
                <ul>
                    <li>
                        <a href="index.html">Table of Contents</a>
                    </li>
                    
                        <li>
                            <a href="prologue.html">Prologue</a>
                            
                                
                            
                        </li>
                    
                        <li>
                            <a href="pt01.html">I. Basic Concepts</a>
                            
                                
                            
                        </li>
                    
                        <li>
                            <a href="pt02.html">II. Practical Examples</a>
                            
                                 
                                    <ul>
                                        
                                            <li>
                                                <a href="data-serialization-with-s-expressions.html">11. Data Serialization with S-Expressions</a>
                                            </li>
                                        
                                            <li>
                                                <a href="handling-json-data.html">12. Handling JSON data</a>
                                            </li>
                                        
                                            <li>
                                                <a href="command-line-parsing.html" class="here">13. Command Line Parsing</a>
                                            </li>
                                        
                                            <li>
                                                <a href="text-processing-and-unicode.html">14. Text Processing and Unicode</a>
                                            </li>
                                        
                                            <li>
                                                <a href="xml-streams-and-trees.html">15. XML Streams and Trees</a>
                                            </li>
                                        
                                            <li>
                                                <a href="concurrent-programming-with-async.html">16. Concurrent Programming with Async</a>
                                            </li>
                                        
                                            <li>
                                                <a href="fast-binary-serialization-with-bin_prot.html">17. Fast Binary Serialization</a>
                                            </li>
                                        
                                            <li>
                                                <a href="first-class-modules.html">18. Plugins with First-class Modules</a>
                                            </li>
                                        
                                    </ul>
                                
                            
                        </li>
                    
                        <li>
                            <a href="pt03.html">III. Advanced Topics</a>
                            
                                
                            
                        </li>
                    
                        <li>
                            <a href="installation.html">A. Installation</a>
                            
                                
                            
                        </li>
                    
                        <li>
                            <a href="packaging.html">B. Packaging</a>
                            
                                
                            
                        </li>
                    
                </ul>
            </nav>
        
            <article class="page">
        
                <h1>Chapter 13. Command Line Parsing</h1>
                
                

    <p id="idp9482976">
    Many of the OCaml programs you will write will end up as binaries
    that will be run directly from a command prompt. Any non-trivial
    program invoked as a command needs a few features:
  </p><ul><li><p id="idp9484080">
        program options and file inputs need to be parsed from the
        command line arguments.
      </p></li><li><p id="idp9484976">
        sensible error messages have to be generated in response to
        incorrect inputs.
      </p></li><li><p id="idp9485856">
        help needs to be shown for all the available options.
      </p></li><li><p id="idp9486704">
        interactive auto-completion of commands to assist the user.
      </p></li></ul><p id="idp9487440">
    Supporting all of this functionality manually is tedious and
    error-prone. Core provides the <code>Command</code> library
    that lets you declare your command-line options in one data
    structure, and the library takes care of parsing, help generation
    and auto-completion. Command is simple to use for smaller
    applications, and has a sophisticated sub-command mode that groups
    related commands together (you may be familiar with this style from
    <code>git</code> or <code>hg</code>).
  </p><p id="idp9490368">
    This chapter demonstrates how to use <code>Command</code> to
    extend the cryptographic utility from
    <a href="object-oriented-programming.html">Chapter 10, <i>Object Oriented Programming</i></a> and builds a
    simple equivalent to the <code>md5</code> and
    <code>shasum</code> utilities. It also demonstrates how
    <span><em>functional combinators</em></span> can be used to declare
    complex data structures in a type-safe and elegant way.
  </p><section><h1 id="basic-command-line-parsing">Basic command line parsing</h1><p id="idp9495392">
      We'll begin by cloning the <code>md5</code> binary that is
      present on most Linux distributions and Mac OS X. It reads in the
      contents of a file, applies the MD5 one-way hash function to the
      data, and outputs an ASCII hex representation of the result.
    </p><div class="highlight"><pre><span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">do_hash</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">open</span> <span class="nc">Cryptokit</span> <span class="k">in</span>
  <span class="nn">In_channel</span><span class="p">.</span><span class="n">read_all</span> <span class="n">file</span>
  <span class="o">|&gt;</span> <span class="n">hash_string</span> <span class="o">(</span><span class="nn">Hash</span><span class="p">.</span><span class="n">md5</span> <span class="bp">()</span><span class="o">)</span>
  <span class="o">|&gt;</span> <span class="n">transform_string</span> <span class="o">(</span><span class="nn">Hexa</span><span class="p">.</span><span class="n">encode</span> <span class="bp">()</span><span class="o">)</span>
  <span class="o">|&gt;</span> <span class="n">print_endline</span>

<span class="k">let</span> <span class="n">command</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span>
    <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Generate an MD5 hash of the input data&quot;</span>
    <span class="o">~</span><span class="n">readme</span><span class="o">:(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="s2">&quot;More detailed information&quot;</span><span class="o">)</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;filename&quot;</span> <span class="o">%:</span> <span class="kt">string</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">do_hash</span> <span class="n">file</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="n">run</span> <span class="n">command</span>
</pre></div><p id="idp9498144">
      The <code>do_hash</code> function accepts a filename
      parameter and prints the human-readable MD5 string to the console
      standard output. We want to control the inputs to this function
      via the command-line, and this is what the subsequent
      <code>command</code> value declares. If you compile this
      program and run it, the help screen looks like this:
    </p><pre id="idp9500304">
$ ./basic.byte
Generate an MD5 hash of the input data

  basic.byte filename

More detailed information

=== flags ===

  [-build-info]  print info about this build and exit
  [-version]     print the version of this build and exit
  [-help]        print this help text and exit
                 (alias: -?)

missing anonymous argument: filename
</pre><p id="idp9501328">
      If we invoke the binary without any arguments, it emits a help
      screen that informs you that a required argument
      <code>filename</code> is missing. Supplying the argument to
      the command results in <code>do_hash</code> being called,
      and the MD5 output being displayed to the standard output.
    </p><pre id="idp9503408">
$ ./basic.byte basic.byte
59562f5e4f790d16f1b2a095cd5de844
</pre><p id="idp9504144">
      So how does all this work? There are three parts to defining a
      command-line interface:
    </p><ul><li><p id="idp9505168">
<code>Command.Spec.t</code> defines the steps required
          to convert a command-line into an OCaml structure.
        </p></li><li><p id="idp9506736">
<code>Command.basic</code> takes a callback that is
          passed parameters parsed from the command-line according to
          the <code>spec</code> parameter. It takes a
          <code>summary</code> string for a one-line description
          of the command behavior, and an optional
          <code>readme</code> for longer help text.
        </p></li><li><p id="idp9510592">
<code>Command.run</code> actually executes a command and
          its specification, and runs the callback function with the
          resulting parameters.
        </p></li></ul><p id="idp9512080">
      Most of the interesting logic lies in how the specifications are
      defined. The <code>Command.Spec</code> module defines
      several combinators that can be chained together to define flags
      and anonymous arguments, what types they should map to, and
      whether to take special actions (such as interactive input) if
      certain fields are encountered.
    </p><div class="highlight"><pre><span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
  <span class="n">empty</span>
  <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;filename&quot;</span> <span class="o">%:</span> <span class="kt">string</span><span class="o">)</span>
<span class="o">)</span>
</pre></div><p id="idp9514640">
      We begin the specification above with an <code>empty</code>
      value, and then chain more parameters via the
      <code>+&gt;</code> combinator. Our example defines a single
      <span><em>anonymous</em></span> parameter via the
      <code>anon</code> function (that is, a standalone token from
      the command-line). Anonymous functions can be assigned a name that
      is used in help text, and an OCaml type that they are mapped to.
      The parameters specified here are all eventually passed to a
      callback function which actually invokes the program logic.
    </p><div class="highlight"><pre><span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">do_hash</span> <span class="n">file</span><span class="o">)</span>
</pre></div><p id="idp9519072">
      In our example, the function takes a <code>file</code>
      parameter that is a <code>string</code>, and maps it to the
      <code>do_hash</code> function. You aren't just limited to
      strings though, as <code>Command.Spec</code> defines several
      other conversion functions that validate and parse input into
      various types:
    </p><table><thead><tr><th>
              Argument type
            </th><th>
              OCaml type
            </th><th>
              Example
            </th></tr></thead><tbody><tr><td>
<code>string</code>
</td><td>
<code>string</code>
</td><td>
<code>foo</code>
</td></tr><tr><td>
<code>int</code>
</td><td>
<code>int</code>
</td><td>
<code>123</code>
</td></tr><tr><td>
<code>float</code>
</td><td>
<code>float</code>
</td><td>
<code>123.01</code>
</td></tr><tr><td>
<code>bool</code>
</td><td>
<code>bool</code>
</td><td>
<code>true</code>
</td></tr><tr><td>
<code>date</code>
</td><td>
<code>Date.t</code>
</td><td>
<code>2013-12-25</code>
</td></tr><tr><td>
<code>time_span</code>
</td><td>
<code>Span.t</code>
</td><td>
<code>5s</code>
</td></tr><tr><td>
<code>file</code>
</td><td>
<code>string</code>
</td><td>
<code>/etc/passwd</code>
</td></tr></tbody></table><p id="idp9552720">
      Anonymous arguments don't have to be declared individually. A more
      realistic <code>md5</code> function might also read from the
      standard input if a filename isn't specified. We can change our
      specification with a single line to reflect this by writing:
    </p><div class="highlight"><pre><span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
  <span class="n">empty</span>
  <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="n">maybe</span> <span class="o">(</span><span class="s2">&quot;filename&quot;</span> <span class="o">%:</span> <span class="kt">string</span><span class="o">))</span>
<span class="o">)</span>
</pre></div><p id="idp9555152">
      The anonymous parameter has been prefixed with a
      <code>maybe</code> that indicates the value is now optional.
      If you compile the example, you'll get a type error though:
    </p><pre id="idp9556432">
File &quot;basic_broken.ml&quot;, line 18, characters 26-30:
Error: This expression has type string option
       but an expression was expected of type string
Command exited with code 2.
</pre><p id="idp9557536">
      This is because the type of the callback function has changed. It
      now wants a <code>string option</code> instead of a
      <code>string</code> since the value is optional. We can
      quickly adapt our example to use the new information and read from
      standard input if no file is specified.
    </p><div class="highlight"><pre><span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">get_file_data</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">None</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;-&quot;</span> <span class="o">-&gt;</span> <span class="nn">In_channel</span><span class="p">.</span><span class="err">(</span><span class="n">input_all</span> <span class="n">stdin</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">file</span> <span class="o">-&gt;</span> <span class="nn">In_channel</span><span class="p">.</span><span class="n">read_all</span> <span class="n">file</span>

<span class="k">let</span> <span class="n">do_hash</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">open</span> <span class="nc">Cryptokit</span> <span class="k">in</span>
  <span class="n">get_file_data</span> <span class="n">file</span>
  <span class="o">|&gt;</span> <span class="n">hash_string</span> <span class="o">(</span><span class="nn">Hash</span><span class="p">.</span><span class="n">md5</span> <span class="bp">()</span><span class="o">)</span>
  <span class="o">|&gt;</span> <span class="n">transform_string</span> <span class="o">(</span><span class="nn">Hexa</span><span class="p">.</span><span class="n">encode</span> <span class="bp">()</span><span class="o">)</span>
  <span class="o">|&gt;</span> <span class="n">print_endline</span>

<span class="k">let</span> <span class="n">command</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span>
    <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Generate an MD5 hash of the input data&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="n">maybe</span> <span class="o">(</span><span class="s2">&quot;filename&quot;</span> <span class="o">%:</span> <span class="kt">string</span><span class="o">))</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">do_hash</span> <span class="n">file</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="n">run</span> <span class="n">command</span>
</pre></div><p id="idp9561520">
      There are several other transformations you can do on anonymous
      arguments. We've shown you <code>maybe</code>, and you can
      also obtain lists of arguments or supply default values. Try
      altering the example above to take a list of files and output
      checksums for all of them, just as the <code>md5</code>
      command does.
    </p><table><thead><tr><th>
              Anonymous argument
            </th><th>
              OCaml type
            </th></tr></thead><tbody><tr><td>
              sequence
            </td><td>
<code>list</code> of arguments
            </td></tr><tr><td>
              maybe
            </td><td>
<code>option</code> argument
            </td></tr><tr><td>
              maybe_with_default
            </td><td>
              argument with a default value if argument is missing
            </td></tr></tbody></table></section><section><h1 id="using-flags-to-label-the-command-line">Using flags to label the command line</h1><p id="idp9574160">
      You aren't just limited to anonymous arguments on the
      command-line, of course. Flags (such as <code>-v</code>) can
      be specified in the same manner as anonymous arguments. These can
      appear in any order on the command-line, or multiple times,
      depending on how they're declared. Let's add two arguments to our
      <code>md5</code> command that mimic the Linux version: a
      <code>-s</code> flag to specify the string to be hashed
      directly, and a <code>-t</code> self-benchmark test.
    </p><div class="highlight"><pre><span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
  <span class="n">empty</span>
  <span class="o">+&gt;</span> <span class="n">flag</span> <span class="s2">&quot;-s&quot;</span> <span class="o">(</span><span class="n">optional</span> <span class="kt">string</span><span class="o">)</span> <span class="o">~</span><span class="n">doc</span><span class="o">:</span><span class="s2">&quot;string Checksum the given string&quot;</span>
  <span class="o">+&gt;</span> <span class="n">flag</span> <span class="s2">&quot;-t&quot;</span> <span class="n">no_arg</span> <span class="o">~</span><span class="n">doc</span><span class="o">:</span><span class="s2">&quot; run a built-in time trial&quot;</span>
  <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="n">maybe</span> <span class="o">(</span><span class="s2">&quot;filename&quot;</span> <span class="o">%:</span> <span class="kt">string</span><span class="o">))</span>
<span class="o">)</span>
</pre></div><p id="idp9579072">
      The <code>flag</code> command is quite similar to
      <code>anon</code>. The first argument is the flag name, and
      aliases can be specified via an optional argument. The
      <code>doc</code> string should be formatted so that the
      first word is the short name that should appear in the usage text,
      with the remainder being the full help text. Notice that the
      <code>-t</code> flag has no argument, and so we prepend the
      doc text with a blank space. The help text for the above fragment
      looks like this:
    </p><pre id="idp9582768">
$ mlmd5 -s
Generate an MD5 hash of the input data

  mlmd5 [filename]

=== flags ===

  [-s string]    Checksum the given string
  [-t run]       a built-in time trial
  [-build-info]  print info about this build and exit
  [-version]     print the version of this build and exit
  [-help]        print this help text and exit
                 (alias: -?)

missing argument for flag -s

$ mlmd5 -s &quot;ocaml rocks&quot;
5a118fe92ac3b6c7854c595ecf6419cb
</pre><p id="idp9584240">
      The <code>-s</code> flag requires a
      <code>string</code> argument in our specification, and the
      parser outputs an error message if it isn't supplied. Here's a
      list of some of the functions that you can wrap flags in to
      control how they are parsed:
    </p><table><thead><tr><th>
              Flag function
            </th><th>
              OCaml type
            </th></tr></thead><tbody><tr><td>
<code>required</code> <span><em>arg</em></span>
</td><td>
<span><em>arg</em></span> and error if not present
            </td></tr><tr><td>
<code>optional</code> <span><em>arg</em></span>
</td><td>
<span><em>arg</em></span> <code>option</code>
</td></tr><tr><td>
<code>optional_with_default</code>
</td><td>
<span><em>arg</em></span> with a default if not present
            </td></tr><tr><td>
<code>listed</code> <span><em>arg</em></span>
</td><td>
<span><em>arg</em></span> <code>list</code>, flag may
              appear multiple times
            </td></tr><tr><td>
<code>no_arg</code>
</td><td>
<code>bool</code> that is true if flag is present.
            </td></tr></tbody></table><p id="idp9604560">
      The flags affect the type of the callback function in exactly the
      same way as anonymous arguments do. The full example of our
      <code>md5</code> function with flags is below.
    </p><div class="highlight"><pre><span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">get_file_data</span> <span class="n">file</span> <span class="n">checksum</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">file</span><span class="o">,</span> <span class="n">checksum</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="nc">Some</span> <span class="n">buf</span> <span class="o">-&gt;</span> <span class="n">buf</span>
  <span class="o">|</span> <span class="o">_,</span> <span class="nc">Some</span> <span class="n">buf</span> <span class="o">-&gt;</span> <span class="n">eprintf</span> <span class="s2">&quot;Warning: ignoring file</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span> <span class="n">buf</span>
  <span class="o">|</span> <span class="o">(</span><span class="nc">None</span><span class="o">|</span><span class="nc">Some</span> <span class="s2">&quot;-&quot;</span><span class="o">),</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nn">In_channel</span><span class="p">.</span><span class="err">(</span><span class="n">input_all</span> <span class="n">stdin</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">file</span><span class="o">,</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nn">In_channel</span><span class="p">.</span><span class="n">read_all</span> <span class="n">file</span>

<span class="k">let</span> <span class="n">do_hash</span> <span class="n">file</span> <span class="n">checksum</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">open</span> <span class="nc">Cryptokit</span> <span class="k">in</span>
  <span class="n">get_file_data</span> <span class="n">file</span> <span class="n">checksum</span>
  <span class="o">|&gt;</span> <span class="n">hash_string</span> <span class="o">(</span><span class="nn">Hash</span><span class="p">.</span><span class="n">md5</span> <span class="bp">()</span><span class="o">)</span>
  <span class="o">|&gt;</span> <span class="n">transform_string</span> <span class="o">(</span><span class="nn">Hexa</span><span class="p">.</span><span class="n">encode</span> <span class="bp">()</span><span class="o">)</span>
  <span class="o">|&gt;</span> <span class="n">print_endline</span>

<span class="k">let</span> <span class="n">command</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span>
    <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Generate an MD5 hash of the input data&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">flag</span> <span class="s2">&quot;-s&quot;</span> <span class="o">(</span><span class="n">optional</span> <span class="kt">string</span><span class="o">)</span> <span class="o">~</span><span class="n">doc</span><span class="o">:</span><span class="s2">&quot;string Checksum the given string&quot;</span>
      <span class="o">+&gt;</span> <span class="n">flag</span> <span class="s2">&quot;-t&quot;</span> <span class="n">no_arg</span> <span class="o">~</span><span class="n">doc</span><span class="o">:</span><span class="s2">&quot;run a built-in time trial&quot;</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="n">maybe</span> <span class="o">(</span><span class="s2">&quot;filename&quot;</span> <span class="o">%:</span> <span class="kt">string</span><span class="o">))</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">checksum</span> <span class="n">trial</span> <span class="n">file</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="k">match</span> <span class="n">trial</span> <span class="k">with</span>
    <span class="o">|</span> <span class="bp">true</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;Running time trial</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">|</span> <span class="bp">false</span> <span class="o">-&gt;</span> <span class="n">do_hash</span> <span class="n">file</span> <span class="n">checksum</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="n">run</span> <span class="n">command</span>
</pre></div><p id="idp9607824">
      Notice how the <code>get_file_data</code> function now
      pattern matches across the <code>checksum</code> flag and
      the <code>file</code> anonymous argument. It selects the
      flag in preference to the file argument, but emits a warning if
      there's ambiguity.
    </p></section><section><h1 id="grouping-sub-commands-together">Grouping sub-commands together</h1><p id="idp9611824">
      You can get pretty far by combining flags and anonymous arguments
      to assemble complex command-line interfaces. After a while though,
      too many options can make the program very confusing for newcomers
      to your application. One way to solve this is by grouping common
      operations together and adding some hierarchy to the command-line
      interface.
    </p><p id="idp9612608">
      You'll have run across this style already when using the OPAM
      package manager (or, in the non-OCaml world, the Git or Mercurial
      commands). OPAM exposes commands in this form:
    </p><pre id="idp9613200">
opam config env
opam remote list -kind git
opam install --help
opam install xmlm
</pre><p id="idp9613952">
      The <code>config</code>, <code>remote</code> and
      <code>install</code> keywords form a logical grouping of
      commands, and factor out flags and arguments that are specific to
      that particular operation. It's really simple to extend your
      application to do this in Command: just swap
      <code>Command.basic</code> for
      <code>Command.group</code>:
    </p><div class="highlight"><pre><span class="k">val</span> <span class="n">group</span> <span class="o">:</span>
  <span class="n">summary</span><span class="o">:</span><span class="kt">string</span> <span class="o">-&gt;</span>
  <span class="o">?</span><span class="n">readme</span><span class="o">:(</span><span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">string</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="o">(</span><span class="kt">string</span> <span class="o">*</span> <span class="n">t</span><span class="o">)</span> <span class="kt">list</span> <span class="o">-&gt;</span> <span class="n">t</span>
</pre></div><p id="idp9619280">
      The <code>group</code> signature accepts a list of basic
      <code>Command.t</code> values and their corresponding names.
      When executed, it looks for the appropriate sub-command from the
      name list, and dispatches it to the right command handler.
    </p><p id="idp9621328">
      Let's build the beginning of a calendar toool that does a few
      operations over dates from the command line. We first define a
      command that adds days to an input date and prints the resulting
      date.
    </p><div class="highlight"><pre><span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">add</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span>
    <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Add [days] to the [base] date and print day&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;base&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;days&quot;</span> <span class="o">%:</span> <span class="kt">int</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">base</span> <span class="n">span</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="nn">Date</span><span class="p">.</span><span class="n">add_days</span> <span class="n">base</span> <span class="n">span</span>
    <span class="o">|&gt;</span> <span class="nn">Date</span><span class="p">.</span><span class="n">to_string</span>
    <span class="o">|&gt;</span> <span class="n">print_endline</span>
  <span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="n">run</span> <span class="n">add</span>
</pre></div><p id="idp9623600">
      Once we've tested this and made sure it works, we can define
      another command that takes the difference of two dates. Both of
      the commands are now grouped as sub-commands using
      <code>Command.group</code>.
    </p><div class="highlight"><pre><span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">add</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span> <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Add [days] to the [base] date&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;base&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;days&quot;</span> <span class="o">%:</span> <span class="kt">int</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">base</span> <span class="n">span</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="nn">Date</span><span class="p">.</span><span class="n">add_days</span> <span class="n">base</span> <span class="n">span</span>
    <span class="o">|&gt;</span> <span class="nn">Date</span><span class="p">.</span><span class="n">to_string</span>
    <span class="o">|&gt;</span> <span class="n">print_endline</span>
  <span class="o">)</span>

<span class="k">let</span> <span class="n">diff</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span> <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Show days between [date1] and [date2]&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;date1&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;date2&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">date1</span> <span class="n">date2</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="nn">Date</span><span class="p">.</span><span class="n">diff</span> <span class="n">date1</span> <span class="n">date2</span>
    <span class="o">|&gt;</span> <span class="n">printf</span> <span class="s2">&quot;%d days</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="o">)</span>

<span class="k">let</span> <span class="n">command</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">group</span> <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Manipulate dates&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;add&quot;</span><span class="o">,</span> <span class="n">add</span><span class="o">;</span> <span class="s2">&quot;diff&quot;</span><span class="o">,</span> <span class="n">diff</span> <span class="o">]</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="n">run</span> <span class="n">command</span>
</pre></div><p id="idp9626560">
      And that's all you need to add sub-command support! The help page
      for our calendar now reflects the two commands we just added:
    </p><pre id="idp9627104">
$ cal
Manipulate dates

  cal SUBCOMMAND

=== subcommands ===

  add      Add [days] to the [base] date
  diff     Show days between [date1] and [date2]
  version  print version information
  help     explain a given subcommand (perhaps recursively)

missing subcommand for command cal
</pre><p id="idp9628064">
      We can invoke the two commands we just defined to verify that they
      work and see the date parsing in action.
    </p><pre id="idp9628592">
$ cal add 2012-12-25 40
2013-02-03
$ cal diff 2012-12-25 2012-11-01
54 days
</pre></section><section><h1 id="advanced-control-over-parsing">Advanced control over parsing</h1><p id="idp9630672">
      The use of the spec combinators has been somewhat magic so far: we
      just build them up with the '+&gt;' combinator and things seem to
      work. As your programs get larger and more complex, you'll want to
      factor out common functionality between specifications. Some other
      times, you'll need to interrupt the parsing to perform special
      processing, such as requesting an interactive passphrase from the
      user before proceeding. We'll show you some new combinators that
      let you do this now.
    </p><section><h1><b>
    The types behind <code>Command.Spec</code>
</b></h1><p id="idp9633728">
      The Command module's safety relies on the specification's output
      values precisely matching the callback function which invokes the
      main program. Any mismatch here will inevitably result in a
      dynamic failure, and so Command uses some interesting type
      abstraction to guarantee they remain in sync. You don't have to
      understand this section to use the more advanced combinators, but
      it'll help you debug type errors as you use
      <code>Command</code> more.
    </p><p id="idp9635328">
      The type of <code>Command.t</code> looks deceptively simple:
    </p><div class="highlight"><pre><span class="k">type</span> <span class="o">(</span><span class="k">'</span><span class="n">main_in</span><span class="o">,</span> <span class="k">'</span><span class="n">main_out</span><span class="o">)</span> <span class="n">t</span>
</pre></div><p id="idp9637456">
      You can think of <code>('a, 'b) t</code> as a function of
      type <code>'a -&gt; 'b</code>, but embellished with
      information about:
    </p><ul><li><p id="idp9639888">
          how to parse the command line
        </p></li><li><p id="idp9640720">
          what the command does and how to call it
        </p></li><li><p id="idp9641568">
          how to auto-complete a partial command line
        </p></li></ul><p id="idp9642288">
      The type of a specification transforms a
      <code>'main_in</code> to a <code>'main_out</code>
      value. For instance, a value of <code>Spec.t</code> might
      have type:
    </p><div class="highlight"><pre><span class="o">(</span><span class="n">arg1</span> <span class="o">-&gt;</span> <span class="o">...</span> <span class="o">-&gt;</span> <span class="n">argN</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">r</span><span class="o">,</span> <span class="k">'</span><span class="n">r</span><span class="o">)</span> <span class="nn">Spec</span><span class="p">.</span><span class="n">t</span>
</pre></div><p id="idp9645920">
      Such a value transforms a main function of type
      <code>arg1 -&gt; ... -&gt; argN -&gt; 'r</code> by supplying
      all the argument values, leaving a main function that returns a
      value of type <code>'r</code>. Let's look at some examples
      of specs, and their types:
    </p><div class="highlight"><pre><span class="o">#</span> <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="n">empty</span> <span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="o">(</span><span class="k">'</span><span class="n">m</span><span class="o">,</span> <span class="k">'</span><span class="n">m</span><span class="o">)</span> <span class="nn">Spec</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">abstr</span><span class="o">&gt;</span>
<span class="o">#</span> <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span><span class="n">empty</span> <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;foo&quot;</span> <span class="o">%:</span> <span class="kt">int</span><span class="o">))</span> <span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="o">(</span><span class="kt">int</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="o">_</span><span class="n">a</span><span class="o">,</span> <span class="k">'</span><span class="o">_</span><span class="n">a</span><span class="o">)</span> <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">abstr</span><span class="o">&gt;</span>
</pre></div><p id="idp9649152">
      The empty specification is simple as it doesn't add any parameters
      to the callback type. The second example adds an
      <code>int</code> anonymous parameter that is reflected in
      the inferred type. Notice that the return value of this fragment
      has been inferred to be <code>'_a</code> instead of the
      usual <code>'a</code>. The underscore denotes a
      <span><em>weakly polymorphic type</em></span> which cannot be
      generalized further. You should never see this in normal use, but
      you may encounter this if you define specifications in the
      top-level of a module. You can work around this so-called
      <span><em>value restriction</em></span> by moving the definitions
      under a <code>let</code> binding.
    </p><p id="idp9653728">
      One forms a command by combining a spec of type
      <code>('main, unit) Spec.t</code> with a main function of
      type <code>'main</code>. All the combinators we've shown so
      far incrementally build up the type of <code>'main</code>
      according to the command-line parameters it expects, so the
      resulting type of <code>'main</code> is something like:
    </p><div class="highlight"><pre><span class="n">arg1</span> <span class="o">-&gt;</span> <span class="o">...</span> <span class="o">-&gt;</span> <span class="n">argN</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
</pre></div><p id="idp9658240">
      The type of <code>Command.basic</code> should make more
      sense now:
    </p><div class="highlight"><pre><span class="k">val</span> <span class="n">basic</span> <span class="o">:</span>
  <span class="n">summary</span><span class="o">:</span><span class="kt">string</span> <span class="o">-&gt;</span>
  <span class="o">?</span><span class="n">readme</span><span class="o">:(</span><span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">string</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="o">(</span><span class="k">'</span><span class="n">main</span><span class="o">,</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="nn">Spec</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">main</span> <span class="o">-&gt;</span> <span class="n">t</span>
</pre></div><p id="idp9660496">
      The final line is the important one. It shows that the callback
      function for a spec should consume identical arguments to the
      supplied <code>main</code> function, except that there is an
      additional <code>unit</code> argument. This final
      <code>unit</code> is there in case there are no command-line
      arguments, as at least one parameter is required for the callback.
      That's why you have to supply an additional <code>()</code>
      to the callback function in the previous examples.
    </p></section><section><h1 id="composing-specification-fragments-together">Composing specification fragments together</h1><p id="idp9665456">
        If you want to factor out common command-line operations, the
        <code>++</code> operator will append two specifications
        together. Let's add some dummy verbosity and debug flags to our
        calendar application to illustrate this.
      </p><div class="highlight"><pre><span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">add</span> <span class="o">~</span><span class="n">common</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span> <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Add [days] to the [base] date&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;base&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;days&quot;</span> <span class="o">%:</span> <span class="kt">int</span><span class="o">)</span>
      <span class="o">++</span> <span class="n">common</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">base</span> <span class="n">span</span> <span class="n">debug</span> <span class="n">verbose</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="nn">Date</span><span class="p">.</span><span class="n">add_days</span> <span class="n">base</span> <span class="n">span</span>
    <span class="o">|&gt;</span> <span class="nn">Date</span><span class="p">.</span><span class="n">to_string</span>
    <span class="o">|&gt;</span> <span class="n">print_endline</span>
  <span class="o">)</span>

<span class="k">let</span> <span class="n">diff</span> <span class="o">~</span><span class="n">common</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span> <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Show days between [date2] and [date1]&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;date1&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;date2&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">++</span> <span class="n">common</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">date1</span> <span class="n">date2</span> <span class="n">debug</span> <span class="n">verbose</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="nn">Date</span><span class="p">.</span><span class="n">diff</span> <span class="n">date1</span> <span class="n">date2</span>
    <span class="o">|&gt;</span> <span class="n">printf</span> <span class="s2">&quot;%d days</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="o">)</span>
</pre></div><p id="idp9668544">
        The definitions of the specifications are very similar to the
        earlier example, except that they append a
        <code>common</code> parameter after each specification. We
        can supply these flags when defining the groups:
      </p><pre id="idp9669872">
let () =
  let common =
    Command.Spec.(
      empty
      +&gt; flag &quot;-d&quot; (optional_with_default false bool) ~doc:&quot; Debug mode&quot;
      +&gt; flag &quot;-v&quot; (optional_with_default false bool) ~doc:&quot; Verbose output&quot;
    )
  in
  List.map ~f:(fun (name, cmd) -&gt; (name, cmd ~common))
    [ &quot;add&quot;, add; &quot;diff&quot;, diff ]
  |&gt; Command.group ~summary:&quot;Manipulate dates&quot;
  |&gt; Command.run
</pre><p id="idp9671152">
        Both of these flags will now be applied and passed to all the
        callback functions. This makes code refactoring a breeze by
        using the compiler to spot places where you use commands. Just
        add a parameter to the common definition, run the compiler, and
        fix type errors until everything works again.
      </p><p id="idp9671888">
        For example, if we remove the <code>verbose</code> flag
        above and compile, we'll get this impressively long type error:
      </p><div class="highlight"><pre><span class="nc">File</span> <span class="s2">&quot;cal_compose_error.ml&quot;</span><span class="o">,</span> <span class="n">line</span> <span class="mi">39</span><span class="o">,</span> <span class="n">characters</span> <span class="mi">38</span><span class="o">-</span><span class="mi">45</span><span class="o">:</span>
<span class="nc">Error</span><span class="o">:</span> <span class="nc">This</span> <span class="n">expression</span> <span class="n">has</span> <span class="k">type</span>
         <span class="o">(</span><span class="kt">bool</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">,</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span>
         <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span>
           <span class="o">(</span><span class="kt">bool</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">,</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span>
           <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="n">t</span>
       <span class="n">but</span> <span class="n">an</span> <span class="n">expression</span> <span class="n">was</span> <span class="n">expected</span> <span class="k">of</span> <span class="k">type</span>
         <span class="o">(</span><span class="kt">bool</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">,</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="n">t</span>
           <span class="o">=</span> <span class="o">(</span><span class="kt">bool</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">,</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="n">t</span>
       <span class="nc">Type</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="n">is</span> <span class="n">not</span> <span class="n">compatible</span> <span class="k">with</span> <span class="k">type</span> <span class="kt">unit</span>
</pre></div><p id="idp9674832">
        While this does look scary, the key line to scan is the last
        one, where it's telling you that you have supplied too many
        arguments in the callback function
        (<code>unit -&gt; unit</code> vs <code>unit</code>).
        If you started with a working program and made this single
        change, you typically don't even need to read the type error, as
        the filename and location information is sufficient to make the
        obvious fix.
      </p></section><section><h1 id="prompting-for-interactive-input">Prompting for interactive input</h1><p id="idp9678416">
        The <code>step</code> combinator lets you control the
        normal course of parsing by supplying a function that maps
        callback arguments to a new set of values. For instance, let's
        suppose we want our first calendar application to prompt for the
        number of days to add if a value wasn't supplied on the
        command-line.
      </p><div class="highlight"><pre><span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">add</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span>
    <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Add [days] to the [base] date and print day&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">step</span> <span class="o">(</span><span class="k">fun</span> <span class="n">m</span> <span class="n">base</span> <span class="n">days</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">days</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="n">days</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="n">base</span> <span class="n">days</span>
        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
            <span class="n">print_endline</span> <span class="s2">&quot;enter days: &quot;</span><span class="o">;</span>
            <span class="n">m</span> <span class="n">base</span> <span class="o">(</span><span class="n">read_int</span> <span class="bp">()</span><span class="o">)</span>
      <span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;base&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="n">maybe</span> <span class="o">(</span><span class="s2">&quot;days&quot;</span> <span class="o">%:</span> <span class="kt">int</span><span class="o">))</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">base</span> <span class="n">span</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="nn">Date</span><span class="p">.</span><span class="n">add_days</span> <span class="n">base</span> <span class="n">span</span>
    <span class="o">|&gt;</span> <span class="nn">Date</span><span class="p">.</span><span class="n">to_string</span>
    <span class="o">|&gt;</span> <span class="n">print_endline</span>
  <span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="n">run</span> <span class="n">add</span>
</pre></div><p id="idp9681488">
        There are two main changes from the simple example that accepts
        a date and an integer. Firstly, the <code>days</code>
        argument is now an optional integer instead of a required
        argument. The <code>step</code> combinator takes the date
        and days parameters, and interactively reads an integer if no
        day value was supplied. It then returns an
        <code>int</code> instead of the
        <code>int option</code> that was passed in.
      </p><pre id="idp9685104">
$ cal_add_interactive 2013-12-01
enter days:
35
2014-01-05
</pre><p id="idp9685840">
        Notice that the &quot;program logic&quot; in the final callback
        doesn't see any of this, and is exactly the same as in our
        original version. The <code>step</code> combinator has
        transformed an <code>int option</code> argument into an
        <code>int</code>. This is reflected in the type of the
        specification:
      </p><div class="highlight"><pre><span class="o">#</span> <span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span> <span class="o">;;</span>
<span class="o">#</span> <span class="k">open</span> <span class="nn">Command</span><span class="p">.</span><span class="nc">Spec</span> <span class="o">;;</span>
<span class="o">#</span> <span class="n">step</span> <span class="o">(</span><span class="k">fun</span> <span class="n">m</span> <span class="o">(</span><span class="n">base</span><span class="o">:</span><span class="nn">Date</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="n">days</span> <span class="o">-&gt;</span>
  <span class="k">match</span> <span class="n">days</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">days</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="n">base</span> <span class="n">days</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
     <span class="n">print_endline</span> <span class="s2">&quot;enter days: &quot;</span><span class="o">;</span>
     <span class="n">m</span> <span class="n">base</span> <span class="o">(</span><span class="n">read_int</span> <span class="bp">()</span><span class="o">));;</span>
<span class="o">-</span> <span class="o">:</span> <span class="o">(</span><span class="nn">Date</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="o">_</span><span class="n">a</span><span class="o">,</span> <span class="nn">Date</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="o">_</span><span class="n">a</span><span class="o">)</span> <span class="nn">Spec</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">abstr</span><span class="o">&gt;</span>
</pre></div><p id="idp9690064">
        The first half of the <code>Spec.t</code> shows that the
        callback type is <code>Date.t -&gt; int</code>, whereas
        the resulting value that is expected from the next specification
        in the chain is a <code>Date.t -&gt; int option</code>.
      </p></section><section><h1 id="adding-labelled-arguments-to-callbacks">Adding labelled arguments to callbacks</h1><p id="idp9694096">
        The <code>step</code> chaining combinator lets you control
        the types of your callbacks very easily. This can either help
        you fit in with existing interfaces, or make things more
        explicit by adding labelled arguments.
      </p><div class="highlight"><pre><span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">add</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span>
    <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Add [days] to the [base] date and print day&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">step</span> <span class="o">(</span><span class="k">fun</span> <span class="n">m</span> <span class="n">base</span> <span class="n">days</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="o">~</span><span class="n">base</span> <span class="o">~</span><span class="n">days</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;base&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;days&quot;</span> <span class="o">%:</span> <span class="kt">int</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="o">~</span><span class="n">base</span> <span class="o">~</span><span class="n">days</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="nn">Date</span><span class="p">.</span><span class="n">add_days</span> <span class="n">base</span> <span class="n">days</span>
    <span class="o">|&gt;</span> <span class="nn">Date</span><span class="p">.</span><span class="n">to_string</span>
    <span class="o">|&gt;</span> <span class="n">print_endline</span>
  <span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="n">run</span> <span class="n">add</span>
</pre></div><p id="idp9697120">
        This example goes back to our non-interactive calendar addition
        program, but adds a <code>step</code> combinator to turn
        the normal arguments into labelled ones. This is reflected in
        the callback function below, and can help prevent errors with
        command-line arguments with similar types but different names.
      </p></section></section><section><h1 id="command-line-auto-completion-with-bash">Command-line auto-completion with
    <code>bash</code></h1><p id="idp9700512">
      Modern UNIX shells usually have a tab-completion feature to
      interactively help you figure out how to build a command-line.
      These work by pressing the <code>&lt;tab&gt;</code> key in
      the middle of typing a command, and seeing the options that pop
      up. You've probably used this most often to find the files in the
      current directory, but it can actually be extended for other parts
      of the command too.
    </p><p id="idp9702048">
      The precise mechanism for autocompletion varies depending on what
      shell you are using, but we'll assume you are using the most
      common one: <code>bash</code>. This is the default
      interactive shell on most Linux distributions and Mac OS X, but
      you may need to switch to it on *BSD or Windows (when using
      Cygwin). The rest of this section assumes that you're using
      <code>bash</code>.
    </p><p id="idp9704256">
      Bash autocompletion isn't always installed by default, so check
      your OS package manager to see if you have it available.
    </p><table><thead><tr><th>
              Operating System
            </th><th>
              Package Manager
            </th><th>
              Package
            </th></tr></thead><tbody><tr><td>
              Debian Linux
            </td><td>
<code>apt</code>
</td><td>
<code>TODO</code>
</td></tr><tr><td>
              CentOS
            </td><td>
<code>yum</code>
</td><td>
<code>TODO</code>
</td></tr><tr><td>
              Mac OS X
            </td><td>
              Homebrew
            </td><td>
<code>bash-completion</code>
</td></tr><tr><td>
              Mac OS X
            </td><td>
              MacPorts
            </td><td>
<code>TODO</code>
</td></tr><tr><td>
              FreeBSD
            </td><td>
              Ports System
            </td><td>
<code>/usr/ports TODO</code>
</td></tr><tr><td>
              OpenBSD
            </td><td>
<code>pkg_add</code>
</td><td>
<code>TODO</code>
</td></tr></tbody></table><p id="idp9725776">
      Once you have bash completion installed and configured, check that
      it works by typing the <code>ssh</code> command, and
      pressing <code>tab</code>. This should show you the list of
      known hosts from your <code>~/.ssh/known_hosts</code> file.
      If it lists those, then you can continue on, but if it lists the
      files in your current directory instead, then check your OS
      documentation to configure completion correctly.
    </p><p id="idp9728720">
      One last bit of information you'll need to find is the location of
      the <code>bash_completion.d</code> directory. This is where
      all the shell fragments that contain the completion logic are
      held. On Linux, this is often in
      <code>/etc/bash_completion.d</code>, and in Homebrew on Mac
      OS X it would be
      <code>/usr/local/etc/bash_completion.d</code> by default.
    </p><section><h1 id="generating-completion-fragments-from-command">Generating completion fragments from Command</h1><p id="idp9732736">
        The Command library has a declarative description of all the
        possible valid options, and it can use this information to
        generate a shell script which provides completion support for
        that command. To generate the fragment, just run the command
        with the <code>COMMAND_OUTPUT_INSTALLATION_BASH</code>
        environment variable set to any value.
      </p><p id="idp9734192">
        For example, let's try it on our calendar example from earlier,
        assuming that the binary is called <code>cal</code> in the
        current directory:
      </p><pre id="idp9735472">
$ COMMAND_OUTPUT_INSTALLATION_BASH=1 ./cal

function _jsautocom_41790 {
  export COMP_CWORD
  COMP_WORDS[0]=./cal
  COMPREPLY=($(&quot;${COMP_WORDS[@]}&quot;))
}
complete -F _jsautocom_41790 ./cal
</pre></section><section><h1 id="installing-the-completion-fragment">Installing the completion fragment</h1><p id="idp9737680">
        You don't need to worry about what this script actually does
        (unless you have an unhealthy fascination with shell scripting,
        that is). Instead, redirect the output to a file in your
        <code>bash_completion.d</code> directory, named after the
        command you're installing.
      </p><pre id="idp9739056">
$ sudo env COMMAND_OUTPUT_INSTALLATION_BASH=1 ./cal \
    &gt; /etc/bash_completion.d/cal
$ bash -l
$ ./cal &lt;tab&gt;
add      diff     help     version
</pre><p id="idp9740048">
        The first line above redirects the earlier output into your
        <code>bash_completion.d</code> directory. The
        <code>bash -l</code> loads the new configuration as a
        fresh login shell, and then the final line shows the four valid
        commands by pressing the tab key.
      </p><p id="idp9742128">
        Command completion support works for flags and grouped commands,
        and is very useful when building larger command-line interfaces.
      </p><aside class="note"><h1>
      Installing a generic completion handler
      </h1><p id="idp9743392">
        Sadly, <code>bash</code> doesn't support installing a
        generic handler for all Command-based applications. This means
        that you have to install the completion script for every
        application, but you should be able to automate this in the
        build and packaging system for your application.
      </p><p id="idp9744816">
        It will help to check out how other applications that install
        tab-completion scripts and following their lead, as the details
        are very OS-specific.
      </p></aside></section></section>


                
            </article>
            
            
    
                <nav class="pagination">
                    
                        <a rel="previous" href="handling-json-data.html">
                            &lt; Previous
                        </a>
                    
                    
                        <a rel="next" href="text-processing-and-unicode.html">
                            Next &gt;
                        </a>
                    
                </nav>
            
            
            
            <footer class="footer">
                <p>Copyright 2012-2013, Jason Hickey, Anil Madhavapeddy and Yaron Minsky.</p>
            </footer>
            
        </div>
    
    </body>

</html>