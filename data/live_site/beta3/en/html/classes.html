<!DOCTYPE html>
<html>

    <head>
    
        <meta charset="utf-8"/>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta name="robots" content="NOINDEX, NOARCHIVE, NOFOLLOW"/>
        
        <title>Chapter 12. Classes / Real World OCaml</title>
        
        <link rel="stylesheet" href="../../media/css/main.css"/>
        
        <script src="../../media/js/require.js" data-main="../../media/js/main.js"> </script>
        <script>
            require.config({
                config: {
                    gitHub: {
                        user: 'ocamllabs',
                        repo: 'rwo\u002Dcomments',
                        milestone: 'beta3',
                        page: 'classes.html'
                    }
                }
            });
        </script>
        
    
    </head>
    
    <body>
    
        <div class="body">
        
            <header class="header">
                <h1><img src="../../media/img/header.png" width="213" height="59" alt="Real World OCaml, by Jason Hickey, Anil Madhavapeddy and Yaron Minsky"/></h1>
            </header>
    
            <nav class="navigation">
                <ul>
                    <li>
                        <a href="index.html">Table of Contents</a>
                    </li>
                    
                        <li>
                            <a href="prologue.html">Prologue</a>
                            
                                
                            
                        </li>
                    
                        <li>
                            <a href="pt01.html">I. Language Concepts</a>
                            
                                 
                                    <ul>
                                        
                                            <li>
                                                <a href="a-guided-tour.html">1. A Guided Tour</a>
                                            </li>
                                        
                                            <li>
                                                <a href="variables-and-functions.html">2. Variables and Functions</a>
                                            </li>
                                        
                                            <li>
                                                <a href="lists-and-patterns.html">3. Lists and Patterns</a>
                                            </li>
                                        
                                            <li>
                                                <a href="files-modules-and-programs.html">4. Files, Modules and Programs</a>
                                            </li>
                                        
                                            <li>
                                                <a href="records.html">5. Records</a>
                                            </li>
                                        
                                            <li>
                                                <a href="variants.html">6. Variants</a>
                                            </li>
                                        
                                            <li>
                                                <a href="error-handling.html">7. Error Handling</a>
                                            </li>
                                        
                                            <li>
                                                <a href="imperative-programming-1.html">8. Imperative Programming</a>
                                            </li>
                                        
                                            <li>
                                                <a href="functors.html">9. Functors</a>
                                            </li>
                                        
                                            <li>
                                                <a href="first-class-modules.html">10. First-Class Modules</a>
                                            </li>
                                        
                                            <li>
                                                <a href="objects.html">11. Objects</a>
                                            </li>
                                        
                                            <li>
                                                <a href="classes.html" class="here">12. Classes</a>
                                            </li>
                                        
                                    </ul>
                                
                            
                        </li>
                    
                        <li>
                            <a href="pt02.html">II. Tools and Techniques</a>
                            
                                
                            
                        </li>
                    
                        <li>
                            <a href="pt03.html">III. The Runtime System</a>
                            
                                
                            
                        </li>
                    
                        <li>
                            <a href="installation.html">A. Installation</a>
                            
                                
                            
                        </li>
                    
                </ul>
            </nav>
        
            <article class="page">
        
                <h1>Chapter 12. Classes</h1>
                
                

    <p id="idp9466240">
    Programming with objects directly is great for encapsulation, but
    one of the main goals of object-oriented programming is code re-use
    through inheritance. For inheritance, we need to introduce
    <span><em>classes</em></span>. In object-oriented programming, a
    class is a &quot;recipe&quot; for creating objects. The recipe can
    be changed by adding new methods and fields, or it can be changed by
    modifying existing methods.
  </p><section><h1 id="ocaml-classes">OCaml classes</h1><p id="idp9468928">
      In OCaml, class definitions must be defined as toplevel statements
      in a module. The syntax for a class definition uses the keyword
      <code>class</code>.
    </p><div class="rwocode"><pre><code># <span class="keyword4">class</span> istack <span class="keyword2">=</span> <span class="keyword4">object</span>
    <span class="keyword4">val</span> <span class="keyword1">mutable</span> v <span class="keyword2">=</span> <span class="keyword2">[</span><span class="keyword8">0</span><span class="keyword2">;</span> <span class="keyword8">2</span><span class="keyword2">]</span>

    <span class="keyword4">method</span> pop <span class="keyword2">=</span>
      <span class="keyword1">match</span> v <span class="keyword1">with</span>
      <span class="keyword2">|</span> hd <span class="keyword2">:</span><span class="keyword2">:</span> tl -<span class="keyword2">&gt;</span>
          v <span class="keyword2">&lt;</span>- tl<span class="keyword2">;</span>
          <span class="keyword6">Some </span>hd
      <span class="keyword2">|</span> <span class="keyword2">[</span><span class="keyword2">]</span> -<span class="keyword2">&gt;</span> <span class="keyword6">None
</span>
    <span class="keyword4">method</span> push hd <span class="keyword2">=</span>
      v <span class="keyword2">&lt;</span>- hd <span class="keyword2">:</span><span class="keyword2">:</span> v
  <span class="keyword4">end</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">class istack :
  object
    val mutable v : int list
    method pop : int option
    method push : int -&gt; unit
  end
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/istack.topscript">classes/istack.topscript</a>  ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9470912">
      The <code>class istack : object ... end</code> result shows
      that we have created a class <code>istack</code> with
      <span><em>class type</em></span> <code>object ... end</code>.
      Like module types, class types are completely separate from
      regular OCaml types (e.g. <code>int</code>,
      <code>string</code>, <code>list</code>) and, in
      particular, should not be confused with object types (e.g.
      <code>&lt; get : int; .. &gt;</code>). The class type
      describes the class itself rather than the objects that the class
      creates. This particular class type specifies that the
      <code>istack</code> class defines a mutable field
      <code>v</code>, a method <code>pop</code> that returns
      an <code>int option</code>, and a method
      <code>push</code> with type
      <code>int -&gt; unit</code>.
    </p><p id="idp9481344">
      To produce an object, classes are instantiated with the keyword
      <code>new</code>.
    </p><div class="rwocode"><pre><code># <span class="keyword4">let</span> s <span class="keyword2">=</span> <span class="keyword1">new</span> istack <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">val s : istack = &lt;obj&gt;
</div># s<span class="keyword7">#pop</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">- : int option = Some 0
</div># s<span class="keyword7">#push</span> <span class="keyword8">5</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">- : unit = ()
</div># s<span class="keyword7">#pop</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">- : int option = Some 5
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/istack.topscript">classes/istack.topscript</a> , continued (part 1) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9483232">
      You may have noticed that the object <code>s</code> has been
      given the type <code>istack</code>. But wait, we've stressed
      <span><em>classes are not types</em></span>, so what's up with
      that? In fact, what we've said is entirely true, classes and class
      names <span><em>are not</em></span> types. However, for
      convenience, the definition of the class <code>istack</code>
      also defines an object type <code>istack</code> with the
      same methods as the class. This type definition is equivalent to:
    </p><div class="rwocode"><pre><code># <span class="keyword4">type</span> istack <span class="keyword2">=</span> <span class="keyword2">&lt;</span> pop<span class="keyword2">:</span> <span class="keyword3">int</span> option<span class="keyword2">;</span> push<span class="keyword2">:</span> <span class="keyword3">int</span> -<span class="keyword2">&gt;</span> unit <span class="keyword2">&gt;</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">type istack = &lt; pop : int option; push : int -&gt; unit &gt;
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/istack.topscript">classes/istack.topscript</a> , continued (part 2) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9488400">
      Note that this type represents any object with these methods:
      objects created using the <code>istack</code> class will
      have this type, but objects with this type may not have been
      created by the <code>istack</code> class.
    </p></section><section><h1 id="class-parameters-and-polymorphism">Class parameters and polymorphism</h1><p id="idp9491632">
      A class definition serves as the <span><em>constructor</em></span>
      for the class. In general, a class definition may have parameters
      that must be provided as arguments when the object is created with
      <code>new</code>.
    </p><p id="idp9493360">
      Let's implement a variant of the <code>istack</code> class
      that can hold any values, not just integers. When defining the
      class, the type parameters are placed in square brackets before
      the class name in the class definition. We also add a parameter
      <code>init</code> for the initial contents of the stack.
    </p><div class="rwocode"><pre><code># <span class="keyword4">class</span> <span class="keyword2">[</span>'a<span class="keyword2">]</span> stack init <span class="keyword2">=</span> <span class="keyword4">object</span>
    <span class="keyword4">val</span> <span class="keyword1">mutable</span> v <span class="keyword2">:</span> 'a <span class="keyword3">list</span> <span class="keyword2">=</span> init

    <span class="keyword4">method</span> pop <span class="keyword2">=</span>
      <span class="keyword1">match</span> v <span class="keyword1">with</span>
      <span class="keyword2">|</span> hd <span class="keyword2">:</span><span class="keyword2">:</span> tl -<span class="keyword2">&gt;</span>
        v <span class="keyword2">&lt;</span>- tl<span class="keyword2">;</span>
        <span class="keyword6">Some </span>hd
      <span class="keyword2">|</span> <span class="keyword2">[</span><span class="keyword2">]</span> -<span class="keyword2">&gt;</span> <span class="keyword6">None
</span>
    <span class="keyword4">method</span> push hd <span class="keyword2">=</span>
      v <span class="keyword2">&lt;</span>- hd <span class="keyword2">:</span><span class="keyword2">:</span> v
  <span class="keyword4">end</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">class ['a] stack :
  'a list -&gt;
  object
    val mutable v : 'a list
    method pop : 'a option
    method push : 'a -&gt; unit
  end
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/stack.topscript">classes/stack.topscript</a>  ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9496224">
      Note that the type parameter <code>['a]</code> in the
      definition uses square brackets, but for other uses of the type
      they are omitted (or replaced with parentheses if there is more
      than one type parameter).
    </p><p id="idp9497552">
      The type annotation on the declaration of <code>v</code> is
      used to constrain type inference. If we omit this annotation, the
      type inferred for the class will be &quot;too polymorphic&quot;:
      <code>init</code> could have some type
      <code>'b list</code>.
    </p><div class="rwocode"><pre><code># <span class="keyword4">class</span> <span class="keyword2">[</span>'a<span class="keyword2">]</span> stack init <span class="keyword2">=</span> <span class="keyword4">object</span>
      <span class="keyword4">val</span> <span class="keyword1">mutable</span> v <span class="keyword2">=</span> init
    
      <span class="keyword4">method</span> pop <span class="keyword2">=</span> 
        <span class="keyword1">match</span> v <span class="keyword1">with</span>
        <span class="keyword2">|</span> hd <span class="keyword2">:</span><span class="keyword2">:</span> tl -<span class="keyword2">&gt;</span> 
          v <span class="keyword2">&lt;</span>- tl<span class="keyword2">;</span>
          <span class="keyword6">Some </span>hd
        <span class="keyword2">|</span> <span class="keyword2">[</span><span class="keyword2">]</span> -<span class="keyword2">&gt;</span> <span class="keyword6">None
</span>
      <span class="keyword4">method</span> push hd <span class="keyword2">=</span> 
        v <span class="keyword2">&lt;</span>- hd <span class="keyword2">:</span><span class="keyword2">:</span> v
  <span class="keyword4">end</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">Characters 6-16:
Error: Some type variables are unbound in this type:
         class ['a] stack :
           'b list -&gt;
           object
             val mutable v : 'b list
             method pop : 'b option
             method push : 'b -&gt; unit
           end
       The method pop has type 'b option where 'b is unbound
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/stack.topscript">classes/stack.topscript</a> , continued (part 1) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9501104">
      In general, we need to provide enough constraints so that the
      compiler will infer the correct type. We can add type constraints
      to the parameters, to the fields, and to the methods. It is a
      matter of preference how many constraints to add. You can add type
      constraints in all three places, but the extra text may not help
      clarity. A convenient middle ground is to annotate the fields
      and/or class parameters, and add constraints to methods only if
      necessary.
    </p></section><section><h1 id="object-types-as-interfaces">Object types as interfaces</h1><p id="idp9503344">
      We may wish to traverse the elements on our stack. One common
      style for doing this in object-oriented languages is to define a
      class for an <code>iterator</code> object. An iterator
      provides a generic mechanism to inspect and traverse the elements
      of a collection.
    </p><p id="idp9504736">
      There are two common styles for defining abstract interfaces like
      this. In Java, an iterator would normally be specified with an
      interface, which specifies a set of method types.
    </p><div class="rwocode"><pre><code><div class="highlight"><span class="c1">// Java-style iterator, specified as an interface.</span>
<span class="kd">interface</span> <span class="err">&lt;</span><span class="nc">T</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">{</span>
  <span class="n">T</span> <span class="nf">Get</span><span class="o">();</span>
  <span class="kt">boolean</span> <span class="nf">HasValue</span><span class="o">();</span>
  <span class="kt">void</span> <span class="nf">Next</span><span class="o">();</span>
<span class="o">};</span>
</div></code></pre><div class="rwocodeinfo">Java ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/Iterator.java">classes/Iterator.java</a>  ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9506064">
      In languages without interfaces, like C++, the specification would
      normally use <span><em>abstract</em></span> classes to specify the
      methods without implementing them (C++ uses the &quot;= 0&quot;
      definition to mean &quot;not implemented&quot;).
    </p><div class="rwocode"><pre><code><div class="highlight"><span class="c1">// Abstract class definition in C++.</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">Iterator</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">Iterator</span><span class="p">()</span> <span class="p">{}</span>
  <span class="k">virtual</span> <span class="n">T</span> <span class="n">get</span><span class="p">()</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">has_value</span><span class="p">()</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">next</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</div></code></pre><div class="rwocodeinfo">C ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/citerator.cpp">classes/citerator.cpp</a>  ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9507872">
      OCaml supports both styles. In fact, OCaml is more flexible than
      these approaches because an object type can be implemented by any
      object with the appropriate methods; it does not have to be
      specified by the object's class <span><em>a priori</em></span>.
      We'll leave abstract classes for later. Let's demonstrate the
      technique using object types.
    </p><p id="idp9509072">
      First, we'll define an object type <code>iterator</code>
      that specifies the methods in an iterator.
    </p><div class="rwocode"><pre><code># <span class="keyword4">type</span> 'a iterator <span class="keyword2">=</span> <span class="keyword2">&lt;</span> get <span class="keyword2">:</span> 'a<span class="keyword2">;</span> has_value <span class="keyword2">:</span> bool<span class="keyword2">;</span> next <span class="keyword2">:</span> unit <span class="keyword2">&gt;</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">type 'a iterator = &lt; get : 'a; has_value : bool; next : unit &gt;
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/iter.topscript">classes/iter.topscript</a>  ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9510992">
      Next, we'll define an actual iterator for lists. We can use this
      to iterate over the contents of our stack.
    </p><div class="rwocode"><pre><code># <span class="keyword4">class</span> <span class="keyword2">[</span>'a<span class="keyword2">]</span> list_iterator init <span class="keyword2">=</span> <span class="keyword4">object</span>
    <span class="keyword4">val</span> <span class="keyword1">mutable</span> current <span class="keyword2">:</span> 'a <span class="keyword3">list</span> <span class="keyword2">=</span> init

    <span class="keyword4">method</span> has_value <span class="keyword2">=</span> current <span class="keyword2">&lt;</span><span class="keyword2">&gt;</span> <span class="keyword2">[</span><span class="keyword2">]</span>

    <span class="keyword4">method</span> get <span class="keyword2">=</span>
      <span class="keyword1">match</span> current <span class="keyword1">with</span>
      <span class="keyword2">|</span> hd <span class="keyword2">:</span><span class="keyword2">:</span> tl -<span class="keyword2">&gt;</span> hd
      <span class="keyword2">|</span> <span class="keyword2">[</span><span class="keyword2">]</span> -<span class="keyword2">&gt;</span> <span class="keyword1">raise</span> <span class="keyword2">(</span><span class="keyword6">Invalid_argument </span><span class="keyword7">&quot;no value&quot;</span><span class="keyword2">)</span>

    <span class="keyword4">method</span> next <span class="keyword2">=</span>
      <span class="keyword1">match</span> current <span class="keyword1">with</span>
      <span class="keyword2">|</span> hd <span class="keyword2">:</span><span class="keyword2">:</span> tl -<span class="keyword2">&gt;</span> current <span class="keyword2">&lt;</span>- tl
      <span class="keyword2">|</span> <span class="keyword2">[</span><span class="keyword2">]</span> -<span class="keyword2">&gt;</span> <span class="keyword1">raise</span> <span class="keyword2">(</span><span class="keyword6">Invalid_argument </span><span class="keyword7">&quot;no value&quot;</span><span class="keyword2">)</span>
   <span class="keyword4">end</span>  <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">class ['a] list_iterator :
  'a list -&gt;
  object
    val mutable current : 'a list
    method get : 'a
    method has_value : bool
    method next : unit
  end
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/iter.topscript">classes/iter.topscript</a> , continued (part 1) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9512240">
      Finally, we add a method <code>iterator</code> to the
      <code>stack</code> class to produce an iterator. To do so,
      we construct a <code>list_iterator</code> that refers to the
      current contents of the stack.
    </p><div class="rwocode"><pre><code># <span class="keyword4">class</span> <span class="keyword2">[</span>'a<span class="keyword2">]</span> stack init <span class="keyword2">=</span> <span class="keyword4">object</span>
    <span class="keyword4">val</span> <span class="keyword1">mutable</span> v <span class="keyword2">:</span> 'a <span class="keyword3">list</span> <span class="keyword2">=</span> init

    <span class="keyword4">method</span> pop <span class="keyword2">=</span>
      <span class="keyword1">match</span> v <span class="keyword1">with</span>
      <span class="keyword2">|</span> hd <span class="keyword2">:</span><span class="keyword2">:</span> tl -<span class="keyword2">&gt;</span>
        v <span class="keyword2">&lt;</span>- tl<span class="keyword2">;</span>
        <span class="keyword6">Some </span>hd
      <span class="keyword2">|</span> <span class="keyword2">[</span><span class="keyword2">]</span> -<span class="keyword2">&gt;</span> <span class="keyword6">None
</span>
    <span class="keyword4">method</span> push hd <span class="keyword2">=</span>
      v <span class="keyword2">&lt;</span>- hd <span class="keyword2">:</span><span class="keyword2">:</span> v

    <span class="keyword4">method</span> iterator <span class="keyword2">:</span> 'a iterator <span class="keyword2">=</span>
      <span class="keyword1">new</span> list_iterator v
  <span class="keyword4">end</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">class ['a] stack :
  'a list -&gt;
  object
    val mutable v : 'a list
    method iterator : 'a iterator
    method pop : 'a option
    method push : 'a -&gt; unit
  end
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/iter.topscript">classes/iter.topscript</a> , continued (part 2) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9515648">
      Now we can build a new stack, push some values to it, and iterate
      over them.
    </p><div class="rwocode"><pre><code># <span class="keyword4">let</span> s <span class="keyword2">=</span> <span class="keyword1">new</span> stack <span class="keyword2">[</span><span class="keyword2">]</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">val s : '_a stack = &lt;obj&gt;
</div># s<span class="keyword7">#push</span> <span class="keyword8">5</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">- : unit = ()
</div># s<span class="keyword7">#push</span> <span class="keyword8">4</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">- : unit = ()
</div># <span class="keyword4">let</span> it <span class="keyword2">=</span> s<span class="keyword7">#iterator</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">val it : int iterator = &lt;obj&gt;
</div># it<span class="keyword7">#get</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">- : int = 4
</div># it<span class="keyword7">#next</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">- : unit = ()
</div># it<span class="keyword7">#get</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">- : int = 5
</div># it<span class="keyword7">#next</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">- : unit = ()
</div># it<span class="keyword7">#has_value</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">- : bool = false
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/iter.topscript">classes/iter.topscript</a> , continued (part 3) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><section><h1 id="functional-iterators">Functional iterators</h1><p id="idp9517968">
        In practise, most OCaml programmers avoid iterator objects in
        favor of functional-style techniques. For example, the
        alternative stack class below takes a function
        <code>f</code> and applies it to each of the elements on
        the stack.
      </p><div class="rwocode"><pre><code># <span class="keyword4">class</span> <span class="keyword2">[</span>'a<span class="keyword2">]</span> stack init <span class="keyword2">=</span> <span class="keyword4">object</span>
    <span class="keyword4">val</span> <span class="keyword1">mutable</span> v <span class="keyword2">:</span> 'a <span class="keyword3">list</span> <span class="keyword2">=</span> init

    <span class="keyword4">method</span> pop <span class="keyword2">=</span>
      <span class="keyword1">match</span> v <span class="keyword1">with</span>
      <span class="keyword2">|</span> hd <span class="keyword2">:</span><span class="keyword2">:</span> tl -<span class="keyword2">&gt;</span>
        v <span class="keyword2">&lt;</span>- tl<span class="keyword2">;</span>
        <span class="keyword6">Some </span>hd
      <span class="keyword2">|</span> <span class="keyword2">[</span><span class="keyword2">]</span> -<span class="keyword2">&gt;</span> <span class="keyword6">None
</span>
    <span class="keyword4">method</span> push hd <span class="keyword2">=</span>
      v <span class="keyword2">&lt;</span>- hd <span class="keyword2">:</span><span class="keyword2">:</span> v

   <span class="keyword4">method</span> iter f <span class="keyword2">=</span> 
     <span class="keyword5">List.</span>iter ~f v 
  <span class="keyword4">end</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">class ['a] stack :
  'a list -&gt;
  object
    val mutable v : 'a list
    method iter : ('a -&gt; unit) -&gt; unit
    method pop : 'a option
    method push : 'a -&gt; unit
  end
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/iter.topscript">classes/iter.topscript</a> , continued (part 4) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9520016">
        What about functional operations like <code>map</code> and
        <code>fold</code>? In general, these methods take a
        function that produces a value of some other type than the
        elements of the set.
      </p><p id="idp9522000">
        For example, a <code>fold</code> method for our
        <code>['a] stack</code> class should have type
        <code>('b -&gt; 'a -&gt; 'b) -&gt; 'b -&gt; 'b</code>,
        where the <code>'b</code> is polymorphic. To express a
        polymorphic method type like this we must use a type quantifier,
        as shown in the following example.
      </p><div class="rwocode"><pre><code># <span class="keyword4">class</span> <span class="keyword2">[</span>'a<span class="keyword2">]</span> stack init <span class="keyword2">=</span> <span class="keyword4">object</span>
    <span class="keyword4">val</span> <span class="keyword1">mutable</span> v <span class="keyword2">:</span> 'a <span class="keyword3">list</span> <span class="keyword2">=</span> init

    <span class="keyword4">method</span> pop <span class="keyword2">=</span>
      <span class="keyword1">match</span> v <span class="keyword1">with</span>
      <span class="keyword2">|</span> hd <span class="keyword2">:</span><span class="keyword2">:</span> tl -<span class="keyword2">&gt;</span>
        v <span class="keyword2">&lt;</span>- tl<span class="keyword2">;</span>
        <span class="keyword6">Some </span>hd
      <span class="keyword2">|</span> <span class="keyword2">[</span><span class="keyword2">]</span> -<span class="keyword2">&gt;</span> <span class="keyword6">None
</span>
    <span class="keyword4">method</span> push hd <span class="keyword2">=</span>
      v <span class="keyword2">&lt;</span>- hd <span class="keyword2">:</span><span class="keyword2">:</span> v

    <span class="keyword4">method</span> fold <span class="keyword2">:</span> 'b. <span class="keyword2">(</span>'b -<span class="keyword2">&gt;</span> 'a -<span class="keyword2">&gt;</span> 'b<span class="keyword2">)</span> -<span class="keyword2">&gt;</span> 'b -<span class="keyword2">&gt;</span> 'b <span class="keyword2">=</span>
     <span class="keyword2">(</span><span class="keyword1">fun</span> f init -<span class="keyword2">&gt;</span> <span class="keyword5">List.</span>fold ~f ~init v<span class="keyword2">)</span> 
  <span class="keyword4">end</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">class ['a] stack :
  'a list -&gt;
  object
    val mutable v : 'a list
    method fold : ('b -&gt; 'a -&gt; 'b) -&gt; 'b -&gt; 'b
    method pop : 'a option
    method push : 'a -&gt; unit
  end
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/iter.topscript">classes/iter.topscript</a> , continued (part 5) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9526192">
        The type quantifier <code>'b.</code> can be read as
        &quot;for all <code>'b</code>&quot;. Type quantifiers can
        only be used <span><em>directly after</em></span> the method
        name, which means that method parameters must be expressed using
        a <code>fun</code> or <code>function</code>
        expression.
      </p></section></section><section><h1 id="inheritance">Inheritance</h1><p id="idp9531408">
      Inheritance uses an existing class to define a new one. For
      example, the following class definition inherits from our stack
      class for strings and adds a new method <code>print</code>
      that prints all the strings on the stack.
    </p><div class="rwocode"><pre><code># <span class="keyword4">class</span> sstack init <span class="keyword2">=</span> <span class="keyword4">object</span>
    <span class="keyword4">inherit</span> <span class="keyword2">[</span><span class="keyword3">string</span><span class="keyword2">]</span> stack init

    <span class="keyword4">method</span> print <span class="keyword2">=</span>
      <span class="keyword5">List.</span>iter ~f<span class="keyword2">:</span>print_string v
  <span class="keyword4">end</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">class sstack :
  string list -&gt;
  object
    val mutable v : string list
    method pop : string option
    method print : unit
    method push : string -&gt; unit
  end
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/stack.topscript">classes/stack.topscript</a> , continued (part 2) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9533472">
      A class can override methods from classes it inherits. For
      example, this class creates stacks of integers that double the
      integers before they are pushed onto the stack.
    </p><div class="rwocode"><pre><code># <span class="keyword4">class</span> double_stack init <span class="keyword2">=</span> <span class="keyword4">object</span>
    <span class="keyword4">inherit</span> <span class="keyword2">[</span><span class="keyword3">int</span><span class="keyword2">]</span> stack init <span class="keyword1">as</span> super

    <span class="keyword4">method</span> push hd <span class="keyword2">=</span>
      super<span class="keyword7">#push</span> <span class="keyword2">(</span>hd <span class="keyword2">*</span> <span class="keyword8">2</span><span class="keyword2">)</span>
  <span class="keyword4">end</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">class double_stack :
  int list -&gt;
  object
    val mutable v : int list
    method pop : int option
    method push : int -&gt; unit
  end
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/stack.topscript">classes/stack.topscript</a> , continued (part 3) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9534800">
      The <code>as super</code> statement above creates a special
      object called <code>super</code> which can be used to call
      superclass methods. Note that <code>super</code> is not a
      real object and can only be used to call methods.
    </p></section><section><h1 id="class-types">Class types</h1><p id="idp9538720">
      To allow code in a different file or module to inherit from a
      class we must expose it and give it a class type. What is the
      class type?
    </p><p id="idp9539280">
      As an example, let's wrap up our <code>stack</code> class in
      an explicit module (we'll use explicit modules for illustration,
      but the process is similar when we want to define a
      <code>.mli</code> file). In keeping with the usual style for
      modules, we define a type <code>'a t</code> to represent the
      type of our stacks.
    </p><div class="rwocode"><pre><code><span class="keyword4">module</span> <span class="keyword6">Stack </span><span class="keyword2">=</span> <span class="keyword4">struct</span>
  <span class="keyword4">class</span> <span class="keyword2">[</span>'a<span class="keyword2">]</span> stack init <span class="keyword2">=</span> <span class="keyword4">object</span>
    ...    
  <span class="keyword4">end</span>

  <span class="keyword4">type</span> 'a t <span class="keyword2">=</span> 'a stack

  <span class="keyword4">let</span> make init <span class="keyword2">=</span> <span class="keyword1">new</span> stack init
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/class_types_stack.ml">classes/class_types_stack.ml</a>  ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9542848">
      We have multiple choices in defining the module type, depending on
      how much of the implementation we want to expose. At one extreme,
      a maximally-abstract signature would completely hide the class
      definitions.
    </p><div class="rwocode"><pre><code><span class="keyword4">module</span> <span class="keyword6">AbstractStack </span><span class="keyword2">:</span> <span class="keyword4">sig</span>
   <span class="keyword4">type</span> 'a t <span class="keyword2">=</span> <span class="keyword2">&lt;</span> pop<span class="keyword2">:</span> 'a option<span class="keyword2">;</span> push<span class="keyword2">:</span> 'a -<span class="keyword2">&gt;</span> unit <span class="keyword2">&gt;</span>

   <span class="keyword4">val</span> make <span class="keyword2">:</span> unit -<span class="keyword2">&gt;</span> 'a t
<span class="keyword4">end</span> <span class="keyword2">=</span> Stack</code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/class_types_stack.ml">classes/class_types_stack.ml</a> , continued (part 1) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9544224">
      The abstract signature is simple because we ignore the classes.
      But what if we want to include them in the signature, so that
      other modules can inherit from the class definitions? For this, we
      need to specify types for the classes, called <span><em>class
      types</em></span>.
    </p><p id="idp9545344">
      Class types do not appear in mainstream object-oriented
      programming languages, so you may not be familiar with them, but
      the concept is pretty simple. A class type specifies the type of
      each of the visible parts of the class, including both fields and
      methods. Just like for module types, you don't have to give a type
      for everything; anything you omit will be hidden.
    </p><div class="rwocode"><pre><code><span class="keyword4">module</span> <span class="keyword6">VisibleStack </span><span class="keyword2">:</span> <span class="keyword4">sig</span>
  
  <span class="keyword4">type</span> 'a t <span class="keyword2">=</span> <span class="keyword2">&lt;</span> pop<span class="keyword2">:</span> 'a option<span class="keyword2">;</span> push<span class="keyword2">:</span> 'a -<span class="keyword2">&gt;</span> unit <span class="keyword2">&gt;</span>

  <span class="keyword4">class</span> <span class="keyword2">[</span>'a<span class="keyword2">]</span> stack <span class="keyword2">:</span> <span class="keyword4">object</span>
    <span class="keyword4">val</span> <span class="keyword1">mutable</span> v <span class="keyword2">:</span> 'a <span class="keyword3">list</span>
    <span class="keyword4">method</span> pop <span class="keyword2">:</span> 'a option
    <span class="keyword4">method</span> push <span class="keyword2">:</span> 'a -<span class="keyword2">&gt;</span> unit
  <span class="keyword4">end</span>

  <span class="keyword4">val</span> make <span class="keyword2">:</span> unit -<span class="keyword2">&gt;</span> 'a t
<span class="keyword4">end</span> <span class="keyword2">=</span> Stack</code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/class_types_stack.ml">classes/class_types_stack.ml</a> , continued (part 2) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9546896">
      In this signature, we've chosen to make everything visible. The
      class type for <code>stack</code> specifies the types of the
      field <code>v</code>, as well as the types of each of the
      methods.
    </p></section><section><h1 id="open-recursion">Open recursion</h1><p id="idp9550160">
      Open recursion allows an object's methods to invoke other methods
      on the same object. These calls are looked up dynamically allowing
      a method in one class to call a method from another class, if both
      classes are inherited by the same object. This allows mutually
      recursive parts of an object to be defined separately.
    </p><p id="idp9550912">
      This ability to define mutually recursive methods from separate
      components is a key feature of classes: achieving similar
      functionality with datatypes or modules is much more cumbersome
      and verbose.
    </p><p id="idp9551536">
      For example, consider writing recursive functions over a simple
      document format. This format is represented as a tree with three
      different types of node:
    </p><div class="rwocode"><pre><code><span class="keyword4">type</span> doc <span class="keyword2">=</span>
  <span class="keyword2">|</span> <span class="keyword6">Heading </span><span class="keyword2">of</span> <span class="keyword3">string</span>
  <span class="keyword2">|</span> <span class="keyword6">Paragraph </span><span class="keyword2">of</span> text_item <span class="keyword3">list</span>
  <span class="keyword2">|</span> <span class="keyword6">Definition </span><span class="keyword2">of</span> <span class="keyword3">string</span> list_item <span class="keyword3">list</span>

<span class="keyword4">and</span> text_item <span class="keyword2">=</span>
  <span class="keyword2">|</span> <span class="keyword6">Raw </span><span class="keyword2">of</span> <span class="keyword3">string</span>
  <span class="keyword2">|</span> <span class="keyword6">Bold </span><span class="keyword2">of</span> text_item <span class="keyword3">list</span>
  <span class="keyword2">|</span> <span class="keyword6">Enumerate </span><span class="keyword2">of</span> <span class="keyword3">int</span> list_item <span class="keyword3">list</span>
  <span class="keyword2">|</span> <span class="keyword6">Quote </span><span class="keyword2">of</span> doc

<span class="keyword4">and</span> 'a list_item <span class="keyword2">=</span> 
  <span class="keyword2">{</span> tag<span class="keyword2">:</span> 'a<span class="keyword2">;</span>
    text<span class="keyword2">:</span> text_item <span class="keyword3">list</span> <span class="keyword2">}</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/doc.ml">classes/doc.ml</a>  ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9552832">
      It is quite easy to write a function that operates by recursively
      traversing this data. However, what if you need to write many
      similar recursive functions? How can you factor out the common
      parts of these functions to avoid repetitive boilerplate?
    </p><p id="idp9553504">
      The simplest way is to use classes and open recursion. For
      example, the following class defines objects which fold over the
      document data:
    </p><div class="rwocode"><pre><code><span class="keyword1">open</span> <span class="keyword5">Core.Std
</span>
<span class="keyword4">class</span> <span class="keyword2">[</span>'a<span class="keyword2">]</span> folder <span class="keyword2">=</span> <span class="keyword4">object</span><span class="keyword2">(</span>self<span class="keyword2">)</span>
  <span class="keyword4">method</span> doc acc <span class="keyword2">=</span> <span class="keyword1">function</span>
  <span class="keyword2">|</span> <span class="keyword6">Heading </span><span class="keyword8">_</span> -<span class="keyword2">&gt;</span> acc
  <span class="keyword2">|</span> <span class="keyword6">Paragraph </span>text -<span class="keyword2">&gt;</span> <span class="keyword5">List.</span>fold ~f<span class="keyword2">:</span>self<span class="keyword7">#text_item</span> ~init<span class="keyword2">:</span>acc text
  <span class="keyword2">|</span> <span class="keyword6">Definition </span><span class="keyword3">list</span> -<span class="keyword2">&gt;</span> <span class="keyword5">List.</span>fold ~f<span class="keyword2">:</span>self<span class="keyword7">#list_item</span> ~init<span class="keyword2">:</span>acc <span class="keyword3">list</span>

  <span class="keyword4">method</span> list_item<span class="keyword2">:</span> 'b. 'a -<span class="keyword2">&gt;</span> 'b list_item -<span class="keyword2">&gt;</span> 'a <span class="keyword2">=</span> 
    <span class="keyword1">fun</span> acc <span class="keyword2">{</span>tag<span class="keyword2">;</span> text<span class="keyword2">}</span> -<span class="keyword2">&gt;</span>
      <span class="keyword5">List.</span>fold ~f<span class="keyword2">:</span>self<span class="keyword7">#text_item</span> ~init<span class="keyword2">:</span>acc text

  <span class="keyword4">method</span> text_item acc <span class="keyword2">=</span> <span class="keyword1">function</span>
  <span class="keyword2">|</span> <span class="keyword6">Raw </span><span class="keyword8">_</span> -<span class="keyword2">&gt;</span> acc
  <span class="keyword2">|</span> <span class="keyword6">Bold </span>text -<span class="keyword2">&gt;</span> <span class="keyword5">List.</span>fold ~f<span class="keyword2">:</span>self<span class="keyword7">#text_item</span> ~init<span class="keyword2">:</span>acc text
  <span class="keyword2">|</span> <span class="keyword6">Enumerate </span><span class="keyword3">list</span> -<span class="keyword2">&gt;</span> <span class="keyword5">List.</span>fold ~f<span class="keyword2">:</span>self<span class="keyword7">#list_item</span> ~init<span class="keyword2">:</span>acc <span class="keyword3">list</span>
  <span class="keyword2">|</span> <span class="keyword6">Quote </span>doc -<span class="keyword2">&gt;</span> self<span class="keyword7">#doc</span> acc doc
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/doc.ml">classes/doc.ml</a> , continued (part 1) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9554784">
      The <code>object (self)</code> syntax binds
      <code>self</code> to the current object, allowing the
      <code>doc</code>, <code>list_item</code> and
      <code>text_item</code> methods to call each other.
    </p><p id="idp9558784">
      By inheriting from this class we can create functions which fold
      over the document data. For example, the
      <code>count_doc</code> function counts the number of bold
      tags in the document that are not within a list:
    </p><div class="rwocode"><pre><code><span class="keyword4">class</span> counter <span class="keyword2">=</span> <span class="keyword4">object</span>
  <span class="keyword4">inherit</span> <span class="keyword2">[</span><span class="keyword3">int</span><span class="keyword2">]</span> folder <span class="keyword1">as</span> super

  <span class="keyword4">method</span> list_item acc li <span class="keyword2">=</span> acc

  <span class="keyword4">method</span> text_item acc ti <span class="keyword2">=</span>
    <span class="keyword4">let</span> acc <span class="keyword2">=</span> super<span class="keyword7">#text_item</span> acc ti <span class="keyword4">in</span>
    <span class="keyword1">match</span> ti <span class="keyword1">with</span>
    <span class="keyword2">|</span> <span class="keyword6">Bold </span><span class="keyword8">_</span> -<span class="keyword2">&gt;</span> acc <span class="keyword2">+</span> <span class="keyword8">1</span>
    <span class="keyword2">|</span> <span class="keyword8">_</span> -<span class="keyword2">&gt;</span> acc
<span class="keyword4">end</span>

<span class="keyword4">let</span> count_doc <span class="keyword2">=</span> <span class="keyword2">(</span><span class="keyword1">new</span> counter<span class="keyword2">)</span><span class="keyword7">#doc</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/doc.ml">classes/doc.ml</a> , continued (part 2) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9560832">
      Note how the <code>super</code> special object is used in
      <code>text_item</code> to call the
      <code>[int] folder</code> class's
      <code>text_item</code> method to fold over the children of
      the <code>text_item</code> node.
    </p></section><section><h1 id="private-methods">Private methods</h1><p id="idp9566112">
      Methods can be declared <span><em>private</em></span>, which means
      that they may be called by subclasses, but they are not visible
      otherwise (similar to a <span><em>protected</em></span> method in
      C++).
    </p><p id="idp9567552">
      For example, we may want to include methods in our
      <code>folder</code> class for handling each of the different
      cases in <code>doc</code> and <code>text_item</code>.
      However, we may not want to force subclasses of
      <code>folder</code> to expose these methods as they probably
      shouldn't be called directly.
    </p><div class="rwocode"><pre><code><span class="keyword4">class</span> <span class="keyword2">[</span>'a<span class="keyword2">]</span> folder2 <span class="keyword2">=</span> <span class="keyword4">object</span><span class="keyword2">(</span>self<span class="keyword2">)</span>
  <span class="keyword4">method</span> doc acc <span class="keyword2">=</span> <span class="keyword1">function</span>
  <span class="keyword2">|</span> <span class="keyword6">Heading </span>str -<span class="keyword2">&gt;</span> self<span class="keyword7">#heading</span> acc str
  <span class="keyword2">|</span> <span class="keyword6">Paragraph </span>text -<span class="keyword2">&gt;</span> self<span class="keyword7">#paragraph</span> acc text
  <span class="keyword2">|</span> <span class="keyword6">Definition </span><span class="keyword3">list</span> -<span class="keyword2">&gt;</span> self<span class="keyword7">#definition</span> acc <span class="keyword3">list</span>

  <span class="keyword4">method</span> list_item<span class="keyword2">:</span> 'b. 'a -<span class="keyword2">&gt;</span> 'b list_item -<span class="keyword2">&gt;</span> 'a <span class="keyword2">=</span>
    <span class="keyword1">fun</span> acc <span class="keyword2">{</span>tag<span class="keyword2">;</span> text<span class="keyword2">}</span> -<span class="keyword2">&gt;</span>
      <span class="keyword5">List.</span>fold ~f<span class="keyword2">:</span>self<span class="keyword7">#text_item</span> ~init<span class="keyword2">:</span>acc text

  <span class="keyword4">method</span> text_item acc <span class="keyword2">=</span> <span class="keyword1">function</span>
  <span class="keyword2">|</span> <span class="keyword6">Raw </span>str -<span class="keyword2">&gt;</span> self<span class="keyword7">#raw</span> acc str
  <span class="keyword2">|</span> <span class="keyword6">Bold </span>text -<span class="keyword2">&gt;</span> self<span class="keyword7">#bold</span> acc text
  <span class="keyword2">|</span> <span class="keyword6">Enumerate </span><span class="keyword3">list</span> -<span class="keyword2">&gt;</span> self<span class="keyword7">#enumerate</span> acc <span class="keyword3">list</span>
  <span class="keyword2">|</span> <span class="keyword6">Quote </span>doc -<span class="keyword2">&gt;</span> self<span class="keyword7">#quote</span> acc doc

  <span class="keyword4">method</span> <span class="keyword1">private</span> heading acc str <span class="keyword2">=</span> acc
  <span class="keyword4">method</span> <span class="keyword1">private</span> paragraph acc text <span class="keyword2">=</span>
    <span class="keyword5">List.</span>fold ~f<span class="keyword2">:</span>self<span class="keyword7">#text_item</span> ~init<span class="keyword2">:</span>acc text
  <span class="keyword4">method</span> <span class="keyword1">private</span> definition acc <span class="keyword3">list</span> <span class="keyword2">=</span>
    <span class="keyword5">List.</span>fold ~f<span class="keyword2">:</span>self<span class="keyword7">#list_item</span> ~init<span class="keyword2">:</span>acc <span class="keyword3">list</span>

  <span class="keyword4">method</span> <span class="keyword1">private</span> raw acc str <span class="keyword2">=</span> acc
  <span class="keyword4">method</span> <span class="keyword1">private</span> bold acc text <span class="keyword2">=</span> 
    <span class="keyword5">List.</span>fold ~f<span class="keyword2">:</span>self<span class="keyword7">#text_item</span> ~init<span class="keyword2">:</span>acc text
  <span class="keyword4">method</span> <span class="keyword1">private</span> enumerate acc <span class="keyword3">list</span> <span class="keyword2">=</span> 
    <span class="keyword5">List.</span>fold ~f<span class="keyword2">:</span>self<span class="keyword7">#list_item</span> ~init<span class="keyword2">:</span>acc <span class="keyword3">list</span>
  <span class="keyword4">method</span> <span class="keyword1">private</span> quote acc doc <span class="keyword2">=</span> self<span class="keyword7">#doc</span> acc doc
<span class="keyword4">end</span>

<span class="keyword4">let</span> f <span class="keyword2">:</span>
  <span class="keyword2">&lt;</span> doc <span class="keyword2">:</span> <span class="keyword3">int</span> -<span class="keyword2">&gt;</span> doc -<span class="keyword2">&gt;</span> <span class="keyword3">int</span><span class="keyword2">;</span>
    list_item <span class="keyword2">:</span> 'a . <span class="keyword3">int</span> -<span class="keyword2">&gt;</span> 'a list_item -<span class="keyword2">&gt;</span> <span class="keyword3">int</span><span class="keyword2">;</span>
    text_item <span class="keyword2">:</span> <span class="keyword3">int</span> -<span class="keyword2">&gt;</span> text_item -<span class="keyword2">&gt;</span> <span class="keyword3">int</span> <span class="keyword2">&gt;</span>  <span class="keyword2">=</span> <span class="keyword1">new</span> folder2</code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/doc.ml">classes/doc.ml</a> , continued (part 3) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9571744">
      The final statement that builds the value <code>f</code>
      shows how the instantiation of a <code>folder2</code> object
      has a type that hides the private methods.
    </p><p id="idp9573680">
      To be precise, the private methods are part of the class type, but
      not part of the object type. This means, for example, that the
      object <code>f</code> has no method <code>bold</code>.
      However, the private methods are available to subclasses: we can
      use them to simplify our <code>counter</code> class.
    </p><div class="rwocode"><pre><code><span class="keyword4">class</span> counter_with_private_method <span class="keyword2">=</span> <span class="keyword4">object</span>
  <span class="keyword4">inherit</span> <span class="keyword2">[</span><span class="keyword3">int</span><span class="keyword2">]</span> folder2 <span class="keyword1">as</span> super

  <span class="keyword4">method</span> list_item acc li <span class="keyword2">=</span> acc

  <span class="keyword4">method</span> <span class="keyword1">private</span> bold acc txt <span class="keyword2">=</span> 
    <span class="keyword4">let</span> acc <span class="keyword2">=</span> super<span class="keyword7">#bold</span> acc txt <span class="keyword4">in</span>
    acc <span class="keyword2">+</span> <span class="keyword8">1</span>
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/doc.ml">classes/doc.ml</a> , continued (part 4) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9577184">
      The key property of private methods is that they are visible to
      subclasses, but not anywhere else. If you want the stronger
      guarantee that a method is <span><em>really</em></span> private,
      not even accessible in subclasses, you can use an explicit class
      type that omits the method. In the following code, the private
      methods are explicitly omitted from the class type of
      <code>counter_with_sig</code>, and can't be invoked in
      subclasses of <code>counter_with_sig</code>.
    </p><div class="rwocode"><pre><code><span class="keyword4">class</span> counter_with_sig <span class="keyword2">:</span> <span class="keyword4">object</span>
  <span class="keyword4">method</span> doc <span class="keyword2">:</span> <span class="keyword3">int</span> -<span class="keyword2">&gt;</span> doc -<span class="keyword2">&gt;</span> <span class="keyword3">int</span>
  <span class="keyword4">method</span> list_item <span class="keyword2">:</span> <span class="keyword3">int</span> -<span class="keyword2">&gt;</span> 'b list_item -<span class="keyword2">&gt;</span> <span class="keyword3">int</span>
  <span class="keyword4">method</span> text_item <span class="keyword2">:</span> <span class="keyword3">int</span> -<span class="keyword2">&gt;</span> text_item -<span class="keyword2">&gt;</span> <span class="keyword3">int</span>
<span class="keyword4">end</span> <span class="keyword2">=</span> <span class="keyword4">object</span>
  <span class="keyword4">inherit</span> <span class="keyword2">[</span><span class="keyword3">int</span><span class="keyword2">]</span> folder2 <span class="keyword1">as</span> super

  <span class="keyword4">method</span> list_item acc li <span class="keyword2">=</span> acc

  <span class="keyword4">method</span> <span class="keyword1">private</span> bold acc txt <span class="keyword2">=</span> 
    <span class="keyword4">let</span> acc <span class="keyword2">=</span> super<span class="keyword7">#bold</span> acc txt <span class="keyword4">in</span>
    acc <span class="keyword2">+</span> <span class="keyword8">1</span>
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/doc.ml">classes/doc.ml</a> , continued (part 5) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div></section><section><h1 id="binary-methods">Binary methods</h1><p id="idp9581840">
      A <span><em>binary method</em></span> is a method that takes an
      object of <code>self</code> type. One common example is
      defining a method for equality.
    </p><div class="rwocode"><pre><code># <span class="keyword4">class</span> square w <span class="keyword2">=</span> <span class="keyword4">object</span><span class="keyword2">(</span>self <span class="keyword2">:</span> 'self<span class="keyword2">)</span> 
    <span class="keyword4">method</span> width <span class="keyword2">=</span> w
    <span class="keyword4">method</span> area <span class="keyword2">=</span> <span class="keyword5">Float.</span>of_int <span class="keyword2">(</span>self<span class="keyword7">#width</span> <span class="keyword2">*</span> self<span class="keyword7">#width</span><span class="keyword2">)</span>
    <span class="keyword4">method</span> equals <span class="keyword2">(</span>other <span class="keyword2">:</span> 'self<span class="keyword2">)</span> <span class="keyword2">=</span> other<span class="keyword7">#width</span> <span class="keyword2">=</span> self<span class="keyword7">#width</span>
  <span class="keyword4">end</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">class square :
  int -&gt;
  object ('a)
    method area : float
    method equals : 'a -&gt; bool
    method width : int
  end
</div># <span class="keyword4">class</span> circle r <span class="keyword2">=</span> <span class="keyword4">object</span><span class="keyword2">(</span>self <span class="keyword2">:</span> 'self<span class="keyword2">)</span>
    <span class="keyword4">method</span> radius <span class="keyword2">=</span> r
    <span class="keyword4">method</span> area <span class="keyword2">=</span> <span class="keyword8">3</span>.<span class="keyword8">14</span> <span class="keyword2">*</span>. <span class="keyword2">(</span><span class="keyword5">Float.</span>of_int self<span class="keyword7">#radius</span><span class="keyword2">)</span> <span class="keyword2">*</span><span class="keyword2">*</span> <span class="keyword8">2</span>.<span class="keyword8">0</span>
    <span class="keyword4">method</span> equals <span class="keyword2">(</span>other <span class="keyword2">:</span> 'self<span class="keyword2">)</span> <span class="keyword2">=</span> other<span class="keyword7">#radius</span> <span class="keyword2">=</span> self<span class="keyword7">#radius</span>
  <span class="keyword4">end</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">class circle :
  int -&gt;
  object ('a)
    method area : float
    method equals : 'a -&gt; bool
    method radius : int
  end
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/binary.topscript">classes/binary.topscript</a>  ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9584240">
      Note how we can use the type annotation
      <code>(self: 'self)</code> to obtain the type of the current
      object.
    </p><p id="idp9585440">
      We can now test different object instances for equality by using
      the <code>equals</code> binary method.
    </p><div class="rwocode"><pre><code># <span class="keyword2">(</span><span class="keyword1">new</span> square <span class="keyword8">5</span><span class="keyword2">)</span><span class="keyword7">#equals</span> <span class="keyword2">(</span><span class="keyword1">new</span> square <span class="keyword8">5</span><span class="keyword2">)</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">- : bool = true
</div># <span class="keyword2">(</span><span class="keyword1">new</span> circle <span class="keyword8">10</span><span class="keyword2">)</span><span class="keyword7">#equals</span> <span class="keyword2">(</span><span class="keyword1">new</span> circle <span class="keyword8">7</span><span class="keyword2">)</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">- : bool = false
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/binary.topscript">classes/binary.topscript</a> , continued (part 1) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9587376">
      This works, but there is a problem lurking here. The method
      <code>equals</code> takes an object of the exact type
      <code>square</code> or <code>circle</code>. Because of
      this, we can't define a common base class <code>shape</code>
      that also includes an equality method.
    </p><div class="rwocode"><pre><code># <span class="keyword4">type</span> shape <span class="keyword2">=</span> <span class="keyword2">&lt;</span> equals <span class="keyword2">:</span> shape -<span class="keyword2">&gt;</span> bool<span class="keyword2">;</span> area <span class="keyword2">:</span> <span class="keyword3">float</span> <span class="keyword2">&gt;</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">type shape = &lt; area : float; equals : shape -&gt; bool &gt;
</div># <span class="keyword2">(</span><span class="keyword1">new</span> square <span class="keyword8">5</span> <span class="keyword2">:</span><span class="keyword2">&gt;</span> shape<span class="keyword2">)</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">Characters -1-23:
Error: Type square = &lt; area : float; equals : square -&gt; bool; width : int &gt;
       is not a subtype of shape = &lt; area : float; equals : shape -&gt; bool &gt; 
       Type shape = &lt; area : float; equals : shape -&gt; bool &gt;
       is not a subtype of
         square = &lt; area : float; equals : square -&gt; bool; width : int &gt; 
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/binary.topscript">classes/binary.topscript</a> , continued (part 2) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9591584">
      The problem is that a <code>square</code> expects to be
      compared with a <code>square</code>, not an arbitrary shape;
      similarly for <code>circle</code>. This problem is
      fundamental. Many languages solve it either with narrowing (with
      dynamic type checking), or by method overloading. Since OCaml has
      neither of these, what can we do?
    </p><p id="idp9594416">
      Since the problematic method is equality, one proposal we could
      consider is to just drop it from the base type
      <code>shape</code> and use polymorphic equality instead.
      However, the built-in polymorphic equality has very poor behavior
      when applied to objects.
    </p><div class="rwocode"><pre><code># <span class="keyword2">(</span><span class="keyword4">object</span> <span class="keyword4">method</span> area <span class="keyword2">=</span> <span class="keyword8">5</span> <span class="keyword4">end</span><span class="keyword2">)</span> <span class="keyword2">=</span> <span class="keyword2">(</span><span class="keyword4">object</span> <span class="keyword4">method</span> area <span class="keyword2">=</span> <span class="keyword8">5</span> <span class="keyword4">end</span><span class="keyword2">)</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">- : bool = false
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/binary.topscript">classes/binary.topscript</a> , continued (part 3) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9596528">
      The problem here is that two objects are considered equal by the
      built-in polymorphic equality if and only if they are physically
      equal. There are other reasons not to use the built-in polymorphic
      equality, but these false negatives are a showstopper.
    </p><p id="idp9597216">
      If we want to define equality for shapes in general, the remaining
      solution is to use the same approach as we described for
      narrowing. That is, introduce a
      <span><em>representation</em></span> type implemented using
      variants, and implement the comparison based on the representation
      type.
    </p><div class="rwocode"><pre><code># <span class="keyword4">type</span> shape_repr <span class="keyword2">=</span>
  <span class="keyword2">|</span> <span class="keyword6">Square </span><span class="keyword2">of</span> <span class="keyword3">int</span>
  <span class="keyword2">|</span> <span class="keyword6">Circle </span><span class="keyword2">of</span> <span class="keyword3">int</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">type shape_repr = Square of int | Circle of int
</div># <span class="keyword4">type</span> shape <span class="keyword2">=</span>
  <span class="keyword2">&lt;</span> repr <span class="keyword2">:</span> shape_repr<span class="keyword2">;</span> equals <span class="keyword2">:</span> shape -<span class="keyword2">&gt;</span> bool<span class="keyword2">;</span> area <span class="keyword2">:</span> <span class="keyword3">float</span> <span class="keyword2">&gt;</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">type shape = &lt; area : float; equals : shape -&gt; bool; repr : shape_repr &gt;
</div># <span class="keyword4">class</span> square w <span class="keyword2">=</span> <span class="keyword4">object</span><span class="keyword2">(</span>self<span class="keyword2">)</span> 
    <span class="keyword4">method</span> width <span class="keyword2">=</span> w
    <span class="keyword4">method</span> area <span class="keyword2">=</span> <span class="keyword5">Float.</span>of_int <span class="keyword2">(</span>self<span class="keyword7">#width</span> <span class="keyword2">*</span> self<span class="keyword7">#width</span><span class="keyword2">)</span>
    <span class="keyword4">method</span> repr <span class="keyword2">=</span> <span class="keyword6">Square </span>self<span class="keyword7">#width</span>
    <span class="keyword4">method</span> equals <span class="keyword2">(</span>other <span class="keyword2">:</span> shape<span class="keyword2">)</span> <span class="keyword2">=</span> other<span class="keyword7">#repr</span> <span class="keyword2">=</span> self<span class="keyword7">#repr</span>
  <span class="keyword4">end</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">class square :
  int -&gt;
  object
    method area : float
    method equals : shape -&gt; bool
    method repr : shape_repr
    method width : int
  end
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/binary.topscript">classes/binary.topscript</a> , continued (part 4) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9599072">
      The binary method <code>equals</code> is now implemented in
      terms of the concrete type <code>shape_repr</code>. When
      using this pattern, you will not be able to hide the
      <code>repr</code> method, but you can hide the type
      definition using the module system.
    </p><div class="rwocode"><pre><code><span class="keyword4">module</span> <span class="keyword6">Shapes </span><span class="keyword2">:</span> <span class="keyword4">sig</span>
  <span class="keyword4">type</span> shape_repr
  <span class="keyword4">type</span> shape <span class="keyword2">=</span>
    <span class="keyword2">&lt;</span> repr <span class="keyword2">:</span> shape_repr<span class="keyword2">;</span> equals <span class="keyword2">:</span> shape -<span class="keyword2">&gt;</span> bool<span class="keyword2">;</span> area<span class="keyword2">:</span> <span class="keyword3">float</span> <span class="keyword2">&gt;</span>

  <span class="keyword4">class</span> square <span class="keyword2">:</span> <span class="keyword3">int</span> -<span class="keyword2">&gt;</span>
    <span class="keyword4">object</span>
      <span class="keyword4">method</span> width <span class="keyword2">:</span> <span class="keyword3">int</span>
      <span class="keyword4">method</span> area <span class="keyword2">:</span> <span class="keyword3">float</span>
      <span class="keyword4">method</span> repr <span class="keyword2">:</span> shape_repr
      <span class="keyword4">method</span> equals <span class="keyword2">:</span> shape -<span class="keyword2">&gt;</span> bool
    <span class="keyword4">end</span>
<span class="keyword4">end</span> <span class="keyword2">=</span> <span class="keyword4">struct</span>
  <span class="keyword4">type</span> shape_repr <span class="keyword2">=</span> 
  <span class="keyword2">|</span> <span class="keyword6">Square </span><span class="keyword2">of</span> <span class="keyword3">int</span> 
  <span class="keyword2">|</span> <span class="keyword6">Circle </span><span class="keyword2">of</span> <span class="keyword3">int</span> 
  ...
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/binary_module.ml">classes/binary_module.ml</a>  ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9602560">
      Note that this solution prevents us from adding new kinds of shape
      without adding new constructors to the
      <code>shape_repr</code> type, which is quite restrictive.
      The objects created by these classes are also in one-to-one
      correspondence with members of the representation type, making the
      objects seem somewhat redundant.
    </p><p id="idp9604016">
      However, equality is quite an extreme instance of a binary method:
      it needs access to all the information of the other object. Many
      other binary methods need only partial information about the
      object. For instance, a method that compares shapes by their
      sizes:
    </p><div class="rwocode"><pre><code><span class="keyword4">class</span> square w <span class="keyword2">=</span> <span class="keyword4">object</span><span class="keyword2">(</span>self<span class="keyword2">)</span> 
  <span class="keyword4">method</span> width <span class="keyword2">=</span> w
  <span class="keyword4">method</span> area <span class="keyword2">=</span> <span class="keyword5">Float.</span>of_int <span class="keyword2">(</span>self<span class="keyword7">#width</span> <span class="keyword2">*</span> self<span class="keyword7">#width</span><span class="keyword2">)</span>
  <span class="keyword4">method</span> larger other <span class="keyword2">=</span> self<span class="keyword7">#area</span> <span class="keyword2">&gt;</span> other<span class="keyword7">#area</span>
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/binary_larger.ml">classes/binary_larger.ml</a>  ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9605440">
      In this case, there is no one-to-one correspondence between the
      objects and their sizes, and we can still easily define new kinds
      of shape.
    </p></section><section><h1 id="virtual-classes-and-methods">Virtual classes and methods</h1><p id="idp9607264">
      A <span><em>virtual</em></span> class is a class where some methods
      or fields are declared, but not implemented. This should not be
      confused with the word <code>virtual</code> as it is used in
      C++. A <code>virtual</code> method in C++ uses dynamic
      dispatch, while regular non-virtual methods are statically
      dispatched. In OCaml, <span><em>all</em></span> methods use dynamic
      dispatch, but the keyword <code>virtual</code> means that
      the method or field is not implemented. A class containing virtual
      methods must also be flagged <code>virtual</code> and cannot
      be directly instantiated (i.e. no object of this class can be
      created).
    </p><p id="idp9611952">
      To explore this, let's extend our shapes examples to simple
      interactive graphics. We will use the Async concurrency library
      and the
      <a href="http://github.com/lpw25/async_graphics/" target="_top">Async_graphics</a>
      library, which provides an asynchronous interface to OCaml's built
      in Graphics library. Concurrent programming with Async will be
      explored later in
      <a href="concurrent-programming-with-async.html">Chapter 18, <i>Concurrent Programming with Async</i></a>; for
      now you can safely ignore the details. You just need to run
      <code>opam install async_graphics</code> to get the library
      installed on your system.
    </p><p id="idp9614960">
      We will give each shape a <code>draw</code> method that
      describes how to draw the shape on the
      <code>Async_graphics</code> display:
    </p><div class="rwocode"><pre><code><span class="keyword1">open</span> <span class="keyword5">Core.Std
</span><span class="keyword1">open</span> <span class="keyword5">Async.Std
</span><span class="keyword1">open</span> <span class="keyword6">Async_graphics
</span>
<span class="keyword4">type</span> drawable <span class="keyword2">=</span> <span class="keyword2">&lt;</span> draw<span class="keyword2">:</span> unit <span class="keyword2">&gt;</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/shapes.ml">classes-async/shapes.ml</a>  ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><section><h1 id="create-some-simple-shapes">Create some simple shapes</h1><p id="idp9618688">
        Now let's add classes for making squares and circles. We include
        an <code>on_click</code> method for adding event handlers
        to the shapes.
      </p><div class="rwocode"><pre><code><span class="keyword4">class</span> square w x y <span class="keyword2">=</span> <span class="keyword4">object</span><span class="keyword2">(</span>self<span class="keyword2">)</span>
  <span class="keyword4">val</span> <span class="keyword1">mutable</span> x<span class="keyword2">:</span> <span class="keyword3">int</span> <span class="keyword2">=</span> x
  <span class="keyword4">method</span> x <span class="keyword2">=</span> x

  <span class="keyword4">val</span> <span class="keyword1">mutable</span> y<span class="keyword2">:</span> <span class="keyword3">int</span> <span class="keyword2">=</span> y
  <span class="keyword4">method</span> y <span class="keyword2">=</span> y

  <span class="keyword4">val</span> <span class="keyword1">mutable</span> width <span class="keyword2">=</span> w
  <span class="keyword4">method</span> width <span class="keyword2">=</span> width

  <span class="keyword4">method</span> draw <span class="keyword2">=</span> fill_rect x y width width

  <span class="keyword4">method</span> <span class="keyword1">private</span> contains x' y' <span class="keyword2">=</span>
    x <span class="keyword2">&lt;</span><span class="keyword2">=</span> x' <span class="keyword2">&amp;&amp;</span> x' <span class="keyword2">&lt;</span><span class="keyword2">=</span> x <span class="keyword2">+</span> width <span class="keyword2">&amp;&amp;</span>
      y <span class="keyword2">&lt;</span><span class="keyword2">=</span> y' <span class="keyword2">&amp;&amp;</span> y' <span class="keyword2">&lt;</span><span class="keyword2">=</span> y <span class="keyword2">+</span> width

  <span class="keyword4">method</span> on_click ?start ?stop f <span class="keyword2">=</span>
    on_click ?start ?stop
      <span class="keyword2">(</span><span class="keyword1">fun</span> ev -<span class="keyword2">&gt;</span>
         <span class="keyword1">if</span> self<span class="keyword7">#contains</span> ev.mouse_x ev.mouse_y <span class="keyword1">then</span>
           f ev.mouse_x ev.mouse_y<span class="keyword2">)</span>
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/verbose_shapes.ml">classes-async/verbose_shapes.ml</a> , continued (part 1) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9620672">
        The <code>square</code> class is pretty straightforward,
        and the <code>circle</code> class below also looks very
        similar.
      </p><div class="rwocode"><pre><code><span class="keyword4">class</span> circle r x y <span class="keyword2">=</span> <span class="keyword4">object</span><span class="keyword2">(</span>self<span class="keyword2">)</span>
  <span class="keyword4">val</span> <span class="keyword1">mutable</span> x<span class="keyword2">:</span> <span class="keyword3">int</span> <span class="keyword2">=</span> x
  <span class="keyword4">method</span> x <span class="keyword2">=</span> x

  <span class="keyword4">val</span> <span class="keyword1">mutable</span> y<span class="keyword2">:</span> <span class="keyword3">int</span> <span class="keyword2">=</span> y
  <span class="keyword4">method</span> y <span class="keyword2">=</span> y

  <span class="keyword4">val</span> <span class="keyword1">mutable</span> radius <span class="keyword2">=</span> r
  <span class="keyword4">method</span> radius <span class="keyword2">=</span> radius

  <span class="keyword4">method</span> draw <span class="keyword2">=</span> fill_circle x y radius

  <span class="keyword4">method</span> <span class="keyword1">private</span> contains x' y' <span class="keyword2">=</span>
    <span class="keyword4">let</span> dx <span class="keyword2">=</span> abs <span class="keyword2">(</span>x' - x<span class="keyword2">)</span> <span class="keyword4">in</span>
    <span class="keyword4">let</span> dy <span class="keyword2">=</span> abs <span class="keyword2">(</span>y' - y<span class="keyword2">)</span> <span class="keyword4">in</span>
    <span class="keyword4">let</span> dist <span class="keyword2">=</span> sqrt <span class="keyword2">(</span><span class="keyword5">Float.</span>of_int <span class="keyword2">(</span><span class="keyword2">(</span>dx <span class="keyword2">*</span> dx<span class="keyword2">)</span> <span class="keyword2">+</span> <span class="keyword2">(</span>dy <span class="keyword2">*</span> dy<span class="keyword2">)</span><span class="keyword2">)</span><span class="keyword2">)</span> <span class="keyword4">in</span>
      dist <span class="keyword2">&lt;</span><span class="keyword2">=</span> <span class="keyword2">(</span><span class="keyword5">Float.</span>of_int radius<span class="keyword2">)</span>

  <span class="keyword4">method</span> on_click ?start ?stop f <span class="keyword2">=</span>
    on_click ?start ?stop
      <span class="keyword2">(</span><span class="keyword1">fun</span> ev -<span class="keyword2">&gt;</span>
         <span class="keyword1">if</span> self<span class="keyword7">#contains</span> ev.mouse_x ev.mouse_y <span class="keyword1">then</span>
           f ev.mouse_x ev.mouse_y<span class="keyword2">)</span>
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/verbose_shapes.ml">classes-async/verbose_shapes.ml</a> , continued (part 2) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9623328">
        These classes have a lot in common, and it would be useful to
        factor out this common functionality into a superclass. We can
        easily move the definitions of <code>x</code> and
        <code>y</code> into a superclass, but what about
        <code>on_click</code>? Its definition depends on
        <code>contains</code> which has a different definition in
        each class. The solution is to create a
        <span><em>virtual</em></span> class. This class will declare a
        <code>contains</code> method, but leave its definition to
        the subclasses.
      </p><p id="idp9628096">
        Here is the more succinct definition, starting with a virtual
        <code>shape</code> class that implements
        <code>on_click</code> and <code>on_mousedown</code>.
      </p><div class="rwocode"><pre><code><span class="keyword4">class</span> <span class="keyword4">virtual</span> shape x y <span class="keyword2">=</span> <span class="keyword4">object</span><span class="keyword2">(</span>self<span class="keyword2">)</span>
  <span class="keyword4">method</span> <span class="keyword4">virtual</span> <span class="keyword1">private</span> contains<span class="keyword2">:</span> <span class="keyword3">int</span> -<span class="keyword2">&gt;</span> <span class="keyword3">int</span> -<span class="keyword2">&gt;</span> bool

  <span class="keyword4">val</span> <span class="keyword1">mutable</span> x<span class="keyword2">:</span> <span class="keyword3">int</span> <span class="keyword2">=</span> x
  <span class="keyword4">method</span> x <span class="keyword2">=</span> x

  <span class="keyword4">val</span> <span class="keyword1">mutable</span> y<span class="keyword2">:</span> <span class="keyword3">int</span> <span class="keyword2">=</span> y
  <span class="keyword4">method</span> y <span class="keyword2">=</span> y

  <span class="keyword4">method</span> on_click ?start ?stop f <span class="keyword2">=</span>
    on_click ?start ?stop
      <span class="keyword2">(</span><span class="keyword1">fun</span> ev -<span class="keyword2">&gt;</span>  
         <span class="keyword1">if</span> self<span class="keyword7">#contains</span> ev.mouse_x ev.mouse_y <span class="keyword1">then</span>
           f ev.mouse_x ev.mouse_y<span class="keyword2">)</span>

  <span class="keyword4">method</span> on_mousedown ?start ?stop f <span class="keyword2">=</span>
    on_mousedown ?start ?stop
      <span class="keyword2">(</span><span class="keyword1">fun</span> ev -<span class="keyword2">&gt;</span>
         <span class="keyword1">if</span> self<span class="keyword7">#contains</span> ev.mouse_x ev.mouse_y <span class="keyword1">then</span>
           f ev.mouse_x ev.mouse_y<span class="keyword2">)</span>
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/shapes.ml">classes-async/shapes.ml</a> , continued (part 1) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9631472">
        Now we can define <code>square</code> and
        <code>circle</code> by inheriting from
        <code>shape</code>.
      </p><div class="rwocode"><pre><code><span class="keyword4">class</span> square w x y <span class="keyword2">=</span> <span class="keyword4">object</span>
  <span class="keyword4">inherit</span> shape x y

  <span class="keyword4">val</span> <span class="keyword1">mutable</span> width <span class="keyword2">=</span> w
  <span class="keyword4">method</span> width <span class="keyword2">=</span> width

  <span class="keyword4">method</span> draw <span class="keyword2">=</span> fill_rect x y width width

  <span class="keyword4">method</span> <span class="keyword1">private</span> contains x' y' <span class="keyword2">=</span> 
    x <span class="keyword2">&lt;</span><span class="keyword2">=</span> x' <span class="keyword2">&amp;&amp;</span> x' <span class="keyword2">&lt;</span><span class="keyword2">=</span> x <span class="keyword2">+</span> width <span class="keyword2">&amp;&amp;</span>
    y <span class="keyword2">&lt;</span><span class="keyword2">=</span> y' <span class="keyword2">&amp;&amp;</span> y' <span class="keyword2">&lt;</span><span class="keyword2">=</span> y <span class="keyword2">+</span> width 
<span class="keyword4">end</span> 

<span class="keyword4">class</span> circle r x y <span class="keyword2">=</span> <span class="keyword4">object</span>
  <span class="keyword4">inherit</span> shape x y

  <span class="keyword4">val</span> <span class="keyword1">mutable</span> radius <span class="keyword2">=</span> r
  <span class="keyword4">method</span> radius <span class="keyword2">=</span> radius

  <span class="keyword4">method</span> draw <span class="keyword2">=</span> fill_circle x y radius

  <span class="keyword4">method</span> <span class="keyword1">private</span> contains x' y' <span class="keyword2">=</span>
    <span class="keyword4">let</span> dx <span class="keyword2">=</span> abs <span class="keyword2">(</span>x' - x<span class="keyword2">)</span> <span class="keyword4">in</span>
    <span class="keyword4">let</span> dy <span class="keyword2">=</span> abs <span class="keyword2">(</span>y' - y<span class="keyword2">)</span> <span class="keyword4">in</span>
    <span class="keyword4">let</span> dist <span class="keyword2">=</span> sqrt <span class="keyword2">(</span><span class="keyword5">Float.</span>of_int <span class="keyword2">(</span><span class="keyword2">(</span>dx <span class="keyword2">*</span> dx<span class="keyword2">)</span> <span class="keyword2">+</span> <span class="keyword2">(</span>dy <span class="keyword2">*</span> dy<span class="keyword2">)</span><span class="keyword2">)</span><span class="keyword2">)</span> <span class="keyword4">in</span>
    dist <span class="keyword2">&lt;</span><span class="keyword2">=</span> <span class="keyword2">(</span><span class="keyword5">Float.</span>of_int radius<span class="keyword2">)</span>
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/shapes.ml">classes-async/shapes.ml</a> , continued (part 2) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9634800">
        One way to view a <code>virtual</code> class is that it is
        like a functor, where the &quot;inputs&quot; are the declared,
        but not defined, virtual methods and fields. The functor
        application is implemented through inheritance, when virtual
        methods are given concrete implementations.
      </p></section></section><section><h1 id="initializers">Initializers</h1><p id="idp9637888">
      You can execute expressions during the instantiation of a class by
      placing them before the object expression or in the initial value
      of a field:
    </p><div class="rwocode"><pre><code># <span class="keyword4">class</span> obj x <span class="keyword2">=</span> 
    <span class="keyword4">let</span> <span class="keyword2">(</span><span class="keyword2">)</span> <span class="keyword2">=</span> printf <span class="keyword7">&quot;Creating obj %d\n&quot;</span> x <span class="keyword4">in</span>
    <span class="keyword4">object</span> 
      <span class="keyword4">val</span> field <span class="keyword2">=</span> printf <span class="keyword7">&quot;Initializing field\n&quot;</span><span class="keyword2">;</span> x
    <span class="keyword4">end</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout">class obj : int -&gt; object val field : int end
</div># <span class="keyword4">let</span> o <span class="keyword2">=</span> <span class="keyword1">new</span> obj <span class="keyword8">3</span> <span class="keyword2">;</span><span class="keyword2">;</span><div class="rwocodeout"><br/>Creating obj 3
Initializing field
val o : obj = &lt;obj&gt;
</div></code></pre><div class="rwocodeinfo">OCaml Utop ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes/initializer.topscript">classes/initializer.topscript</a>  ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9639184">
      However, these expressions are executed before the object has been
      created, and cannot refer to the methods of the object. If you
      need to use an object's methods during instantiation you can use
      an initializer. An initializer is an expression that will be
      executed during instantiation but after the object has been
      created.
    </p><p id="idp9639952">
      For example, suppose we wanted to extend our previous shapes
      module with a <code>growing_circle</code> class for circles
      that expand when clicked. We could inherit from
      <code>circle</code> and used the inherited
      <code>on_click</code> to add a handler for click events.
    </p><div class="rwocode"><pre><code><span class="keyword4">class</span> growing_circle r x y <span class="keyword2">=</span> <span class="keyword4">object</span><span class="keyword2">(</span>self<span class="keyword2">)</span>
  <span class="keyword4">inherit</span> circle r x y

  <span class="keyword4">initializer</span>
    self<span class="keyword7">#on_click</span> <span class="keyword2">(</span><span class="keyword1">fun</span> _x _y -<span class="keyword2">&gt;</span> radius <span class="keyword2">&lt;</span>- radius <span class="keyword2">*</span> <span class="keyword8">2</span><span class="keyword2">)</span>
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/shapes.ml">classes-async/shapes.ml</a> , continued (part 3) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div></section><section><h1 id="multiple-inheritance">Multiple inheritance</h1><p id="idp9644656">
      When a class inherits from more than one superclass, it is using
      <span><em>multiple inheritance</em></span>. Multiple inheritance
      extends the variety of ways in which classes can be combined, and
      it can be quite useful, particularly with virtual classes.
      However, it can be tricky to use, particularly when the
      inheritance hierarchy is a graph rather than a tree, so it should
      be used with care.
    </p><section><h1 id="how-names-are-resolved">How names are resolved</h1><p id="idp9646976">
        The main trickiness of multiple inheritance is due to
        naming—what happens when a method or field with some name is
        defined in more than one class?
      </p><p id="idp9647744">
        If there is one thing to remember about inheritance in OCaml, it
        is this: inheritance is like textual inclusion. If there is more
        than one definition for a name, the last definition wins.
      </p><p id="idp9648368">
        For example, consider this class which inherits from
        <code>square</code> and defines a new
        <code>draw</code> method that uses
        <code>draw_rect</code> instead of
        <code>fill_rect</code> to draw the square.
      </p><div class="rwocode"><pre><code><span class="keyword4">class</span> square_outline w x y <span class="keyword2">=</span> <span class="keyword4">object</span>
  <span class="keyword4">inherit</span> square w x y
  <span class="keyword4">method</span> draw <span class="keyword2">=</span> draw_rect x y width width
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/multiple_inheritance.ml">classes-async/multiple_inheritance.ml</a> , continued (part 1) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9652496">
        Since the <code>inherit</code> declaration comes before
        the method definition, the new <code>draw</code> method
        overrides the old one, and the square is drawn using
        <code>draw_rect</code>. But, what if we had defined
        <code>square_outline</code> as follows?
      </p><div class="rwocode"><pre><code><span class="keyword4">class</span> square_outline w x y <span class="keyword2">=</span> <span class="keyword4">object</span>
  <span class="keyword4">method</span> draw <span class="keyword2">=</span> draw_rect x y w w
  <span class="keyword4">inherit</span> square w x y
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/multiple_inheritance_wrong.ml">classes-async/multiple_inheritance_wrong.ml</a> , continued (part 1) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9656672">
        Here the <code>inherit</code> declaration comes after the
        method definition, so the <code>draw</code> method from
        <code>square</code> will override the other definition,
        and the square will be drawn using <code>fill_rect</code>.
      </p><p id="idp9660080">
        To reiterate, to understand what inheritance means, replace each
        <code>inherit</code> directive with its definition, and
        take the last definition of each method or field. Note that the
        methods and fields added by an inheritance are those listed in
        its class type, so private methods that are hidden by the type
        will not be included.
      </p></section><section><h1 id="mixins">Mixins</h1><p id="idp9662832">
        When should you use multiple inheritance? If you ask multiple
        people, you're likely to get multiple (perhaps heated) answers.
        Some will argue that multiple inheritance is overly complicated;
        others will argue that inheritance is problematic in general,
        and one should use object composition instead. But regardless of
        who you talk to, you will rarely hear that multiple inheritance
        is great and you should use it widely.
      </p><p id="idp9663712">
        In any case, if you're programming with objects, there's one
        general pattern for multiple inheritance that is both useful and
        reasonably simple, the <span><em>mixin</em></span> pattern.
        Generically, a <span><em>mixin</em></span> is just a virtual
        class that implements a feature based on another one. If you
        have a class that implements methods <span><em>A</em></span>, and
        you have a mixin <span><em>M</em></span> that provides methods
        <span><em>B</em></span> from <span><em>A</em></span>, then you can
        inherit from <span><em>M</em></span>—&quot;mixing&quot; it in—to
        get features <span><em>B</em></span>.
      </p><p id="idp9668000">
        That's too abstract, so let's give some examples based on our
        interactive shapes. We may wish to allow a shape to be dragged
        by the mouse. We can define this functionality for any object
        which has mutable <code>x</code> and <code>y</code>
        fields and an <code>on_mousedown</code> method for adding
        event handlers:
      </p><div class="rwocode"><pre><code><span class="keyword4">class</span> <span class="keyword4">virtual</span> draggable <span class="keyword2">=</span> <span class="keyword4">object</span><span class="keyword2">(</span>self<span class="keyword2">)</span>
  <span class="keyword4">method</span> <span class="keyword4">virtual</span> on_mousedown<span class="keyword2">:</span> 
    ?start<span class="keyword2">:</span>unit <span class="keyword5">Deferred.</span>t -<span class="keyword2">&gt;</span> 
    ?stop<span class="keyword2">:</span>unit <span class="keyword5">Deferred.</span>t -<span class="keyword2">&gt;</span> 
    <span class="keyword2">(</span><span class="keyword3">int</span> -<span class="keyword2">&gt;</span> <span class="keyword3">int</span> -<span class="keyword2">&gt;</span> unit<span class="keyword2">)</span> -<span class="keyword2">&gt;</span> unit
  <span class="keyword4">val</span> <span class="keyword4">virtual</span> <span class="keyword1">mutable</span> x<span class="keyword2">:</span> <span class="keyword3">int</span>  
  <span class="keyword4">val</span> <span class="keyword4">virtual</span> <span class="keyword1">mutable</span> y<span class="keyword2">:</span> <span class="keyword3">int</span>  

  <span class="keyword4">val</span> <span class="keyword1">mutable</span> dragging <span class="keyword2">=</span> false
  <span class="keyword4">method</span> dragging <span class="keyword2">=</span> dragging

  <span class="keyword4">initializer</span> 
    self<span class="keyword7">#on_mousedown</span> 
      <span class="keyword2">(</span><span class="keyword1">fun</span> mouse_x mouse_y -<span class="keyword2">&gt;</span>
         <span class="keyword4">let</span> offset_x <span class="keyword2">=</span> x - mouse_x <span class="keyword4">in</span>
         <span class="keyword4">let</span> offset_y <span class="keyword2">=</span> y - mouse_y <span class="keyword4">in</span>
         <span class="keyword4">let</span> mouse_up <span class="keyword2">=</span> <span class="keyword5">Ivar.</span>create <span class="keyword2">(</span><span class="keyword2">)</span> <span class="keyword4">in</span>
         <span class="keyword4">let</span> stop <span class="keyword2">=</span> <span class="keyword5">Ivar.</span>read mouse_up <span class="keyword4">in</span>
         dragging <span class="keyword2">&lt;</span>- true<span class="keyword2">;</span>
         on_mouseup ~stop
           <span class="keyword2">(</span><span class="keyword1">fun</span> <span class="keyword8">_</span> -<span class="keyword2">&gt;</span>
              <span class="keyword5">Ivar.</span>fill mouse_up <span class="keyword2">(</span><span class="keyword2">)</span><span class="keyword2">;</span>
              dragging <span class="keyword2">&lt;</span>- false<span class="keyword2">)</span><span class="keyword2">;</span>
         on_mousemove ~stop
           <span class="keyword2">(</span><span class="keyword1">fun</span> ev -<span class="keyword2">&gt;</span>
              x <span class="keyword2">&lt;</span>- ev.mouse_x <span class="keyword2">+</span> offset_x<span class="keyword2">;</span>
              y <span class="keyword2">&lt;</span>- ev.mouse_y <span class="keyword2">+</span> offset_y<span class="keyword2">)</span><span class="keyword2">)</span>
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/shapes.ml">classes-async/shapes.ml</a> , continued (part 4) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9671488">
        This allows us to create draggable shapes using multiple
        inheritance.
      </p><div class="rwocode"><pre><code><span class="keyword4">class</span> small_square <span class="keyword2">=</span> <span class="keyword4">object</span>
  <span class="keyword4">inherit</span> square <span class="keyword8">20</span> <span class="keyword8">40</span> <span class="keyword8">40</span>
  <span class="keyword4">inherit</span> draggable 
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/shapes.ml">classes-async/shapes.ml</a> , continued (part 5) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9672704">
        We can also use mixins to create animated shapes. Each animated
        shape has a list of update functions to be called during
        animation. We create an <code>animated</code> mixin to
        provide this update list and ensure that the functions in it are
        called regular intervals when the shape is animated.
      </p><div class="rwocode"><pre><code><span class="keyword4">class</span> <span class="keyword4">virtual</span> animated span <span class="keyword2">=</span> <span class="keyword4">object</span><span class="keyword2">(</span>self<span class="keyword2">)</span>
  <span class="keyword4">method</span> <span class="keyword4">virtual</span> on_click<span class="keyword2">:</span> 
    ?start<span class="keyword2">:</span>unit <span class="keyword5">Deferred.</span>t -<span class="keyword2">&gt;</span> 
    ?stop<span class="keyword2">:</span>unit <span class="keyword5">Deferred.</span>t -<span class="keyword2">&gt;</span> 
    <span class="keyword2">(</span><span class="keyword3">int</span> -<span class="keyword2">&gt;</span> <span class="keyword3">int</span> -<span class="keyword2">&gt;</span> unit<span class="keyword2">)</span> -<span class="keyword2">&gt;</span> unit
  <span class="keyword4">val</span> <span class="keyword1">mutable</span> updates<span class="keyword2">:</span> <span class="keyword2">(</span><span class="keyword3">int</span> -<span class="keyword2">&gt;</span> unit<span class="keyword2">)</span> <span class="keyword3">list</span> <span class="keyword2">=</span> <span class="keyword2">[</span><span class="keyword2">]</span>
  <span class="keyword4">val</span> <span class="keyword1">mutable</span> step <span class="keyword2">=</span> <span class="keyword8">0</span>
  <span class="keyword4">val</span> <span class="keyword1">mutable</span> running <span class="keyword2">=</span> false

  <span class="keyword4">method</span> running <span class="keyword2">=</span> running

  <span class="keyword4">method</span> animate <span class="keyword2">=</span>
    step <span class="keyword2">&lt;</span>- <span class="keyword8">0</span><span class="keyword2">;</span>
    running <span class="keyword2">&lt;</span>- true<span class="keyword2">;</span>
    <span class="keyword4">let</span> stop <span class="keyword2">=</span>
      <span class="keyword5">Clock.</span>after span
      <span class="keyword1">&gt;&gt;</span><span class="keyword2">|</span> <span class="keyword1">fun</span> <span class="keyword2">(</span><span class="keyword2">)</span> -<span class="keyword2">&gt;</span> running <span class="keyword2">&lt;</span>- false 
    <span class="keyword4">in</span>
    <span class="keyword5">Clock.</span>every ~stop <span class="keyword2">(</span><span class="keyword5">Time.</span><span class="keyword5">Span.</span>of_sec <span class="keyword2">(</span><span class="keyword8">1</span>.<span class="keyword8">0</span> /. <span class="keyword8">24</span>.<span class="keyword8">0</span><span class="keyword2">)</span><span class="keyword2">)</span>
      <span class="keyword2">(</span><span class="keyword1">fun</span> <span class="keyword2">(</span><span class="keyword2">)</span> -<span class="keyword2">&gt;</span>
         step <span class="keyword2">&lt;</span>- step <span class="keyword2">+</span> <span class="keyword8">1</span><span class="keyword2">;</span>
         <span class="keyword5">List.</span>iter ~f<span class="keyword2">:</span><span class="keyword2">(</span><span class="keyword1">fun</span> f -<span class="keyword2">&gt;</span> f step<span class="keyword2">)</span> updates
      <span class="keyword2">)</span>

  <span class="keyword4">initializer</span>
    self<span class="keyword7">#on_click</span> <span class="keyword2">(</span><span class="keyword1">fun</span> _x _y -<span class="keyword2">&gt;</span> <span class="keyword1">if</span> not self<span class="keyword7">#running</span> <span class="keyword1">then</span> self<span class="keyword7">#animate</span><span class="keyword2">)</span>
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/shapes.ml">classes-async/shapes.ml</a> , continued (part 6) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9674848">
        We use initializers to add functions to this update list. For
        example, this class will produce circles that move to the right
        for a second when clicked:
      </p><div class="rwocode"><pre><code><span class="keyword4">class</span> my_circle <span class="keyword2">=</span> <span class="keyword4">object</span>
  <span class="keyword4">inherit</span> circle <span class="keyword8">20</span> <span class="keyword8">50</span> <span class="keyword8">50</span>
  <span class="keyword4">inherit</span> animated <span class="keyword5">Time.</span><span class="keyword5">Span.</span>second
  <span class="keyword4">initializer</span> updates <span class="keyword2">&lt;</span>- <span class="keyword2">[</span><span class="keyword1">fun</span> <span class="keyword8">_</span> -<span class="keyword2">&gt;</span> x <span class="keyword2">&lt;</span>- x <span class="keyword2">+</span> <span class="keyword8">5</span><span class="keyword2">]</span>
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/shapes.ml">classes-async/shapes.ml</a> , continued (part 7) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9676160">
        These initializers can also be added using mixins:
      </p><div class="rwocode"><pre><code><span class="keyword4">class</span> <span class="keyword4">virtual</span> linear x' y' <span class="keyword2">=</span> <span class="keyword4">object</span>
  <span class="keyword4">val</span> <span class="keyword4">virtual</span> <span class="keyword1">mutable</span> updates<span class="keyword2">:</span> <span class="keyword2">(</span><span class="keyword3">int</span> -<span class="keyword2">&gt;</span> unit<span class="keyword2">)</span> <span class="keyword3">list</span>
  <span class="keyword4">val</span> <span class="keyword4">virtual</span> <span class="keyword1">mutable</span> x<span class="keyword2">:</span> <span class="keyword3">int</span>
  <span class="keyword4">val</span> <span class="keyword4">virtual</span> <span class="keyword1">mutable</span> y<span class="keyword2">:</span> <span class="keyword3">int</span>

  <span class="keyword4">initializer</span>
    <span class="keyword4">let</span> update <span class="keyword8">_</span> <span class="keyword2">=</span>
      x <span class="keyword2">&lt;</span>- x <span class="keyword2">+</span> x'<span class="keyword2">;</span>
      y <span class="keyword2">&lt;</span>- y <span class="keyword2">+</span> y'
    <span class="keyword4">in</span>
    updates <span class="keyword2">&lt;</span>- update <span class="keyword2">:</span><span class="keyword2">:</span> updates
<span class="keyword4">end</span>

<span class="keyword4">let</span> pi <span class="keyword2">=</span> <span class="keyword2">(</span>atan <span class="keyword8">1</span>.<span class="keyword8">0</span><span class="keyword2">)</span> <span class="keyword2">*</span>. <span class="keyword8">4</span>.<span class="keyword8">0</span>

<span class="keyword4">class</span> <span class="keyword4">virtual</span> harmonic offset x' y' <span class="keyword2">=</span> <span class="keyword4">object</span>
  <span class="keyword4">val</span> <span class="keyword4">virtual</span> <span class="keyword1">mutable</span> updates<span class="keyword2">:</span> <span class="keyword2">(</span><span class="keyword3">int</span> -<span class="keyword2">&gt;</span> unit<span class="keyword2">)</span> <span class="keyword3">list</span>
  <span class="keyword4">val</span> <span class="keyword4">virtual</span> <span class="keyword1">mutable</span> x<span class="keyword2">:</span> <span class="keyword3">int</span>
  <span class="keyword4">val</span> <span class="keyword4">virtual</span> <span class="keyword1">mutable</span> y<span class="keyword2">:</span> <span class="keyword3">int</span>

  <span class="keyword4">initializer</span>
    <span class="keyword4">let</span> update step <span class="keyword2">=</span>
      <span class="keyword4">let</span> m <span class="keyword2">=</span> sin <span class="keyword2">(</span>offset <span class="keyword2">+</span>. <span class="keyword2">(</span><span class="keyword2">(</span><span class="keyword5">Float.</span>of_int step<span class="keyword2">)</span> <span class="keyword2">*</span>. <span class="keyword2">(</span>pi /. <span class="keyword8">64</span>.<span class="keyword2">)</span><span class="keyword2">)</span><span class="keyword2">)</span> <span class="keyword4">in</span>
      <span class="keyword4">let</span> x' <span class="keyword2">=</span> <span class="keyword5">Float.</span>to_int <span class="keyword2">(</span>m <span class="keyword2">*</span>. <span class="keyword5">Float.</span>of_int x'<span class="keyword2">)</span> <span class="keyword4">in</span>
      <span class="keyword4">let</span> y' <span class="keyword2">=</span> <span class="keyword5">Float.</span>to_int <span class="keyword2">(</span>m <span class="keyword2">*</span>. <span class="keyword5">Float.</span>of_int y'<span class="keyword2">)</span> <span class="keyword4">in</span>
      x <span class="keyword2">&lt;</span>- x <span class="keyword2">+</span> x'<span class="keyword2">;</span>
      y <span class="keyword2">&lt;</span>- y <span class="keyword2">+</span> y'
    <span class="keyword4">in</span>
    updates <span class="keyword2">&lt;</span>- update <span class="keyword2">:</span><span class="keyword2">:</span> updates
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/shapes.ml">classes-async/shapes.ml</a> , continued (part 8) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9677344">
        Since the <code>linear</code> and
        <code>harmonic</code> mixins are only used for there
        side-effects, they can be inherited multiple times within the
        same object to produce a variety of different animations.
      </p><div class="rwocode"><pre><code><span class="keyword4">class</span> my_square x y <span class="keyword2">=</span> <span class="keyword4">object</span>
  <span class="keyword4">inherit</span> square <span class="keyword8">40</span> x y
  <span class="keyword4">inherit</span> draggable
  <span class="keyword4">inherit</span> animated <span class="keyword2">(</span><span class="keyword5">Time.</span><span class="keyword5">Span.</span>of_int_sec <span class="keyword8">5</span><span class="keyword2">)</span>
  <span class="keyword4">inherit</span> linear <span class="keyword8">5</span> <span class="keyword8">0</span>
  <span class="keyword4">inherit</span> harmonic <span class="keyword8">0</span>.<span class="keyword8">0</span> <span class="keyword8">7</span> ~<span class="keyword8">-10</span>
<span class="keyword4">end</span>

<span class="keyword4">let</span> my_circle <span class="keyword2">=</span> <span class="keyword4">object</span>
  <span class="keyword4">inherit</span> circle <span class="keyword8">30</span> <span class="keyword8">250</span> <span class="keyword8">250</span>
  <span class="keyword4">inherit</span> animated <span class="keyword2">(</span><span class="keyword5">Time.</span><span class="keyword5">Span.</span>minute<span class="keyword2">)</span>
  <span class="keyword4">inherit</span> harmonic <span class="keyword8">0</span>.<span class="keyword8">0</span> <span class="keyword8">10</span> <span class="keyword8">0</span>
  <span class="keyword4">inherit</span> harmonic <span class="keyword2">(</span>pi /. <span class="keyword8">2</span>.<span class="keyword8">0</span><span class="keyword2">)</span> <span class="keyword8">0</span> <span class="keyword8">10</span>
<span class="keyword4">end</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/shapes.ml">classes-async/shapes.ml</a> , continued (part 9) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div></section><section><h1 id="displaying-the-animated-shapes">Displaying the animated shapes</h1><p id="idp9681408">
        We finish our shapes module by creating a
        <code>main</code> function to draw some shapes on the
        graphical display, and running that function using the Async
        scheduler.
      </p><div class="rwocode"><pre><code><span class="keyword4">let</span> main <span class="keyword2">(</span><span class="keyword2">)</span> <span class="keyword2">=</span>
  <span class="keyword4">let</span> shapes <span class="keyword2">=</span> <span class="keyword2">[</span> 
     <span class="keyword2">(</span>my_circle <span class="keyword2">:</span><span class="keyword2">&gt;</span> drawable<span class="keyword2">)</span><span class="keyword2">;</span> 
     <span class="keyword2">(</span><span class="keyword1">new</span> my_square <span class="keyword8">50</span> <span class="keyword8">350</span> <span class="keyword2">:</span><span class="keyword2">&gt;</span> drawable<span class="keyword2">)</span><span class="keyword2">;</span> 
     <span class="keyword2">(</span><span class="keyword1">new</span> my_square <span class="keyword8">50</span> <span class="keyword8">200</span> <span class="keyword2">:</span><span class="keyword2">&gt;</span> drawable<span class="keyword2">)</span><span class="keyword2">;</span>
     <span class="keyword2">(</span><span class="keyword1">new</span> growing_circle <span class="keyword8">20</span> <span class="keyword8">70</span> <span class="keyword8">70</span> <span class="keyword2">:</span><span class="keyword2">&gt;</span> drawable<span class="keyword2">)</span><span class="keyword2">;</span>
  <span class="keyword2">]</span> <span class="keyword4">in</span>
  <span class="keyword4">let</span> repaint <span class="keyword2">(</span><span class="keyword2">)</span> <span class="keyword2">=</span>
    clear_graph <span class="keyword2">(</span><span class="keyword2">)</span><span class="keyword2">;</span>
    <span class="keyword5">List.</span>iter ~f<span class="keyword2">:</span><span class="keyword2">(</span><span class="keyword1">fun</span> s -<span class="keyword2">&gt;</span> s<span class="keyword7">#draw</span><span class="keyword2">)</span> shapes<span class="keyword2">;</span>
    synchronize <span class="keyword2">(</span><span class="keyword2">)</span>
  <span class="keyword4">in</span> 
    open_graph <span class="keyword7">&quot;&quot;</span><span class="keyword2">;</span>
    auto_synchronize false<span class="keyword2">;</span>
    <span class="keyword5">Clock.</span>every <span class="keyword2">(</span><span class="keyword5">Time.</span><span class="keyword5">Span.</span>of_sec <span class="keyword2">(</span><span class="keyword8">1</span>.<span class="keyword8">0</span> /. <span class="keyword8">24</span>.<span class="keyword8">0</span><span class="keyword2">)</span><span class="keyword2">)</span> repaint

<span class="keyword4">let</span> <span class="keyword2">(</span><span class="keyword2">)</span> <span class="keyword2">=</span> never_returns <span class="keyword2">(</span><span class="keyword5">Scheduler.</span>go_main ~main <span class="keyword2">(</span><span class="keyword2">)</span><span class="keyword2">)</span></code></pre><div class="rwocodeinfo">OCaml ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/shapes.ml">classes-async/shapes.ml</a> , continued (part 10) ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9683424">
        Our <code>main</code> function creates a list of shapes to
        be displayed and defines a <code>repaint</code> function
        that actually draws them on the display. We then open a
        graphical display and ask Async to run
        <code>repaint</code> at regular intervals.
      </p><p id="idp9686192">
        Finally, build the binary by linking against the
        <code>async_graphics</code> package, which will pull in
        all the other dependencies.
      </p><div class="rwocode"><pre><code><div class="highlight"><span class="gp">$</span> corebuild -pkg async_graphics shapes.native
</div></code></pre><div class="rwocodeinfo">Terminal ∗ <a href="http://github.com/realworldocaml/examples/blob/master/code/classes-async/build_shapes.out">classes-async/build_shapes.out</a>  ∗ <a href="http://github.com/realworldocaml/examples/">all code</a></div></div><p id="idp9688144">
        When you run the binary, a new graphical window should appear
        (on MacOS X, you will need to install the X11 package first,
        which you will be prompted for). Try clicking on the various
        widgets, and gasp in awe at the sophisticated animations that
        unfold as a result.
      </p><p id="idp9688864">
        The graphics library described here is the one built into OCaml,
        and is more useful as a learning tool than anything else. There
        are several third-party libraries that provide more
        sophisticated bindings to various graphics subsystems.
      </p><ul><li><p id="idp9690048">
<a href="http://lablgtk.forge.ocamlcore.org" target="_top">Lablgtk</a>
            is a strongly-typed interface to the GTK widget library.
          </p></li><li><p id="idp9691616">
<a href="https://forge.ocamlcore.org/projects/lablgl/" target="_top">LablGL</a>
            is an interface between OCaml and OpenGL, a widely supported
            standard for 3D rendering.
          </p></li><li><p id="idp9693248">
<a href="http://ocsigen.org/js_of_ocaml/api/Js" target="_top">js_of_ocaml</a>
            compiles OCaml code to JavaScript, and has bindings to
            WebGL. This is the emerging standard for 3D rendering in web
            browsers.
          </p></li></ul><aside class="note"><h1>
      Production note
      </h1><p id="idp9695472">
        This chapter contains significant external contributions from
        Leo White.
      </p></aside></section></section>


                
            </article>
            
            
    
                <nav class="pagination">
                    
                        <a rel="previous" href="objects.html">
                            &lt; Previous
                        </a>
                    
                    
                        <a rel="next" href="pt02.html">
                            Next &gt;
                        </a>
                    
                </nav>
            
            
            
            <footer class="footer">
                <p>Copyright 2012-2013, Jason Hickey, Anil Madhavapeddy and Yaron Minsky. Licensed under <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/us/">CC BY-NC-ND 3.0 US</a>.</p>
            </footer>
            
        </div>
    
    </body>

</html>