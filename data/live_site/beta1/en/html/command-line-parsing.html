<html>

    <head>
    
        <meta charset="utf-8"/>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta name="robots" content="NOINDEX, NOARCHIVE, NOFOLLOW"/>
        
        <title>Chapter 14. Command Line Parsing / Real World OCaml</title>
        
        <link rel="stylesheet" href="../../media/css/main.css"/>
        
        <script src="../../media/js/require.js" data-main="../../media/js/main.js"> </script>
        <script>
            require.config({
                config: {
                    gitHub: {
                        user: 'ocamllabs',
                        repo: 'rwo\u002Dcomments',
                        milestone: 'beta1',
                        page: 'command\u002Dline\u002Dparsing.html'
                    }
                }
            });
        </script>
        
    
    </head>
    
    <body>
    
        <div class="body">
        
            <header class="header">
                <h1><img src="../../media/img/header.png" width="213" height="59" alt="Real World OCaml, by Jason Hickey, Anil Madhavapeddy and Yaron Minsky"/></h1>
            </header>
    
            <nav class="navigation">
                <ul>
                    <li>
                        <a href="index.html">Table of Contents</a>
                    </li>
                    
                        <li>
                            <a href="prologue.html">Prologue</a>
                            
                                
                            
                        </li>
                    
                        <li>
                            <a href="pt01.html">I. Language Concepts</a>
                            
                                
                            
                        </li>
                    
                        <li>
                            <a href="pt02.html">II. Tools and Techniques</a>
                            
                                 
                                    <ul>
                                        
                                            <li>
                                                <a href="maps-and-hashtables.html">13. Maps and Hashtables</a>
                                            </li>
                                        
                                            <li>
                                                <a href="command-line-parsing.html" class="here">14. Command Line Parsing</a>
                                            </li>
                                        
                                            <li>
                                                <a href="handling-json-data.html">15. Handling JSON data</a>
                                            </li>
                                        
                                            <li>
                                                <a href="parsing-with-ocamllex-and-menhir.html">16. Parsing with OCamllex and Menhir</a>
                                            </li>
                                        
                                            <li>
                                                <a href="data-serialization-with-s-expressions.html">17. Data Serialization with S-Expressions</a>
                                            </li>
                                        
                                            <li>
                                                <a href="concurrent-programming-with-async.html">18. Concurrent Programming with Async</a>
                                            </li>
                                        
                                            <li>
                                                <a href="fast-binary-serialization.html">19. Fast Binary Serialization</a>
                                            </li>
                                        
                                    </ul>
                                
                            
                        </li>
                    
                        <li>
                            <a href="pt03.html">III. The Runtime System</a>
                            
                                
                            
                        </li>
                    
                        <li>
                            <a href="installation.html">A. Installation</a>
                            
                                
                            
                        </li>
                    
                        <li>
                            <a href="packaging.html">B. Packaging</a>
                            
                                
                            
                        </li>
                    
                </ul>
            </nav>
        
            <article class="page">
        
                <h1>Chapter 14. Command Line Parsing</h1>
                
                

    <p id="idp10148368">
    Many of the OCaml programs that you'll write will end up as binaries
    that need to be run from a command prompt. Any non-trivial
    command-line program needs a few features:
  </p><ul><li><p id="idp10149472">
        program options and file inputs need to be parsed from the
        command line arguments.
      </p></li><li><p id="idp10150368">
        sensible error messages have to be generated in response to
        incorrect inputs.
      </p></li><li><p id="idp10151248">
        help needs to be shown for all the available options.
      </p></li><li><p id="idp10152096">
        interactive auto-completion of commands to assist the user.
      </p></li></ul><p id="idp10152832">
    It's tedious and error-prone to code all this manually for every
    program you write. Core provides the Command library that simplifies
    all this by letting you declare all your command-line options in one
    place. Command takes care of parsing the arguments, generating help
    text and provides interactive auto-completion to the user of the
    library.
  </p><p id="idp10153600">
    Command also copes as you add more features to your programs. It's a
    simple library to use for small applications, and provides a
    sophisticated subcommand mode that grouping related commands
    together as the number of options grow. You may already be familiar
    with this command-line style from the Git or Mercurial version
    control systems.
  </p><p id="idp10154368">
    In this chapter, we'll:
  </p><ul><li><p id="idp10155312">
        learn how to use Command to construct basic and grouped
        command-line interfaces.
      </p></li><li><p id="idp10156208">
        read examples that extend the cryptographic utility from
        <a href="classes.html">Chapter 12, <i>Classes</i></a> and build a simple
        equivalent to the <code>md5</code> and
        <code>shasum</code> utilities.
      </p></li><li><p id="idp10159184">
        demonstrate how <span><em>functional combinators</em></span> can
        be used to declare complex data structures in a type-safe and
        elegant way.
      </p></li></ul><section><h1 id="basic-command-line-parsing">Basic command-line parsing</h1><p id="idp10161536">
      Let's start by cloning the <code>md5</code> binary that is
      present on most Linux and Mac OS X installations. It reads in the
      contents of a file, applies the MD5 one-way cryptographic hash
      function to the data, and outputs an ASCII hex representation of
      the result.
    </p><div class="highlight"><pre><span class="c">(* basic_md5.ml : calculate MD5 hash of input *)</span>
<span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">do_hash</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">open</span> <span class="nc">Cryptokit</span> <span class="k">in</span>
  <span class="nn">In_channel</span><span class="p">.</span><span class="n">read_all</span> <span class="n">file</span>
  <span class="o">|&gt;</span> <span class="n">hash_string</span> <span class="o">(</span><span class="nn">Hash</span><span class="p">.</span><span class="n">md5</span> <span class="bp">()</span><span class="o">)</span>
  <span class="o">|&gt;</span> <span class="n">transform_string</span> <span class="o">(</span><span class="nn">Hexa</span><span class="p">.</span><span class="n">encode</span> <span class="bp">()</span><span class="o">)</span>
  <span class="o">|&gt;</span> <span class="n">print_endline</span>

<span class="k">let</span> <span class="n">command</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span>
    <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Generate an MD5 hash of the input data&quot;</span>
    <span class="o">~</span><span class="n">readme</span><span class="o">:(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="s2">&quot;More detailed information&quot;</span><span class="o">)</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;filename&quot;</span> <span class="o">%:</span> <span class="kt">string</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">filename</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">do_hash</span> <span class="n">filename</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">version</span><span class="o">:</span><span class="s2">&quot;1.0&quot;</span> <span class="o">~</span><span class="n">build_info</span><span class="o">:</span><span class="s2">&quot;RWO&quot;</span> <span class="n">command</span>
</pre></div><p id="idp10164480">
      You can compile this file the usual way with
      <code>ocamlfind</code> by passing an additional
      <code>cryptokit</code> package. Install Cryptokit via OPAM
      if you didn't do so earlier.
    </p><pre id="idp10166464">
$ opam install cryptokit
$ ocamlfind ocamlopt -thread -package cryptokit -package core -linkpkg \
  -o md5 basic_md5.ml
$ ./md5
</pre><p id="idp10167264">
      The <code>do_hash</code> function accepts a filename
      parameter and prints the human-readable MD5 string to the console
      standard output.
    </p><p id="idp10168512">
      The subsequent <code>command</code> variable defines how to
      invoke <code>do_hash</code> by parsing the command-line
      arguments. When you compile and run this program, it already
      defines a number of useful default command-line options.
    </p><p id="idp10170528">
      For instance, query the version information for the binary you
      just compiled.
    </p><pre id="idp10171024">
$ ./md5 -version
1.0
$ ./md5 -build-info
RWO
</pre><p id="idp10171744">
      The actual versions are defined via optional arguments to
      <code>Command.run</code>. You can leave these blank or get
      your build system to generate them directly from your version
      control system (e.g. by running <code>hg tip</code> to
      generate a build revision number, in the case of Mercurial).
    </p><pre id="idp10173840">
$ ./md5
Generate an MD5 hash of the input data

  md5 filename

More detailed information

=== flags ===

  [-build-info]  print info about this build and exit
  [-version]     print the version of this build and exit
  [-help]        print this help text and exit
                 (alias: -?)

missing anonymous argument: filename
</pre><p id="idp10174848">
      When we invoke this binary without any arguments, it helpfully
      displays a help screen that informs you that a required argument
      <code>filename</code> is missing.
    </p><p id="idp10176112">
      If you do supply the filename argument, then
      <code>do_hash</code> is called with the argument and the MD5
      output is displayed to the standard output.
    </p><pre id="idp10177376">
$ ./md5 ./md5
59562f5e4f790d16f1b2a095cd5de844
</pre></section><section><h1 id="defining-parsing-specifications">Defining parsing specifications</h1><p id="idp10179424">
      So how does all this work? Most of the interesting logic lies in
      how the specifications are constructed.
    </p><p id="idp10179952">
      The <code>Command.Spec</code> module defines several
      combinators that can be chained together to define flags and
      anonymous arguments, what types they should map to, and whether to
      take special actions (such as interactive input) if certain fields
      are encountered.
    </p><section><h1 id="anonymous-arguments">Anonymous arguments</h1><p id="idp10182496">
        Let's build the specification for a single argument that is
        specified directly on the command-line (this is known as an
        <span><em>anonymous</em></span> argument).
      </p><div class="highlight"><pre><span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
  <span class="n">empty</span>
  <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;filename&quot;</span> <span class="o">%:</span> <span class="kt">string</span><span class="o">)</span>
<span class="o">)</span>
</pre></div><p id="idp10184576">
        The specification above begins with an <code>empty</code>
        value and then adds more parameters via the
        <code>+&gt;</code> combinator. Our example uses the
        <code>anon</code> function to define a single anonymous
        parameter.
      </p><p id="idp10187312">
        Anonymous parameters are created using the <code>%:</code>
        operator, which binds a textual string name (used in the help
        text) to an OCaml conversion function. The conversion function
        is responsible for parsing the command-line fragment into an
        OCaml data type. In the example above, this is just a
        <code>string</code>, but we'll see more complex conversion
        options below.
      </p></section><section><h1 id="callback-functions">Callback functions</h1><p id="idp10190816">
        This specification is usually combined with a callback function
        that accepts all the command-line parameters as its function
        arguments. Multiple arguments are passed to the callback in the
        same order as they appeared in the specification (using the
        <code>+&gt;</code> operator).
      </p><p id="idp10192224">
        The callback function is where all the actual work happens after
        the command-line parsing is complete. This function is applied
        with the arguments containing the parsed command-line arguments,
        and takes over as the main thread of the application.
      </p><p id="idp10192912">
        In our example, we had just one anonymous argument, so the
        callback function just has a single <code>string</code>
        parameter applied to it:
      </p><div class="highlight"><pre><span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">do_hash</span> <span class="n">file</span><span class="o">)</span>
</pre></div><aside class="note"><h1>
      The extra unit argument to callbacks
      </h1><p id="idp10196560">
        The callback above needs an extra <code>unit</code>
        argument after <code>file</code>. This is to ensure that
        specifications can work even when they are empty (i.e. the
        <code>Command.Spec.empty</code> value).
      </p><p id="idp10199264">
        Every OCaml function needs at least one argument, so the final
        <code>unit</code> guarantees that it will not be evaluated
        immediately as a value if there are no other arguments.
      </p></aside></section><section><h1 id="creating-basic-commands">Creating basic commands</h1><p id="idp10201968">
        The specification and the function callback are glued together
        using the <code>basic</code> command. Let's see how this
        looks in our <code>md5</code> command.
      </p><div class="highlight"><pre><span class="nn">Command</span><span class="p">.</span><span class="n">basic</span>
  <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Generate an MD5 hash of the input data&quot;</span>
  <span class="o">~</span><span class="n">readme</span><span class="o">:(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="s2">&quot;More detailed information&quot;</span><span class="o">)</span>
  <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
    <span class="n">empty</span>
    <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;filename&quot;</span> <span class="o">%:</span> <span class="kt">string</span><span class="o">)</span>
  <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">filename</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">do_hash</span> <span class="n">filename</span><span class="o">)</span>
</pre></div><p id="idp10205296">
        The <code>basic</code> function takes the following
        arguments:
      </p><ul><li><p id="idp10206976">
<code>summary</code> is a required one-line
            description to go at the top of the command help screen.
          </p></li><li><p id="idp10208544">
<code>readme</code> is for longer help text when the
            command is called with <code>-help</code>. The
            <code>readme</code> argument is a function that is
            only evaluated when the help text is actually needed.
          </p></li><li><p id="idp10211616">
            The specification and the callback function follow, with the
            arguments to the callback matching the order in which the
            specification binds arguments.
          </p></li></ul></section><section><h1 id="command-argument-types">Command argument types</h1><p id="idp10213744">
        You aren't just limited to parsing command lines as strings, of
        course. The <code>Command.Spec</code> module defines
        several other conversion functions that validate and parse input
        into various types:
      </p><table><thead><tr><th>
                Argument type
              </th><th>
                OCaml type
              </th><th>
                Example
              </th></tr></thead><tbody><tr><td>
<code>string</code>
</td><td>
<code>string</code>
</td><td>
<code>foo</code>
</td></tr><tr><td>
<code>int</code>
</td><td>
<code>int</code>
</td><td>
<code>123</code>
</td></tr><tr><td>
<code>float</code>
</td><td>
<code>float</code>
</td><td>
<code>123.01</code>
</td></tr><tr><td>
<code>bool</code>
</td><td>
<code>bool</code>
</td><td>
<code>true</code>
</td></tr><tr><td>
<code>date</code>
</td><td>
<code>Date.t</code>
</td><td>
<code>2013-12-25</code>
</td></tr><tr><td>
<code>time_span</code>
</td><td>
<code>Span.t</code>
</td><td>
<code>5s</code>
</td></tr><tr><td>
<code>file</code>
</td><td>
<code>string</code>
</td><td>
<code>/etc/passwd</code>
</td></tr></tbody></table><p id="idp10245232">
        A more realistic <code>md5</code> function might also read
        from the standard input if a filename isn't specified. We can
        change our specification with a single line to reflect this by
        writing:
      </p><div class="highlight"><pre><span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
  <span class="n">empty</span>
  <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="n">maybe</span> <span class="o">(</span><span class="s2">&quot;filename&quot;</span> <span class="o">%:</span> <span class="kt">string</span><span class="o">))</span>
<span class="o">)</span>
</pre></div><p id="idp10247616">
        The anonymous parameter has been prefixed with a
        <code>maybe</code> that indicates the value is now
        optional. If you compile the example, you'll get a type error
        though:
      </p><pre id="idp10248912">
File &quot;md5_broken.ml&quot;, line 18, characters 26-30:
Error: This expression has type string option
       but an expression was expected of type string
Command exited with code 2.
</pre><p id="idp10250016">
        This is because the type of the callback function has changed.
        It now wants a <code>string option</code> instead of a
        <code>string</code> since the value is optional. We can
        quickly adapt our example to use the new information and read
        from standard input if no file is specified.
      </p><div class="highlight"><pre><span class="c">(* md5.ml : calculate md5 with an optional filename *)</span>
<span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">get_file_data</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">None</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;-&quot;</span> <span class="o">-&gt;</span> <span class="nn">In_channel</span><span class="p">.</span><span class="err">(</span><span class="n">input_all</span> <span class="n">stdin</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">file</span> <span class="o">-&gt;</span> <span class="nn">In_channel</span><span class="p">.</span><span class="n">read_all</span> <span class="n">file</span>

<span class="k">let</span> <span class="n">do_hash</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">open</span> <span class="nc">Cryptokit</span> <span class="k">in</span>
  <span class="n">get_file_data</span> <span class="n">file</span>
  <span class="o">|&gt;</span> <span class="n">hash_string</span> <span class="o">(</span><span class="nn">Hash</span><span class="p">.</span><span class="n">md5</span> <span class="bp">()</span><span class="o">)</span>
  <span class="o">|&gt;</span> <span class="n">transform_string</span> <span class="o">(</span><span class="nn">Hexa</span><span class="p">.</span><span class="n">encode</span> <span class="bp">()</span><span class="o">)</span>
  <span class="o">|&gt;</span> <span class="n">print_endline</span>

<span class="k">let</span> <span class="n">command</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span>
    <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Generate an MD5 hash of the input data&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="n">maybe</span> <span class="o">(</span><span class="s2">&quot;filename&quot;</span> <span class="o">%:</span> <span class="kt">string</span><span class="o">))</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">do_hash</span> <span class="n">file</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="n">run</span> <span class="n">command</span>
</pre></div><p id="idp10253712">
        There are several other transformations you can do on anonymous
        arguments. We've shown you <code>maybe</code>, and you can
        also obtain lists of arguments or supply default values. Try
        altering the example above to take a list of files and output
        checksums for all of them, just as the <code>md5</code>
        command does.
      </p><table><thead><tr><th>
                Anonymous argument
              </th><th>
                OCaml type
              </th></tr></thead><tbody><tr><td>
                sequence
              </td><td>
<code>list</code> of arguments
              </td></tr><tr><td>
                maybe
              </td><td>
<code>option</code> argument
              </td></tr><tr><td>
                maybe_with_default
              </td><td>
                argument with a default value if argument is missing
              </td></tr></tbody></table><aside class="note"><h1>
      Defining your own argument types
      </h1><p id="idp10265856">
        You can also define your own argument parsers by using the
        <code>Spec.Arg_type</code> module directly. For instance,
        the <code>time_span</code> converter is defined as
        follows.
      </p><div class="highlight"><pre><span class="o">#</span> <span class="k">open</span> <span class="nn">Command</span><span class="p">.</span><span class="nc">Spec</span> <span class="o">;;</span>
<span class="o">#</span> <span class="k">let</span> <span class="n">time_span</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="nn">Arg_type</span><span class="p">.</span><span class="n">create</span> <span class="nn">Time</span><span class="p">.</span><span class="nn">Span</span><span class="p">.</span><span class="n">of_string</span><span class="o">;;</span>
<span class="k">val</span> <span class="n">time_span</span> <span class="o">:</span> <span class="nn">Core</span><span class="p">.</span><span class="nn">Span</span><span class="p">.</span><span class="n">t</span> <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="nn">Arg_type</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">abstr</span><span class="o">&gt;</span>
<span class="o">#</span> <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span><span class="n">empty</span> <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;span&quot;</span> <span class="o">%:</span> <span class="n">time_span</span><span class="o">));;</span>
<span class="o">-</span> <span class="o">:</span> <span class="o">(</span><span class="nn">Core</span><span class="p">.</span><span class="nn">Span</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="o">_</span><span class="n">a</span><span class="o">,</span> <span class="k">'</span><span class="o">_</span><span class="n">a</span><span class="o">)</span> <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">abstr</span><span class="o">&gt;</span>
</pre></div></aside></section></section><section><h1 id="adding-flags-to-label-the-command-line">Adding flags to label the command line</h1><p id="idp10270624">
      You aren't just limited to anonymous arguments on the
      command-line. A <span><em>flag</em></span> is a named field that
      can be followed by an optional argument. These flags can appear in
      any order on the command-line, or multiple times, depending on how
      they're declared in the specification.
    </p><p id="idp10271760">
      Let's add two arguments to our <code>md5</code> command that
      mimics the Linux version. A <code>-s</code> flag specifies
      the string to be hashed directly on the command-line and a
      <code>-t</code> runs a self-test. The complete example is:
    </p><div class="highlight"><pre><span class="c">(* mlmd5.ml : generate an MD5 hash of the input data *)</span>
<span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">get_file_data</span> <span class="n">file</span> <span class="n">checksum</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">file</span><span class="o">,</span> <span class="n">checksum</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="nc">Some</span> <span class="n">buf</span> <span class="o">-&gt;</span> <span class="n">buf</span>
  <span class="o">|</span> <span class="o">_,</span> <span class="nc">Some</span> <span class="n">buf</span> <span class="o">-&gt;</span> <span class="n">eprintf</span> <span class="s2">&quot;Warning: ignoring file</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span> <span class="n">buf</span>
  <span class="o">|</span> <span class="o">(</span><span class="nc">None</span><span class="o">|</span><span class="nc">Some</span> <span class="s2">&quot;-&quot;</span><span class="o">),</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nn">In_channel</span><span class="p">.</span><span class="err">(</span><span class="n">input_all</span> <span class="n">stdin</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">file</span><span class="o">,</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nn">In_channel</span><span class="p">.</span><span class="n">read_all</span> <span class="n">file</span>

<span class="k">let</span> <span class="n">do_hash</span> <span class="n">file</span> <span class="n">checksum</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">open</span> <span class="nc">Cryptokit</span> <span class="k">in</span>
  <span class="n">get_file_data</span> <span class="n">file</span> <span class="n">checksum</span>
  <span class="o">|&gt;</span> <span class="n">hash_string</span> <span class="o">(</span><span class="nn">Hash</span><span class="p">.</span><span class="n">md5</span> <span class="bp">()</span><span class="o">)</span>
  <span class="o">|&gt;</span> <span class="n">transform_string</span> <span class="o">(</span><span class="nn">Hexa</span><span class="p">.</span><span class="n">encode</span> <span class="bp">()</span><span class="o">)</span>
  <span class="o">|&gt;</span> <span class="n">print_endline</span>

<span class="k">let</span> <span class="n">command</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span>
    <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Generate an MD5 hash of the input data&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">flag</span> <span class="s2">&quot;-s&quot;</span> <span class="o">(</span><span class="n">optional</span> <span class="kt">string</span><span class="o">)</span> <span class="o">~</span><span class="n">doc</span><span class="o">:</span><span class="s2">&quot;string Checksum the given string&quot;</span>
      <span class="o">+&gt;</span> <span class="n">flag</span> <span class="s2">&quot;-t&quot;</span> <span class="n">no_arg</span> <span class="o">~</span><span class="n">doc</span><span class="o">:</span><span class="s2">&quot; run a built-in time trial&quot;</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="n">maybe</span> <span class="o">(</span><span class="s2">&quot;filename&quot;</span> <span class="o">%:</span> <span class="kt">string</span><span class="o">))</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">checksum</span> <span class="n">trial</span> <span class="n">file</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="k">match</span> <span class="n">trial</span> <span class="k">with</span>
    <span class="o">|</span> <span class="bp">true</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;Running time trial</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">|</span> <span class="bp">false</span> <span class="o">-&gt;</span> <span class="n">do_hash</span> <span class="n">file</span> <span class="n">checksum</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="n">run</span> <span class="n">command</span>
</pre></div><p id="idp10277136">
      The specification now uses the <code>flag</code> command.
      The first argument to <code>flag</code> is its name on the
      command-line, and the <code>doc</code> argument supplies the
      help text.
    </p><p id="idp10279824">
      The <code>doc</code> string is formatted so that the first
      word is the short name that appears in the usage text, with the
      remainder being the full help text. Notice that the
      <code>-t</code> flag has no argument, and so we prepend its
      <code>doc</code> text with a blank space. The help text for
      the above code looks like this:
    </p><pre id="idp10282560">
$ ./mlmd5 -help
Generate an MD5 hash of the input data

  ./mlmd5 [filename]

=== flags ===

  [-s string]    Checksum the given string
  [-t]           run a built-in time trial
  [-build-info]  print info about this build and exit
  [-version]     print the version of this build and exit
  [-help]        print this help text and exit
                 (alias: -?)

$ ./mlmd5 -s &quot;ocaml rocks&quot;
5a118fe92ac3b6c7854c595ecf6419cb
</pre><p id="idp10284000">
      The <code>-s</code> flag in our specification requires a
      <code>string</code> argument, and the parser outputs an
      error message if it isn't supplied. Here's a list of some of the
      functions that you can wrap flags in to control how they are
      parsed:
    </p><table><thead><tr><th>
              Flag function
            </th><th>
              OCaml type
            </th></tr></thead><tbody><tr><td>
<code>required</code> <span><em>arg</em></span>
</td><td>
<span><em>arg</em></span> and error if not present
            </td></tr><tr><td>
<code>optional</code> <span><em>arg</em></span>
</td><td>
<span><em>arg</em></span> <code>option</code>
</td></tr><tr><td>
<code>optional_with_default</code>
</td><td>
<span><em>arg</em></span> with a default if not present
            </td></tr><tr><td>
<code>listed</code> <span><em>arg</em></span>
</td><td>
<span><em>arg</em></span> <code>list</code>, flag may
              appear multiple times
            </td></tr><tr><td>
<code>no_arg</code>
</td><td>
<code>bool</code> that is true if flag is present.
            </td></tr></tbody></table><p id="idp10304336">
      The flags affect the type of the callback function in exactly the
      same way as anonymous arguments do. This lets you change the
      specification and ensure that all the callback functions are
      updated appropriately, without runtime errors.
    </p><p id="idp10305008">
      Notice that the <code>get_file_data</code> function now
      pattern matches across the <code>checksum</code> flag and
      the <code>file</code> anonymous argument. It selects the
      flag in preference to the anonymous argument, but emits a warning
      if there's ambiguity and both are specified.
    </p></section><section><h1 id="grouping-sub-commands-together">Grouping sub-commands together</h1><p id="idp10308976">
      You can get pretty far by combining flags and anonymous arguments
      to assemble complex command-line interfaces. After a while though,
      too many options can make the program very confusing for newcomers
      to your application. One way to solve this is by grouping common
      operations together and adding some hierarchy to the command-line
      interface.
    </p><p id="idp10309760">
      You'll have run across this style already when using the OPAM
      package manager (or, in the non-OCaml world, the Git or Mercurial
      commands). OPAM exposes commands in this form:
    </p><pre id="idp10310352">
opam config env
opam remote list -kind git
opam install --help
opam install xmlm
</pre><p id="idp10311104">
      The <code>config</code>, <code>remote</code> and
      <code>install</code> keywords form a logical grouping of
      commands, and factor out flags and arguments that are specific to
      that particular operation. It's really simple to extend your
      application to do this in Command: just swap
      <code>Command.basic</code> for
      <code>Command.group</code>:
    </p><div class="highlight"><pre><span class="k">val</span> <span class="n">group</span> <span class="o">:</span>
  <span class="n">summary</span><span class="o">:</span><span class="kt">string</span> <span class="o">-&gt;</span>
  <span class="o">?</span><span class="n">readme</span><span class="o">:(</span><span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">string</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="o">(</span><span class="kt">string</span> <span class="o">*</span> <span class="n">t</span><span class="o">)</span> <span class="kt">list</span> <span class="o">-&gt;</span> <span class="n">t</span>
</pre></div><p id="idp10316432">
      The <code>group</code> signature accepts a list of basic
      <code>Command.t</code> values and their corresponding names.
      When executed, it looks for the appropriate sub-command from the
      name list, and dispatches it to the right command handler.
    </p><p id="idp10318480">
      Let's build the beginning of a calendar tool that does a few
      operations over dates from the command line. We first define a
      command that adds days to an input date and prints the resulting
      date.
    </p><div class="highlight"><pre><span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">add</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span>
    <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Add [days] to the [base] date and print day&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;base&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;days&quot;</span> <span class="o">%:</span> <span class="kt">int</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">base</span> <span class="n">span</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="nn">Date</span><span class="p">.</span><span class="n">add_days</span> <span class="n">base</span> <span class="n">span</span>
    <span class="o">|&gt;</span> <span class="nn">Date</span><span class="p">.</span><span class="n">to_string</span>
    <span class="o">|&gt;</span> <span class="n">print_endline</span>
  <span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="n">run</span> <span class="n">add</span>
</pre></div><p id="idp10320752">
      Once we've tested this and made sure it works, we can define
      another command that takes the difference of two dates. Both of
      the commands are now grouped as sub-commands using
      <code>Command.group</code>.
    </p><div class="highlight"><pre><span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">add</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span> <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Add [days] to the [base] date&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;base&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;days&quot;</span> <span class="o">%:</span> <span class="kt">int</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">base</span> <span class="n">span</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="nn">Date</span><span class="p">.</span><span class="n">add_days</span> <span class="n">base</span> <span class="n">span</span>
    <span class="o">|&gt;</span> <span class="nn">Date</span><span class="p">.</span><span class="n">to_string</span>
    <span class="o">|&gt;</span> <span class="n">print_endline</span>
  <span class="o">)</span>

<span class="k">let</span> <span class="n">diff</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span> <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Show days between [date1] and [date2]&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;date1&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;date2&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">date1</span> <span class="n">date2</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="nn">Date</span><span class="p">.</span><span class="n">diff</span> <span class="n">date1</span> <span class="n">date2</span>
    <span class="o">|&gt;</span> <span class="n">printf</span> <span class="s2">&quot;%d days</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="o">)</span>

<span class="k">let</span> <span class="n">command</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">group</span> <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Manipulate dates&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;add&quot;</span><span class="o">,</span> <span class="n">add</span><span class="o">;</span> <span class="s2">&quot;diff&quot;</span><span class="o">,</span> <span class="n">diff</span> <span class="o">]</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="n">run</span> <span class="n">command</span>
</pre></div><p id="idp10323712">
      And that's all you need to add sub-command support! The help page
      for our calendar now reflects the two commands we just added:
    </p><pre id="idp10324256">
$ cal
Manipulate dates

  cal SUBCOMMAND

=== subcommands ===

  add      Add [days] to the [base] date
  diff     Show days between [date1] and [date2]
  version  print version information
  help     explain a given subcommand (perhaps recursively)

missing subcommand for command cal
</pre><p id="idp10325216">
      We can invoke the two commands we just defined to verify that they
      work and see the date parsing in action.
    </p><pre id="idp10325744">
$ cal add 2012-12-25 40
2013-02-03
$ cal diff 2012-12-25 2012-11-01
54 days
</pre></section><section><h1 id="advanced-control-over-parsing">Advanced control over parsing</h1><p id="idp10327712">
      The use of the spec combinators has been somewhat magic so far: we
      just build them up with the '+&gt;' combinator and things seem to
      work. As your programs get larger and more complex, you'll want to
      factor out common functionality between specifications. Some other
      times, you'll need to interrupt the parsing to perform special
      processing, such as requesting an interactive passphrase from the
      user before proceeding. We'll show you some new combinators that
      let you do this now.
    </p><section><h1><b>
    The types behind <code>Command.Spec</code>
</b></h1><p id="idp10330768">
      The Command module's safety relies on the specification's output
      values precisely matching the callback function which invokes the
      main program. Any mismatch here will inevitably result in a
      dynamic failure, and so Command uses some interesting type
      abstraction to guarantee they remain in sync. You don't have to
      understand this section to use the more advanced combinators, but
      it'll help you debug type errors as you use
      <code>Command</code> more.
    </p><p id="idp10332368">
      The type of <code>Command.t</code> looks deceptively simple:
    </p><div class="highlight"><pre><span class="k">type</span> <span class="o">(</span><span class="k">'</span><span class="n">main_in</span><span class="o">,</span> <span class="k">'</span><span class="n">main_out</span><span class="o">)</span> <span class="n">t</span>
</pre></div><p id="idp10334496">
      You can think of <code>('a, 'b) t</code> as a function of
      type <code>'a -&gt; 'b</code>, but embellished with
      information about:
    </p><ul><li><p id="idp10336928">
          how to parse the command line
        </p></li><li><p id="idp10337760">
          what the command does and how to call it
        </p></li><li><p id="idp10338608">
          how to auto-complete a partial command line
        </p></li></ul><p id="idp10339328">
      The type of a specification transforms a
      <code>'main_in</code> to a <code>'main_out</code>
      value. For instance, a value of <code>Spec.t</code> might
      have type:
    </p><div class="highlight"><pre><span class="o">(</span><span class="n">arg1</span> <span class="o">-&gt;</span> <span class="o">...</span> <span class="o">-&gt;</span> <span class="n">argN</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">r</span><span class="o">,</span> <span class="k">'</span><span class="n">r</span><span class="o">)</span> <span class="nn">Spec</span><span class="p">.</span><span class="n">t</span>
</pre></div><p id="idp10342960">
      Such a value transforms a main function of type
      <code>arg1 -&gt; ... -&gt; argN -&gt; 'r</code> by supplying
      all the argument values, leaving a main function that returns a
      value of type <code>'r</code>. Let's look at some examples
      of specs, and their types:
    </p><div class="highlight"><pre><span class="o">#</span> <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="n">empty</span> <span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="o">(</span><span class="k">'</span><span class="n">m</span><span class="o">,</span> <span class="k">'</span><span class="n">m</span><span class="o">)</span> <span class="nn">Spec</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">abstr</span><span class="o">&gt;</span>
<span class="o">#</span> <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span><span class="n">empty</span> <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;foo&quot;</span> <span class="o">%:</span> <span class="kt">int</span><span class="o">))</span> <span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="o">(</span><span class="kt">int</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="o">_</span><span class="n">a</span><span class="o">,</span> <span class="k">'</span><span class="o">_</span><span class="n">a</span><span class="o">)</span> <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">abstr</span><span class="o">&gt;</span>
</pre></div><p id="idp10346192">
      The empty specification is simple as it doesn't add any parameters
      to the callback type. The second example adds an
      <code>int</code> anonymous parameter that is reflected in
      the inferred type. One forms a command by combining a spec of type
      <code>('main, unit) Spec.t</code> with a function of type
      <code>'main</code>. The combinators we've shown so far
      incrementally build the type of <code>'main</code> according
      to the command-line parameters it expects, so the resulting type
      of <code>'main</code> is something like
      <code>arg1 -&gt; ... -&gt; argN -&gt; unit</code>.
    </p><p id="idp10351328">
      The type of <code>Command.basic</code> should make more
      sense now:
    </p><div class="highlight"><pre><span class="k">val</span> <span class="n">basic</span> <span class="o">:</span>
  <span class="n">summary</span><span class="o">:</span><span class="kt">string</span> <span class="o">-&gt;</span>
  <span class="o">?</span><span class="n">readme</span><span class="o">:(</span><span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">string</span><span class="o">)</span> <span class="o">-&gt;</span>
  <span class="o">(</span><span class="k">'</span><span class="n">main</span><span class="o">,</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="nn">Spec</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">main</span> <span class="o">-&gt;</span> <span class="n">t</span>
</pre></div><p id="idp10353584">
      The final line is the important one. It shows that the callback
      function for a spec should consume identical arguments to the
      supplied <code>main</code> function, expect for an
      additional <code>unit</code> argument. This final
      <code>unit</code> is there to make sure the callback is
      evaluated as a function, since if zero command-line arguments are
      specified (i.e. <code>Spec.empty</code>), the callback would
      otherwise have no arguments and be evaluated immediately. That's
      why you have to supply an additional <code>()</code> to the
      callback function in all the previous examples.
    </p></section><section><h1 id="composing-specification-fragments-together">Composing specification fragments together</h1><p id="idp10359424">
        If you want to factor out common command-line operations, the
        <code>++</code> operator will append two specifications
        together. Let's add some dummy verbosity and debug flags to our
        calendar application to illustrate this.
      </p><div class="highlight"><pre><span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">add</span> <span class="o">~</span><span class="n">common</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span> <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Add [days] to the [base] date&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;base&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;days&quot;</span> <span class="o">%:</span> <span class="kt">int</span><span class="o">)</span>
      <span class="o">++</span> <span class="n">common</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">base</span> <span class="n">span</span> <span class="n">debug</span> <span class="n">verbose</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="nn">Date</span><span class="p">.</span><span class="n">add_days</span> <span class="n">base</span> <span class="n">span</span>
    <span class="o">|&gt;</span> <span class="nn">Date</span><span class="p">.</span><span class="n">to_string</span>
    <span class="o">|&gt;</span> <span class="n">print_endline</span>
  <span class="o">)</span>

<span class="k">let</span> <span class="n">diff</span> <span class="o">~</span><span class="n">common</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span> <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Show days between [date2] and [date1]&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;date1&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;date2&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">++</span> <span class="n">common</span>
    <span class="o">)</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">date1</span> <span class="n">date2</span> <span class="n">debug</span> <span class="n">verbose</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="nn">Date</span><span class="p">.</span><span class="n">diff</span> <span class="n">date1</span> <span class="n">date2</span>
    <span class="o">|&gt;</span> <span class="n">printf</span> <span class="s2">&quot;%d days</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="o">)</span>
</pre></div><p id="idp10362464">
        The definitions of the specifications are very similar to the
        earlier example, except that they append a
        <code>common</code> parameter after each specification. We
        can supply these flags when defining the groups:
      </p><pre id="idp10363792">
let () =
  let common =
    Command.Spec.(
      empty
      +&gt; flag &quot;-d&quot; (optional_with_default false bool) ~doc:&quot; Debug mode&quot;
      +&gt; flag &quot;-v&quot; (optional_with_default false bool) ~doc:&quot; Verbose output&quot;
    )
  in
  List.map ~f:(fun (name, cmd) -&gt; (name, cmd ~common))
    [ &quot;add&quot;, add; &quot;diff&quot;, diff ]
  |&gt; Command.group ~summary:&quot;Manipulate dates&quot;
  |&gt; Command.run
</pre><p id="idp10365072">
        Both of these flags will now be applied and passed to all the
        callback functions. This makes code refactoring a breeze by
        using the compiler to spot places where you use commands. Just
        add a parameter to the common definition, run the compiler, and
        fix type errors until everything works again.
      </p><p id="idp10365808">
        For example, if we remove the <code>verbose</code> flag
        above and compile, we'll get this impressively long type error:
      </p><div class="highlight"><pre><span class="nc">File</span> <span class="s2">&quot;cal_compose_error.ml&quot;</span><span class="o">,</span> <span class="n">line</span> <span class="mi">39</span><span class="o">,</span> <span class="n">characters</span> <span class="mi">38</span><span class="o">-</span><span class="mi">45</span><span class="o">:</span>
<span class="nc">Error</span><span class="o">:</span> <span class="nc">This</span> <span class="n">expression</span> <span class="n">has</span> <span class="k">type</span>
         <span class="o">(</span><span class="kt">bool</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">,</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span>
         <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span>
           <span class="o">(</span><span class="kt">bool</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">,</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span>
           <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="n">t</span>
       <span class="n">but</span> <span class="n">an</span> <span class="n">expression</span> <span class="n">was</span> <span class="n">expected</span> <span class="k">of</span> <span class="k">type</span>
         <span class="o">(</span><span class="kt">bool</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">,</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="n">t</span>
           <span class="o">=</span> <span class="o">(</span><span class="kt">bool</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">,</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="n">t</span>
       <span class="nc">Type</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="n">is</span> <span class="n">not</span> <span class="n">compatible</span> <span class="k">with</span> <span class="k">type</span> <span class="kt">unit</span>
</pre></div><p id="idp10368752">
        While this does look scary, the key line to scan is the last
        one, where it's telling you that you have supplied too many
        arguments in the callback function
        (<code>unit -&gt; unit</code> vs <code>unit</code>).
        If you started with a working program and made this single
        change, you typically don't even need to read the type error, as
        the filename and location information is sufficient to make the
        obvious fix.
      </p></section><section><h1 id="prompting-for-interactive-input">Prompting for interactive input</h1><p id="idp10372224">
        The <code>step</code> combinator lets you control the
        normal course of parsing by supplying a function that maps
        callback arguments to a new set of values. For instance, let's
        revisit our first calendar application that added a number of
        days onto a supplied base date.
      </p><div class="highlight"><pre><span class="c">(* cal_add.ml *)</span>
<span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">add_days</span> <span class="n">base</span> <span class="n">span</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Date</span><span class="p">.</span><span class="n">add_days</span> <span class="n">base</span> <span class="n">span</span>
  <span class="o">|&gt;</span> <span class="nn">Date</span><span class="p">.</span><span class="n">to_string</span>
  <span class="o">|&gt;</span> <span class="n">print_endline</span>

<span class="k">let</span> <span class="n">add</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span>
    <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Add [days] to the [base] date and print day&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span>
      <span class="n">empty</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;base&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;days&quot;</span> <span class="o">%:</span> <span class="kt">int</span><span class="o">)</span>
    <span class="o">)</span>
    <span class="n">add_days</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="n">run</span> <span class="n">add</span>
</pre></div><p id="idp10375024">
        This <code>cal_add</code> program requires you to specify
        both the <code>base</code> date and the number of
        <code>days</code> to add onto it. If
        <code>days</code> isn't supplied on the command-line, an
        error is output. Now let's modify it to interactively prompt for
        a number of days if only the <code>base</code> date is
        supplied.
      </p><div class="highlight"><pre><span class="c">(* cal_add_interactive.ml *)</span>
<span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">add_days</span> <span class="n">base</span> <span class="n">span</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Date</span><span class="p">.</span><span class="n">add_days</span> <span class="n">base</span> <span class="n">span</span>
  <span class="o">|&gt;</span> <span class="nn">Date</span><span class="p">.</span><span class="n">to_string</span>
  <span class="o">|&gt;</span> <span class="n">print_endline</span>

<span class="k">let</span> <span class="n">add</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span>
    <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Add [days] to the [base] date and print day&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span> 
      <span class="n">step</span> 
        <span class="o">(</span><span class="k">fun</span> <span class="n">m</span> <span class="n">base</span> <span class="n">days</span> <span class="o">-&gt;</span>
           <span class="k">match</span> <span class="n">days</span> <span class="k">with</span>
           <span class="o">|</span> <span class="nc">Some</span> <span class="n">days</span> <span class="o">-&gt;</span>
             <span class="n">m</span> <span class="n">base</span> <span class="n">days</span>
           <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
             <span class="n">print_endline</span> <span class="s2">&quot;enter days: &quot;</span><span class="o">;</span>
             <span class="n">read_int</span> <span class="bp">()</span>
             <span class="o">|&gt;</span> <span class="n">m</span> <span class="n">base</span>
        <span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;base&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="n">maybe</span> <span class="o">(</span><span class="s2">&quot;days&quot;</span> <span class="o">%:</span> <span class="kt">int</span><span class="o">))</span>
    <span class="o">)</span>
    <span class="n">add_days</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="n">run</span> <span class="n">add</span>
</pre></div><p id="idp10381200">
        The <code>days</code> anonymous argument is now an
        optional integer in the spec, and we want to transform it into a
        non-optional value before calling our
        <code>add_days</code> callback. The
        <code>step</code> combinator in the specification performs
        this transformation. It applies its supplied callback function
        first, which checks if <code>day</code> is defined. If
        it's undefined, then it interactively reads an integer from the
        standard input. The first <code>m</code> argument to the
        <code>step</code> callback is the next callback function
        in the chain. The transformation is completed by calling
        <code>m base days</code> to continue processing with the
        new values we've just calculated. The <code>days</code>
        value that is passed onto the next callback now has a
        non-optional <code>int</code> type.
      </p><pre id="idp10388672">
$ cal_add_interactive 2013-12-01
enter days:
35
2014-01-05
</pre><p id="idp10389408">
        The transformation means that the <code>add_days</code>
        callback can just keep its original definition of
        <code>Date.t -&gt; int -&gt; unit</code>. The
        <code>step</code> function transformed the
        <code>int option</code> argument from the parsing into an
        <code>int</code> suitable for <code>add_days</code>.
        This transformation is explicitly represented in the type of the
        <code>step</code> return value:
      </p><div class="highlight"><pre><span class="o">#</span> <span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span> <span class="o">;;</span>
<span class="o">#</span> <span class="k">open</span> <span class="nn">Command</span><span class="p">.</span><span class="nc">Spec</span> <span class="o">;;</span>
<span class="o">#</span> <span class="n">step</span> <span class="o">(</span><span class="k">fun</span> <span class="n">m</span> <span class="o">(</span><span class="n">base</span><span class="o">:</span><span class="nn">Date</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="n">days</span> <span class="o">-&gt;</span>
  <span class="k">match</span> <span class="n">days</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">days</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="n">base</span> <span class="n">days</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
     <span class="n">print_endline</span> <span class="s2">&quot;enter days: &quot;</span><span class="o">;</span>
     <span class="n">m</span> <span class="n">base</span> <span class="o">(</span><span class="n">read_int</span> <span class="bp">()</span><span class="o">));;</span>
<span class="o">-</span> <span class="o">:</span> <span class="o">(</span><span class="nn">Date</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="o">_</span><span class="n">a</span><span class="o">,</span> <span class="nn">Date</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="o">_</span><span class="n">a</span><span class="o">)</span> <span class="nn">Spec</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">abstr</span><span class="o">&gt;</span>
</pre></div><p id="idp10396320">
        The first half of the <code>Spec.t</code> shows that the
        callback type is <code>Date.t -&gt; int</code>, whereas
        the resulting value expected from the next specification in the
        chain is a <code>Date.t -&gt; int option</code>.
      </p></section><section><h1 id="adding-labelled-arguments-to-callbacks">Adding labelled arguments to callbacks</h1><p id="idp10400400">
        The <code>step</code> chaining lets you control the types
        of your callbacks very easily. This can help you match existing
        interfaces or make things more explicit by adding labelled
        arguments.
      </p><div class="highlight"><pre><span class="c">(* cal_add_labels.ml *)</span>
<span class="k">open</span> <span class="nn">Core</span><span class="p">.</span><span class="nc">Std</span>

<span class="k">let</span> <span class="n">add_days</span> <span class="o">~</span><span class="n">base_date</span> <span class="o">~</span><span class="n">num_days</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Date</span><span class="p">.</span><span class="n">add_days</span> <span class="n">base_date</span> <span class="n">num_days</span>
  <span class="o">|&gt;</span> <span class="nn">Date</span><span class="p">.</span><span class="n">to_string</span>
  <span class="o">|&gt;</span> <span class="n">print_endline</span>

<span class="k">let</span> <span class="n">add</span> <span class="o">=</span>
  <span class="nn">Command</span><span class="p">.</span><span class="n">basic</span>
    <span class="o">~</span><span class="n">summary</span><span class="o">:</span><span class="s2">&quot;Add [days] to the [base] date and print day&quot;</span>
    <span class="nn">Command</span><span class="p">.</span><span class="nn">Spec</span><span class="p">.</span><span class="err">(</span> 
      <span class="n">step</span> <span class="o">(</span><span class="k">fun</span> <span class="n">m</span> <span class="n">base</span> <span class="n">days</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="o">~</span><span class="n">base_date</span><span class="o">:</span><span class="n">base</span> <span class="o">~</span><span class="n">num_days</span><span class="o">:</span><span class="n">days</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;base&quot;</span> <span class="o">%:</span> <span class="n">date</span><span class="o">)</span>
      <span class="o">+&gt;</span> <span class="n">anon</span> <span class="o">(</span><span class="s2">&quot;days&quot;</span> <span class="o">%:</span> <span class="kt">int</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="n">add_days</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Command</span><span class="p">.</span><span class="n">run</span> <span class="n">add</span>
</pre></div><p id="idp10403152">
        This <code>cal_add_labels</code> example goes back to our
        non-interactive calendar addition program, but the
        <code>add_days</code> main function now expects labelled
        arguments. The <code>step</code> function in the
        specification simply converts the default
        <code>base</code> and <code>days</code> arguments
        into a labelled function, and everything compiles again.
      </p><p id="idp10407424">
        Labelled arguments are more verbose, but also help prevent
        errors with command-line arguments with similar types but
        different names and purposes. It's good form to use them when
        you have a lot of otherwise anonymous <code>int</code> and
        <code>string</code> arguments.
      </p></section></section><section><h1 id="command-line-auto-completion-with-bash">Command-line auto-completion with
    <code>bash</code></h1><p id="idp10411392">
      Modern UNIX shells usually have a tab-completion feature to
      interactively help you figure out how to build a command-line.
      These work by pressing the <code>&lt;tab&gt;</code> key in
      the middle of typing a command, and seeing the options that pop
      up. You've probably used this most often to find the files in the
      current directory, but it can actually be extended for other parts
      of the command too.
    </p><p id="idp10412928">
      The precise mechanism for autocompletion varies depending on what
      shell you are using, but we'll assume you are using the most
      common one: <code>bash</code>. This is the default
      interactive shell on most Linux distributions and Mac OS X, but
      you may need to switch to it on *BSD or Windows (when using
      Cygwin). The rest of this section assumes that you're using
      <code>bash</code>.
    </p><p id="idp10415136">
      Bash autocompletion isn't always installed by default, so check
      your OS package manager to see if you have it available.
    </p><table><thead><tr><th>
              Operating System
            </th><th>
              Package Manager
            </th><th>
              Package
            </th></tr></thead><tbody><tr><td>
              Debian Linux
            </td><td>
<code>apt</code>
</td><td>
<code>bash-completion</code>
</td></tr><tr><td>
              Mac OS X
            </td><td>
              Homebrew
            </td><td>
<code>bash-completion</code>
</td></tr><tr><td>
              FreeBSD
            </td><td>
              Ports System
            </td><td>
<code>/usr/ports/shells/bash-completion</code>
</td></tr></tbody></table><p id="idp10428416">
      Once bash completion is installed and configured, check that it
      works by typing the <code>ssh</code> command, and pressing
      <code>&lt;tab&gt;</code>. This should show you the list of
      known hosts from your <code>~/.ssh/known_hosts</code> file.
      If it lists some hosts that you've recently connected to, you can
      continue on. If it lists the files in your current directory
      instead, then check your OS documentation to configure completion
      correctly.
    </p><p id="idp10431376">
      One last bit of information you'll need to find is the location of
      the <code>bash_completion.d</code> directory. This is where
      all the shell fragments that contain the completion logic are
      held. On Linux, this is often in
      <code>/etc/bash_completion.d</code>, and in Homebrew on Mac
      OS X it would be
      <code>/usr/local/etc/bash_completion.d</code> by default.
    </p><section><h1 id="generating-completion-fragments-from-command">Generating completion fragments from Command</h1><p id="idp10435376">
        The Command library has a declarative description of all the
        possible valid options, and it can use this information to
        generate a shell script which provides completion support for
        that command. To generate the fragment, just run the command
        with the <code>COMMAND_OUTPUT_INSTALLATION_BASH</code>
        environment variable set to any value.
      </p><p id="idp10436832">
        For example, let's try it on our calendar example from earlier,
        assuming that the binary is called <code>cal</code> in the
        current directory:
      </p><pre id="idp10438112">
$ COMMAND_OUTPUT_INSTALLATION_BASH=1 ./cal

function _jsautocom_41790 {
  export COMP_CWORD
  COMP_WORDS[0]=./cal
  COMPREPLY=($(&quot;${COMP_WORDS[@]}&quot;))
}
complete -F _jsautocom_41790 ./cal
</pre></section><section><h1 id="installing-the-completion-fragment">Installing the completion fragment</h1><p id="idp10440256">
        You don't need to worry about what this script actually does
        (unless you have an unhealthy fascination with shell scripting,
        that is). Instead, redirect the output to a file in your
        <code>bash_completion.d</code> directory, named after the
        command you're installing.
      </p><pre id="idp10441632">
$ sudo env COMMAND_OUTPUT_INSTALLATION_BASH=1 ./cal \
    &gt; /etc/bash_completion.d/cal
$ bash -l
$ ./cal &lt;tab&gt;
add      diff     help     version
</pre><p id="idp10442624">
        The first line above redirects the earlier output into your
        <code>bash_completion.d</code> directory. The
        <code>bash -l</code> loads the new configuration as a
        fresh login shell, and then the final line shows the four valid
        commands by pressing the tab key.
      </p><p id="idp10444704">
        Command completion support works for flags and grouped commands,
        and is very useful when building larger command-line interfaces.
      </p><aside class="note"><h1>
      Installing a generic completion handler
      </h1><p id="idp10445968">
        Sadly, <code>bash</code> doesn't support installing a
        generic handler for all Command-based applications. This means
        that you have to install the completion script for every
        application, but you should be able to automate this in the
        build and packaging system for your application.
      </p><p id="idp10447392">
        It will help to check out how other applications that install
        tab-completion scripts and following their lead, as the details
        are very OS-specific.
      </p></aside></section></section>


                
            </article>
            
            
    
                <nav class="pagination">
                    
                        <a rel="previous" href="maps-and-hashtables.html">
                            &lt; Previous
                        </a>
                    
                    
                        <a rel="next" href="handling-json-data.html">
                            Next &gt;
                        </a>
                    
                </nav>
            
            
            
            <footer class="footer">
                <p>Copyright 2012-2013, Jason Hickey, Anil Madhavapeddy and Yaron Minsky. Licensed under <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/us/">CC BY-NC-ND 3.0 US</a>.</p>
            </footer>
            
        </div>
    
    </body>

</html>